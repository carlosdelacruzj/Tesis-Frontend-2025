<div class="dashboard-content">
  <app-list-toolbar
    [title]="'Pagos'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: cliente, código'"
    [searchValue]="searchTerm"
    [showCreateButton]="false"
    (searchChange)="onSearch($event)"
  >
  </app-list-toolbar>

  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="btn-group" role="group" aria-label="Tabs pagos">
      @for (tab of tabs; track tab.key) {
        <button
          type="button"
          class="btn btn-primary btn-sm"
          [class.active]="selectedTab === tab.key"
          (click)="onTabChange(tab.key)"
        >
          {{ tab.label }}
        </button>
      }
    </div>
    <button
      type="button"
      class="btn btn-link btn-sm text-decoration-none"
      (click)="onRefresh()"
    >
      <i class="fa-solid fa-arrow-rotate-right"></i> Actualizar
    </button>
    <!-- <button type="button" class="btn btn-link btn-sm text-decoration-none" (click)="toggleEstadoLegend()">
      <mat-icon class="align-middle">help_outline</mat-icon>
      {{ showEstadoLegend ? 'Ocultar estados' : 'Que significa cada estado' }}
    </button> -->
  </div>
  @if (showEstadoLegend) {
  <div class="alert alert-light border mb-3 py-2 px-3" role="note">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <small class="text-muted">Estados de pago:</small>
      <app-estado-badge [estado]="'Pendiente'" [mapaColores]="{ 'Pendiente': 'info' }"></app-estado-badge>
      <small class="text-muted">sin abonos</small>
      <app-estado-badge [estado]="'Parcial'" [mapaColores]="{ 'Parcial': 'warning' }"></app-estado-badge>
      <small class="text-muted">abono parcial</small>
      <app-estado-badge [estado]="'Pagado'" [mapaColores]="{ 'Pagado': 'success-light' }"></app-estado-badge>
      <small class="text-muted">sin saldo pendiente</small>
      <span
        [matTooltip]="'Caso financiero finalizado: incluye nota de credito, devolucion o cierre administrativo.'"
      >
        <app-estado-badge [estado]="'Cerrado'" [mapaColores]="{ 'Cerrado': 'success' }"></app-estado-badge>
      </span>
    </div>
  </div>
  }

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (loading) {
    <div class="d-flex align-items-center gap-2 text-muted mb-3">
      <mat-spinner diameter="28"></mat-spinner>
      <span>Cargando pagos...</span>
    </div>
  }

  <app-table-base
    [columns]="columns"
    [data]="visibleRows"
    [pageSizeOptions]="[10, 25, 50]"
    [pageSize]="10"
    emptyText="Sin resultados"
    [showCreateButton]="false"
    [showSearch]="false"
    (sortChange)="(null)"
    (pageChange)="(null)"
  >
    <ng-template appCell="cliente" let-row>
      <div class="d-flex flex-column">
        <span class="fw-semibold">{{ row.cliente || "--" }}</span>
        <small class="text-muted">Código: {{ row.codigo }}</small>
      </div>
    </ng-template>

    <ng-template appCell="fecha" let-row>
      <span>{{ row.fecha ? (row.fecha | date: "dd-MM-yyyy") : "--" }}</span>
    </ng-template>

    <ng-template appCell="estado" let-row>
      <span
        [matTooltip]="getEstadoPagoTooltip(row)"
        [matTooltipDisabled]="!isEstadoPagoCerrado(row)"
      >
        <app-estado-badge
          [estado]="getEstadoPagoLabel(row)"
          [mapaColores]="{
            Pendiente: 'info',
            Parcial: 'warning',
            Pagado: 'success-light',
            Cerrado: 'success',
          }"
        ></app-estado-badge>
      </span>
    </ng-template>

    <ng-template appCell="acciones" let-row>
      <div class="d-flex justify-content-center gap-1">
        @if (isPagado(row)) {
          <button
            mat-icon-button color="primary"
            type="button"
            matTooltip="Ver pagos"
            (click)="abrirGestionPago(row)"
          >
            <mat-icon>receipt_long</mat-icon>
          </button>
        } @else {
          <button
            mat-icon-button color="primary"
            type="button"
            matTooltip="Gestionar pago"
            (click)="abrirGestionPago(row)"
          >
            <mat-icon>request_quote</mat-icon>
          </button>
        }
      </div>
    </ng-template>
  </app-table-base>
</div>

<app-modal-base
  [open]="modal.open"
  [useDefaultFooter]="false"
  [disableClose]="modal.guardando"
  [title]="modal.pagadoCompleto ? modalSettlementTitle : 'Registrar pago'"
  size="md"
  (closed)="cerrarGestionPago()"
>
  @if (modal.loading) {
    <div class="d-flex align-items-center gap-2 text-muted">
      <mat-spinner diameter="28"></mat-spinner>
      <span>Cargando detalle...</span>
    </div>
  }

  @if (!modal.loading) {
    @if (modal.error) {
      <div class="alert alert-danger" role="alert">
        {{ modal.error }}
      </div>
    }

      @if (modal.resumen) {
        <div class="summary-card">
          <div class="summary-overview">
            <div class="overview-item overview-item--status">
              <div class="summary-label">Estado financiero</div>
              <div class="summary-value">{{ modal.financialStatus?.label || 'Pendiente' }}</div>
            </div>
            <div class="overview-item overview-item--highlight">
              <div class="summary-label">Saldo pendiente</div>
              <div class="summary-value">{{ saldoPendienteTexto }}</div>
            </div>
            <div class="overview-item">
              <div class="summary-label">Total pactado</div>
              <div class="summary-value">{{ (modal.resumen?.CostoTotal ?? 0) | usd:'1.2-2' }}</div>
            </div>
          </div>
          <p class="summary-help mb-0">
            Vista rápida: estado actual, saldo pendiente y total pactado.
          </p>
          <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-link btn-sm p-0" (click)="toggleFinancialDetails()">
              {{ showFinancialDetails ? 'Ocultar desglose financiero' : 'Ver desglose financiero' }}
            </button>
          </div>
          @if (showFinancialDetails) {
            <div class="summary-detail-list mt-2">
              <div class="summary-detail-row">
                <span>Total</span>
                <strong>{{ (modal.resumen?.CostoTotal || 0) | usd:'1.2-2' }}</strong>
              </div>
              <div class="summary-detail-row">
                <span>Abonado</span>
                <strong>{{ (modal.resumen?.MontoAbonado || 0) | usd:'1.2-2' }}</strong>
              </div>
              @if (hasMontoPorDevolver) {
                <div class="summary-detail-row">
                  <span>Monto por devolver</span>
                  <strong>{{ modal.resumen?.MontoPorDevolver | usd:'1.2-2' }}</strong>
                </div>
              }
              @if (hasSaldoNoCobrable) {
                <div class="summary-detail-row">
                  <span>Saldo no cobrable (informativo)</span>
                  <strong>{{ modal.resumen?.SaldoNoCobrable | usd:'1.2-2' }}</strong>
                </div>
              }
            </div>
          }
        </div>
      }

    @if (modal.pagadoCompleto) {
      <div class="paid-banner">
        <div class="paid-banner__icon">OK</div>
        <div>
          <div class="paid-banner__title">{{ modalSettlementTitle }}</div>
          <div class="paid-banner__subtitle">{{ modalSettlementSubtitle }}</div>
          @if (selectedTab !== settledTargetTabLabel) {
            <button
              class="btn btn-link btn-sm ps-0"
              type="button"
              (click)="irAEstadoLiquidado()"
            >
              Ver en {{ settledTargetTabLabel }}
            </button>
          }
        </div>
      </div>
    }

    @if (modal.resumen && modal.allowRegistro) {
      <form id="registrarPagoForm" class="row g-4" (ngSubmit)="registrarPago()">
        <div class="col-12">
          @if (modal.faltanteDeposito > 0) {
            <div class="alert alert-warning" role="status">
              Debes registrar al menos {{ modal.faltanteDeposito | usd:'1.2-2' }} para cumplir con el 50% del pedido.
            </div>
          }
        </div>

        <div class="col-12">
          <label class="form-label">Selecciona el monto a pagar</label>
          <div class="payment-options payment-options-2">
            <input
              class="btn-check"
              type="radio"
              name="opcionPago"
              id="opcionPago50"
              [value]="'50'"
              [(ngModel)]="modal.opcionPago"
              (ngModelChange)="onOpcionPagoChange($event)"
              [disabled]="!opcionPago50Disponible"
              [checked]="modal.opcionPago === '50' && opcionPago50Disponible"
              required
            />
            <label class="payment-option" for="opcionPago50" [class.is-disabled]="!opcionPago50Disponible">
              <div class="payment-option__body">
                <div class="payment-title">Pagar 50% del total</div>
                @if (!opcionPago50Disponible) {
                  <div class="payment-sub">Ya completado</div>
                } @else {
                  <div class="payment-sub">Pago inicial recomendado</div>
                }
                @if (!opcionPago50Disponible) {
                  <div class="payment-badge">No disponible</div>
                }
              </div>
              <div class="payment-amount">
                @if (modal.opcionPago === '50' && opcionPago50Disponible) {
                  <span class="payment-selected">Seleccionado</span>
                }
                {{ opcionPago50Texto }}
              </div>
            </label>

            <input
              class="btn-check"
              type="radio"
              name="opcionPago"
              id="opcionPago100"
              [value]="'100'"
              [(ngModel)]="modal.opcionPago"
              (ngModelChange)="onOpcionPagoChange($event)"
              [disabled]="!opcionPago100Disponible"
              [checked]="modal.opcionPago === '100' && opcionPago100Disponible"
              required
            />
            <label class="payment-option" for="opcionPago100" [class.is-disabled]="!opcionPago100Disponible">
              <div class="payment-option__body">
                <div class="payment-title">Pagar 100% del saldo restante</div>
                <div class="payment-sub">Pago del saldo</div>
                @if (!opcionPago100Disponible) {
                  <div class="payment-badge">No disponible</div>
                }
              </div>
              <div class="payment-amount">
                @if (modal.opcionPago === '100' && opcionPago100Disponible) {
                  <span class="payment-selected">Seleccionado</span>
                }
                {{ opcionPago100Texto }}
              </div>
            </label>
          </div>

          @if (modal.montoError) {
            <div class="text-danger small mt-2">{{ modal.montoError }}</div>
          }
          <div class="payment-hint">Se registrara {{ montoSeleccionadoTexto }}. Saldo disponible {{ saldoPendienteTexto }}</div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="metodoPagoSelect"
            >Método de pago</label
          >
          <select
            id="metodoPagoSelect"
            name="metodoPagoSelect"
            class="form-select"
            required
            [(ngModel)]="modal.metodoId"
            (ngModelChange)="onMetodoPagoChange($event)"
          >
            <option [ngValue]="null" disabled>Selecciona un metodo</option>
            @for (metodo of modal.metodos; track metodo.idMetodoPago) {
              <option [ngValue]="metodo.idMetodoPago">
                {{ metodo.nombre }}
              </option>
            }
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="fechaPago">Fecha del pago</label>
          <input
            id="fechaPago"
            name="fechaPago"
            type="date"
            class="form-control"
            [(ngModel)]="modal.fecha"
            [min]="modal.fechaMin"
          />
        </div>

        @if (esTransferenciaSeleccionada()) {
          <div class="col-12">
            <label class="form-label" for="voucherPago"
              >Comprobante (obligatorio)</label
            >
            <input
              id="voucherPago"
              type="file"
              class="form-control"
              accept="image/png,image/jpeg,application/pdf"
              required
              (change)="onFileSelected($event)"
            />
            @if (modal.fileName) {
              <div class="mt-2 d-flex align-items-center gap-2">
                <mat-icon class="text-muted">attach_file</mat-icon>
                <span class="text-truncate">{{ modal.fileName }}</span>
                <button
                  type="button"
                  class="btn btn-link btn-sm text-danger p-0"
                  (click)="limpiarArchivo()"
                >
                  Quitar
                </button>
              </div>
            }
          </div>
        }
      </form>
    }

    <div class="mt-3 history-section">
      <h6 class="mb-2">Historial de pagos</h6>
      @if (!modal.vouchers.length) {
        <div class="text-muted">Sin vouchers registrados.</div>
      }
      <div class="list-group">
        @for (v of modal.vouchers; track v.Codigo) {
          <div class="list-group-item d-flex justify-content-between align-items-center voucher-item">
            <div>
              <div class="fw-semibold">{{ v.Fecha | date:'dd-MM-yyyy' }} · {{ v.MetodoPago }}</div>
              <div class="text-muted">Monto: {{ v.Monto | usd:'1.2-2' }}</div>
            </div>
            <div class="d-flex align-items-center gap-2 voucher-actions">
              @if (puedeVerVoucher(v)) {
                <a class="btn btn-link btn-sm" [href]="v.Link" target="_blank" rel="noopener">Ver voucher</a>
              }
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                (click)="descargarComprobanteDesdeLista(v.Codigo)"
              >
                Descargar comprobante
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <div modal-footer class="d-flex justify-content-end gap-2">
    @if (modal.allowRegistro) {
      <button
        class="btn btn-outline-danger btn-sm"
        type="button"
        (click)="cerrarGestionPago()"
        [disabled]="modal.guardando"
      >
        Cancelar
      </button>
      <button
        class="btn btn-primary btn-sm"
        type="submit"
        form="registrarPagoForm"
        [disabled]="!puedeRegistrar"
      >
        Registrar pago
      </button>
    } @else {
      <button
        class="btn btn-outline-secondary btn-sm"
        type="button"
        (click)="cerrarGestionPago()"
        [disabled]="modal.guardando"
      >
        Cerrar
      </button>
    }
  </div>
</app-modal-base>
