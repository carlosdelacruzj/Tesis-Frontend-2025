<div class="dashboard-content">
  <app-list-toolbar
    [title]="'Pagos'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: cliente, código'"
    [searchValue]="searchTerm"
    [showCreateButton]="false"
    (searchChange)="onSearch($event)"
  >
  </app-list-toolbar>

  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="btn-group" role="group" aria-label="Tabs pagos">
      @for (tab of tabs; track tab.key) {
        <button
          type="button"
          class="btn btn-primary"
          [class.active]="selectedTab === tab.key"
          (click)="onTabChange(tab.key)"
        >
          {{ tab.label }}
        </button>
      }
    </div>
    <button type="button" class="btn btn-link btn-sm text-decoration-none" (click)="onRefresh()">
      <mat-icon class="align-middle">refresh</mat-icon> Actualizar
    </button>
  </div>

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (loading) {
    <div class="d-flex align-items-center gap-2 text-muted mb-3">
      <mat-spinner diameter="28"></mat-spinner>
      <span>Cargando pagos...</span>
    </div>
  }

  <app-table-base
    [columns]="columns"
    [data]="visibleRows"
    [pageSizeOptions]="[10, 25, 50]"
    [pageSize]="10"
    emptyText="Sin resultados"
    [showCreateButton]="false"
    [showSearch]="false"
    (sortChange)="null"
    (pageChange)="null"
  >
    <ng-template appCell="cliente" let-row>
      <div class="d-flex flex-column">
        <span class="fw-semibold">{{ row.cliente || '--' }}</span>
        <small class="text-muted">Código: {{ row.codigo }}</small>
      </div>
    </ng-template>

    <ng-template appCell="fecha" let-row>
      <span>{{ row.fecha ? (row.fecha | date:'dd-MM-yyyy') : '--' }}</span>
    </ng-template>

    <ng-template appCell="estado" let-row>
      <app-estado-badge [estado]="row.estado || 'Sin estado'"
      [mapaColores]="{
            'Pendiente': 'info',
            'Parcial': 'warning',
            'Pagado': 'success-light'
          }"></app-estado-badge>
    </ng-template>

    <ng-template appCell="acciones" let-row>
      <div class="d-flex justify-content-center gap-1">
        @if (isPagado(row)) {
          <button mat-icon-button color="primary" type="button" matTooltip="Ver pagos" (click)="abrirGestionPago(row)">
            <mat-icon>receipt_long</mat-icon>
          </button>
        } @else {
          <button mat-icon-button color="accent" type="button" matTooltip="Gestionar pago" (click)="abrirGestionPago(row)">
            <mat-icon>request_quote</mat-icon>
          </button>
        }
      </div>
    </ng-template>
  </app-table-base>
</div>

<app-modal-base
  [open]="modal.open"
  [useDefaultFooter]="false"
  [disableClose]="modal.guardando"
  [title]="modal.pagadoCompleto ? 'Pago completado' : 'Registrar pago'"
  size="md"
  (closed)="cerrarGestionPago()"
>
  @if (modal.loading) {
    <div class="d-flex align-items-center gap-2 text-muted">
      <mat-spinner diameter="28"></mat-spinner>
      <span>Cargando detalle...</span>
    </div>
  }

  @if (!modal.loading) {
    @if (modal.error) {
      <div class="alert alert-danger" role="alert">
        {{ modal.error }}
      </div>
    }

      @if (modal.resumen) {
        <div class="summary-card">
          <div class="summary-grid" [class.summary-grid-3]="modal.pagadoCompleto">
            <div class="summary-item">
              <div class="summary-label">Subtotal</div>
              <div class="summary-value">{{ (modal.resumen?.CostoBase || 0) | usd:'1.2-2' }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">IGV</div>
              <div class="summary-value">{{ (modal.resumen?.Igv || 0) | usd:'1.2-2' }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total</div>
              <div class="summary-value">{{ (modal.resumen?.CostoTotal || 0) | usd:'1.2-2' }}</div>
            </div>
            @if (!modal.pagadoCompleto) {
              <div class="summary-item">
                <div class="summary-label">Abonado</div>
                <div class="summary-value">{{ (modal.resumen?.MontoAbonado || 0) | usd:'1.2-2' }}</div>
              </div>
              <div class="summary-item summary-highlight">
                <div class="summary-label">Saldo pendiente</div>
                <div class="summary-value">{{ saldoPendienteTexto }}</div>
              </div>
            }
          </div>
        </div>
      }

    @if (modal.pagadoCompleto) {
      <div class="paid-banner">
        <div class="paid-banner__icon">OK</div>
        <div>
          <div class="paid-banner__title">Pago completado</div>
          <div class="paid-banner__subtitle">El saldo esta en 0 y no quedan pagos pendientes.</div>
          @if (selectedTab !== 'pagados') {
            <button
              class="btn btn-link btn-sm ps-0"
              type="button"
              (click)="irAPagados()"
            >
              Ver en pagados
            </button>
          }
        </div>
      </div>
    }

    @if (modal.resumen && modal.allowRegistro) {
      <form id="registrarPagoForm" class="row g-4" (ngSubmit)="registrarPago()">
        <div class="col-12">
          @if (modal.faltanteDeposito > 0) {
            <div class="alert alert-warning" role="status">
              Debes registrar al menos {{ modal.faltanteDeposito | usd:'1.2-2' }} para cumplir con el 50% del pedido.
            </div>
          }
        </div>

        <div class="col-12">
          <label class="form-label">Selecciona el monto a pagar</label>
          <div class="payment-options payment-options-2">
            <input
              class="btn-check"
              type="radio"
              name="opcionPago"
              id="opcionPago50"
              [value]="'50'"
              [(ngModel)]="modal.opcionPago"
              (ngModelChange)="onOpcionPagoChange($event)"
              [disabled]="!opcionPago50Disponible"
              [checked]="modal.opcionPago === '50' && opcionPago50Disponible"
              required
            />
            <label class="payment-option" for="opcionPago50" [class.is-disabled]="!opcionPago50Disponible">
              <div class="payment-option__body">
                <div class="payment-title">Pagar 50% del total</div>
                @if (!opcionPago50Disponible) {
                  <div class="payment-sub">Ya completado</div>
                } @else {
                  <div class="payment-sub">Pago inicial recomendado</div>
                }
                @if (!opcionPago50Disponible) {
                  <div class="payment-badge">No disponible</div>
                }
              </div>
              <div class="payment-amount">
                @if (modal.opcionPago === '50' && opcionPago50Disponible) {
                  <span class="payment-selected">Seleccionado</span>
                }
                {{ opcionPago50Texto }}
              </div>
            </label>

            <input
              class="btn-check"
              type="radio"
              name="opcionPago"
              id="opcionPago100"
              [value]="'100'"
              [(ngModel)]="modal.opcionPago"
              (ngModelChange)="onOpcionPagoChange($event)"
              [disabled]="!opcionPago100Disponible"
              [checked]="modal.opcionPago === '100' && opcionPago100Disponible"
              required
            />
            <label class="payment-option" for="opcionPago100" [class.is-disabled]="!opcionPago100Disponible">
              <div class="payment-option__body">
                <div class="payment-title">Pagar 100% del saldo restante</div>
                <div class="payment-sub">Pago completo</div>
                @if (!opcionPago100Disponible) {
                  <div class="payment-badge">No disponible</div>
                }
              </div>
              <div class="payment-amount">
                @if (modal.opcionPago === '100' && opcionPago100Disponible) {
                  <span class="payment-selected">Seleccionado</span>
                }
                {{ opcionPago100Texto }}
              </div>
            </label>
          </div>

          @if (modal.montoError) {
            <div class="text-danger small mt-2">{{ modal.montoError }}</div>
          }
          <div class="payment-hint">Se registrara {{ montoSeleccionadoTexto }}. Saldo disponible {{ saldoPendienteTexto }}</div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="metodoPagoSelect">Metodo de pago</label>
          <select
            id="metodoPagoSelect"
            name="metodoPagoSelect"
            class="form-select"
            required
            [(ngModel)]="modal.metodoId"
            (ngModelChange)="onMetodoPagoChange($event)"
          >
            <option [ngValue]="null" disabled>Selecciona un metodo</option>
            @for (metodo of modal.metodos; track metodo.idMetodoPago) {
              <option [ngValue]="metodo.idMetodoPago">
                {{ metodo.nombre }}
              </option>
            }
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="fechaPago">Fecha del pago</label>
          <input
            id="fechaPago"
            name="fechaPago"
            type="date"
            class="form-control"
            [(ngModel)]="modal.fecha"
            [min]="modal.fechaMin"
          />
        </div>

        @if (esTransferenciaSeleccionada()) {
          <div class="col-12">
            <label class="form-label" for="voucherPago">Comprobante (obligatorio)</label>
            <input
              id="voucherPago"
              type="file"
              class="form-control"
              accept="image/png,image/jpeg,application/pdf"
              required
              (change)="onFileSelected($event)"
            />
            @if (modal.fileName) {
              <div class="mt-2 d-flex align-items-center gap-2">
                <mat-icon class="text-muted">attach_file</mat-icon>
                <span class="text-truncate">{{ modal.fileName }}</span>
                <button type="button" class="btn btn-link btn-sm p-0" (click)="limpiarArchivo()">Quitar</button>
              </div>
            }
          </div>
        }

      </form>
    }

    <div class="mt-3 history-section">
      <h6 class="mb-2">Historial de pagos</h6>
      @if (!modal.vouchers.length) {
        <div class="text-muted">Sin vouchers registrados.</div>
      }
      <div class="list-group">
        @for (v of modal.vouchers; track v.Codigo) {
          <div class="list-group-item d-flex justify-content-between align-items-center voucher-item">
            <div>
              <div class="fw-semibold">{{ v.Fecha | date:'dd-MM-yyyy' }} · {{ v.MetodoPago }}</div>
              <div class="text-muted">Monto: {{ v.Monto | usd:'1.2-2' }}</div>
            </div>
            <div class="d-flex align-items-center gap-2 voucher-actions">
              @if (puedeVerVoucher(v)) {
                <a class="btn btn-link btn-sm" [href]="v.Link" target="_blank" rel="noopener">Ver voucher</a>
              }
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                (click)="descargarComprobanteDesdeLista(v.Codigo)"
              >
                Descargar comprobante
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <div modal-footer class="d-flex justify-content-end gap-2">
    @if (modal.allowRegistro) {
      <button class="btn btn-outline-secondary" type="button" (click)="cerrarGestionPago()" [disabled]="modal.guardando">
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        type="submit"
        form="registrarPagoForm"
        [disabled]="!puedeRegistrar"
      >
        Registrar pago
      </button>
    } @else {
      <button class="btn btn-outline-secondary" type="button" (click)="cerrarGestionPago()" [disabled]="modal.guardando">
        Cerrar
      </button>
    }
  </div>
</app-modal-base>
