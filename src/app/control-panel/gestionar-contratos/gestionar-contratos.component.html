<div class="dashboard-content">
  <app-list-toolbar
    [title]="'Contratos'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: contrato, pedido, cliente...'"
    [searchValue]="searchTerm"
    [showCreateButton]="false"
    (searchChange)="onToolbarSearch($event)">
  </app-list-toolbar>

  <div class="filters-row">
    <div class="filter-field">
      <label class="form-label mb-1">Estado contrato</label>
      <select class="form-select" [ngModel]="filtroEstado" (ngModelChange)="onEstadoFilterChange($event)">
        <option value="">Todos</option>
        @for (estado of estadosContrato; track estado) {
          <option [value]="estado">{{ estado }}</option>
        }
      </select>
    </div>
    <div class="filter-field">
      <label class="form-label mb-1">Vigencia</label>
      <select class="form-select" [ngModel]="filtroVigente" (ngModelChange)="onVigenteFilterChange($event)">
        <option value="all">Todos</option>
        <option value="true">Solo vigentes</option>
        <option value="false">No vigentes</option>
      </select>
    </div>
    <div class="filter-actions">
      <button type="button" class="btn btn-outline-secondary" (click)="reload()">
        Recargar
      </button>
    </div>
  </div>

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (!loadingList) {
    <app-table-base [columns]="columns" [data]="rows" [pageSizeOptions]="[10, 25, 50]" [pageSize]="10"
      emptyText="Sin contratos"
      [showCreateButton]="false"
      [showSearch]="false">

      <ng-template appCell="codigoContrato" let-row>
        {{ row.codigoContrato || ('#' + row.contratoId) }}
      </ng-template>

      <ng-template appCell="codigoPedido" let-row>
        {{ row.codigoPedido || ('#' + row.pedidoId) }}
      </ng-template>

      <ng-template appCell="cliente" let-row>
        <div class="d-flex flex-column">
          <span>{{ row.cliente || '--' }}</span>
          @if (row.clienteDocumento) {
            <small class="text-muted">{{ row.clienteDocumento }}</small>
          }
        </div>
      </ng-template>

      <ng-template appCell="fechaContrato" let-row>
        {{ (row.fechaCreacion || row.createdAt || row.fechaContrato) ? ((row.fechaCreacion || row.createdAt || row.fechaContrato) | date:'dd-MM-yyyy') : '--' }}
      </ng-template>

      <ng-template appCell="versionContrato" let-row>
        v{{ row.versionContrato ?? '--' }}
      </ng-template>

      <ng-template appCell="estadoContrato" let-row>
        <app-estado-badge
          [estado]="row.estadoContrato || 'Sin estado'"
          [mapaColores]="{
            'BORRADOR': 'warning',
            'PENDIENTE': 'warning',
            'VIGENTE': 'success',
            'ANULADO': 'danger',
            'EXPIRADO': 'danger',
            'CERRADO': 'secondary'
          }">
        </app-estado-badge>
      </ng-template>

      <ng-template appCell="esVigente" let-row>
        <app-estado-badge
          [estado]="row.esVigente ? 'Si' : 'No'"
          [mapaColores]="{ 'si': 'success', 'no': 'secondary' }">
        </app-estado-badge>
      </ng-template>

      <ng-template appCell="acciones" let-row>
        <div class="d-flex justify-content-center gap-1">
          <button
            mat-icon-button
            color="primary"
            type="button"
            (click)="$event.stopPropagation(); verPdf(row.contratoId)"
            [disabled]="downloadingContratoId === row.contratoId"
            matTooltip="Ver actual (PDF)">
            @if (downloadingContratoId !== row.contratoId) {
              <mat-icon>picture_as_pdf</mat-icon>
            }
            @if (downloadingContratoId === row.contratoId) {
              <mat-icon class="spin">hourglass_top</mat-icon>
            }
          </button>
          <button
            mat-icon-button
            color="primary"
            type="button"
            (click)="$event.stopPropagation(); descargarPdf(row.contratoId)"
            [disabled]="downloadingContratoId === row.contratoId"
            matTooltip="Descargar PDF">
            <mat-icon>download</mat-icon>
          </button>
          <button
            mat-icon-button
            color="primary"
            type="button"
            (click)="$event.stopPropagation(); cargarHistorial(row)"
            matTooltip="Historial por pedido">
            <mat-icon>history</mat-icon>
          </button>
        </div>
      </ng-template>
    </app-table-base>
  } @else {
    <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-3 mb-0">Cargando contratos...</p>
    </div>
  }
</div>

<app-modal-base
  [open]="historialModalOpen"
  [title]="'Historial de versiones - Pedido ' + (historialPedidoCodigo || ('#' + (historialPedidoId || '')))"
  [disableClose]="false"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="closeHistorialModal()">
  <div class="d-flex justify-content-end mb-2">
    <button type="button" class="btn btn-outline-primary btn-sm" (click)="cargarVigentePedido()" [disabled]="!historialPedidoId">
      Ver vigente del pedido
    </button>
  </div>

  @if (historialLoading) {
    <div class="d-flex align-items-center gap-2 text-muted">
      <mat-spinner diameter="22"></mat-spinner>
      <span>Cargando historial...</span>
    </div>
  } @else if (historialError) {
    <div class="alert alert-danger mb-0" role="alert">{{ historialError }}</div>
  } @else if (historialRows.length === 0) {
    <div class="text-muted">Sin versiones registradas para este pedido.</div>
  } @else {
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Version</th>
            <th>Estado</th>
            <th>Vigente</th>
            <th>Fecha creacion</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (item of historialRows; track item.id) {
            <tr>
              <td>{{ item.id }}</td>
              <td>v{{ item.version ?? '--' }}</td>
              <td>{{ item.estado || '--' }}</td>
              <td>{{ item.esVigente ? 'Si' : 'No' }}</td>
              <td>{{ (item.fechaCreacion || item.createdAt || item.fechaContrato) ? ((item.fechaCreacion || item.createdAt || item.fechaContrato) | date:'dd-MM-yyyy') : '--' }}</td>
              <td class="text-center">
                <div class="d-inline-flex gap-1">
                  <button mat-icon-button color="primary" type="button" (click)="verPdf(item.id)" matTooltip="Abrir PDF">
                    <mat-icon>picture_as_pdf</mat-icon>
                  </button>
                  <button mat-icon-button color="primary" type="button" (click)="descargarPdf(item.id)" matTooltip="Descargar PDF">
                    <mat-icon>download</mat-icon>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (vigentePedidoError) {
    <div class="alert alert-warning mt-3 mb-0" role="alert">{{ vigentePedidoError }}</div>
  }
  @if (vigentePedido) {
    <div class="alert alert-success mt-3 mb-0" role="status">
      Contrato vigente: ID {{ vigentePedido.id }} - Version v{{ vigentePedido.version ?? '--' }} - Estado {{ vigentePedido.estado || '--' }}
    </div>
  }

  <div modal-footer class="d-flex justify-content-end">
    <button type="button" class="btn btn-outline-secondary" (click)="closeHistorialModal()">
      Cerrar
    </button>
  </div>
</app-modal-base>
