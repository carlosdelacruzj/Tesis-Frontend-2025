<div class="dashboard-content">

  <app-list-toolbar
    [title]="'Personal'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: código, nombre, documento…'"
    [searchValue]="searchTerm"
    [showCreateButton]="true"
    [createButtonLabel]="'Registrar empleado'"
    (searchChange)="onToolbarSearch($event)"
    (createClick)="navigateToCreate()">
  </app-list-toolbar>

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (!loadingList) {
    <app-table-base [columns]="columns" [data]="rows" [pageSizeOptions]="[10, 25, 50]" [pageSize]="10"
      emptyText="Sin personal registrado"
       (sortChange)="onSortChange($event)" (pageChange)="onPageChange($event)"
      [showCreateButton]="false" [showSearch]="false"
      [externalSearchTerm]="searchTerm">

      <ng-template appCell="codigo" let-row>
        {{ row.codigo }}
      </ng-template>

      <ng-template appCell="nombreCompleto" let-row>
        <div class="d-flex flex-column">
          <span>{{ row.nombre }} {{ row.apellido }}</span>
          <small class="text-muted">{{ row.autonomo === 2 || row.autonomo === 'SI' ? 'Autónomo' : 'Dependiente' }}</small>
        </div>
      </ng-template>

      <ng-template appCell="documento" let-row>
        {{ row.documento || '—' }}
      </ng-template>

      <ng-template appCell="cargo" let-row>
        {{ row.cargo || '—' }}
      </ng-template>

      <ng-template appCell="estado" let-row>
        <app-estado-badge
          [estado]="getEstadoTexto(row.estado, row.idEstado)"
          [mapaColores]="{ 'activo': 'success', 'inactivo': 'danger' }"
        ></app-estado-badge>
      </ng-template>

      <ng-template appCell="acciones" let-row>
        <div class="d-flex justify-content-center gap-1">
          <button mat-icon-button color="primary" type="button" (click)="$event.stopPropagation(); editarEmpleado(row)"
            matTooltip="Editar">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="accent" type="button" (click)="$event.stopPropagation(); verEmpleado(row)"
            matTooltip="Ver detalle">
            <mat-icon>visibility</mat-icon>
          </button>
        </div>
      </ng-template>

    </app-table-base>
  } @else {
    <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-3 mb-0">Cargando personal…</p>
    </div>
  }
</div>

<app-modal-base
  [open]="modalCrearOpen"
  title="Registrar empleado"
  [disableClose]="modalCrearLoading || modalCrearSaving"
  [loading]="modalCrearSaving"
  [useDefaultFooter]="false"
  (closed)="onCreateModalClosed()">

  <app-formulario-base
    [open]="modalCrearOpen"
    [loading]="modalCrearLoading"
    [loadingMessage]="'Preparando formulario…'"
    [error]="!modalCrearLoading ? modalCrearError : null">

    <form #createForm="ngForm" id="createEmpleadoForm" novalidate (ngSubmit)="submitCreate(createForm)">

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label" for="createNombre">Nombres</label>
          <input id="createNombre" type="text" class="form-control" name="nombre" required [pattern]="nombresPattern"
            [(ngModel)]="nuevoEmpleado.nombre" #nombreCtrl="ngModel"
            [class.is-invalid]="nombreCtrl.invalid && nombreCtrl.touched"
            [attr.title]="nombreCtrl.invalid && nombreCtrl.touched ? (nombreCtrl.errors?.required ? 'Campo requerido' : 'Solo letras (2-20)') : null">
          @if (nombreCtrl.invalid && (nombreCtrl.dirty || nombreCtrl.touched)) {
            <div class="invalid-feedback d-block">
              @if (nombreCtrl.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (nombreCtrl.errors?.pattern) {
                <span>Sólo letras (2-20)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createApellido">Apellidos</label>
          <input id="createApellido" type="text" class="form-control" name="apellido" required [pattern]="apellidoPattern"
            [(ngModel)]="nuevoEmpleado.apellido" #apellidoCtrl="ngModel"
            [class.is-invalid]="apellidoCtrl.invalid && apellidoCtrl.touched"
            [attr.title]="apellidoCtrl.invalid && apellidoCtrl.touched ? (apellidoCtrl.errors?.required ? 'Campo requerido' : 'Solo letras (2-30)') : null">
          @if (apellidoCtrl.invalid && (apellidoCtrl.dirty || apellidoCtrl.touched)) {
            <div class="invalid-feedback d-block">
              @if (apellidoCtrl.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (apellidoCtrl.errors?.pattern) {
                <span>Sólo letras (2-30)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createDocumento">Documento</label>
          <input id="createDocumento" type="text" class="form-control" name="documento" required [pattern]="docPattern"
            [(ngModel)]="nuevoEmpleado.documento" #documentoCtrl="ngModel"
            [class.is-invalid]="documentoCtrl.invalid && documentoCtrl.touched"
            [attr.title]="documentoCtrl.invalid && documentoCtrl.touched ? (documentoCtrl.errors?.required ? 'Campo requerido' : 'Solo numeros (8 digitos)') : null">
          @if (documentoCtrl.invalid && (documentoCtrl.dirty || documentoCtrl.touched)) {
            <div class="invalid-feedback d-block">
              @if (documentoCtrl.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (documentoCtrl.errors?.pattern) {
                <span>Sólo números (8 dígitos)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createCelular">Celular</label>
          <input id="createCelular" type="text" class="form-control" name="celular" required [pattern]="celularPattern"
            [(ngModel)]="nuevoEmpleado.celular" #celularCtrl="ngModel"
            [class.is-invalid]="celularCtrl.invalid && celularCtrl.touched"
            [attr.title]="celularCtrl.invalid && celularCtrl.touched ? (celularCtrl.errors?.required ? 'Campo requerido' : 'Solo numeros (7-9 digitos)') : null">
          @if (celularCtrl.invalid && (celularCtrl.dirty || celularCtrl.touched)) {
            <div class="invalid-feedback d-block">
              @if (celularCtrl.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (celularCtrl.errors?.pattern) {
                <span>Sólo números (7-9 dígitos)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createCorreo">Correo</label>
          <input id="createCorreo" type="email" class="form-control" name="correo" required [pattern]="correoPattern"
            [(ngModel)]="nuevoEmpleado.correo" #correoCtrl="ngModel"
            [class.is-invalid]="correoCtrl.invalid && correoCtrl.touched"
            [attr.title]="correoCtrl.invalid && correoCtrl.touched ? (correoCtrl.errors?.required ? 'Campo requerido' : 'Ingrese un correo valido') : null">
          @if (correoCtrl.invalid && (correoCtrl.dirty || correoCtrl.touched)) {
            <div class="invalid-feedback d-block">
              @if (correoCtrl.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (correoCtrl.errors?.pattern) {
                <span>Ingrese un correo válido</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createAutonomo">Autónomo</label>
          <select id="createAutonomo" class="form-select" name="autonomo" [(ngModel)]="nuevoEmpleado.autonomo" required
            #autonomoCtrl="ngModel" [class.is-invalid]="autonomoCtrl.invalid && autonomoCtrl.touched"
            [attr.title]="autonomoCtrl.invalid && autonomoCtrl.touched ? 'Selecciona una opcion' : null">
            <option [ngValue]="1">No</option>
            <option [ngValue]="2">Sí</option>
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="createEstado">Estado</label>
          <select id="createEstado" class="form-select" name="idEstado" [(ngModel)]="nuevoEmpleado.idEstado" required
            #estadoCtrl="ngModel" [class.is-invalid]="estadoCtrl.invalid && estadoCtrl.touched"
            [attr.title]="estadoCtrl.invalid && estadoCtrl.touched ? 'Selecciona un estado' : null">
            <option [ngValue]="1">Activo</option>
            <option [ngValue]="2">Inactivo</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label" for="createCargo">Cargo</label>
          <select id="createCargo" class="form-select" name="idCargo" required [(ngModel)]="nuevoEmpleado.idCargo"
            #cargoCtrl="ngModel" [class.is-invalid]="cargoCtrl.invalid && cargoCtrl.touched"
            [attr.title]="cargoCtrl.invalid && cargoCtrl.touched ? 'Selecciona un cargo' : null">
            <option [ngValue]="0" disabled>Seleccione un cargo</option>
            @for (cargo of cargos; track cargo.idCargo) {
              <option [ngValue]="cargo.idCargo">{{ cargo.cargoNombre }}</option>
            }
          </select>
          @if (cargoCtrl.invalid && (cargoCtrl.dirty || cargoCtrl.touched)) {
            <div class="invalid-feedback d-block">
              <span>Seleccione un cargo</span>
            </div>
          }
        </div>

        <div class="col-12">
          <label class="form-label" for="createDireccion">Dirección</label>
          <textarea id="createDireccion" class="form-control" name="direccion" rows="3" required [(ngModel)]="nuevoEmpleado.direccion"
            #direccionCtrl="ngModel" [class.is-invalid]="direccionCtrl.invalid && direccionCtrl.touched"
            [attr.title]="direccionCtrl.invalid && direccionCtrl.touched ? 'Campo requerido' : null"></textarea>
          @if (direccionCtrl.invalid && (direccionCtrl.dirty || direccionCtrl.touched)) {
            <div class="invalid-feedback d-block">
              <span>Campo requerido</span>
            </div>
          }
        </div>
      </div>
    </form>
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeCreateModal()"
      [disabled]="modalCrearLoading || modalCrearSaving">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" form="createEmpleadoForm"
      [disabled]="modalCrearSaving || modalCrearLoading">
      @if (modalCrearSaving) {
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      }
      Registrar
    </button>
  </div>

</app-modal-base>

<app-modal-base
  [open]="modalEditarOpen"
  title="Actualizar empleado"
  [disableClose]="modalEditarLoading || modalEditarSaving"
  [loading]="modalEditarSaving"
  [useDefaultFooter]="false"
  (closed)="onEditModalClosed()">

  <app-formulario-base
    [open]="modalEditarOpen"
    [loading]="modalEditarLoading"
    [loadingMessage]="'Cargando empleado…'"
    [error]="!modalEditarLoading ? modalEditarError : null">

    @if (selected) {
      <form #EmpleadoUpdateForm="ngForm" id="updateEmpleadoForm"
        (ngSubmit)="UpdateEmpleado(EmpleadoUpdateForm)">

        <div class="row g-3">
          <input type="hidden" name="ID" [(ngModel)]="selected.idEmpleado">

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateNombres">Nombres</label>
            <input id="updateNombres" type="text" class="form-control" name="Nombres" [(ngModel)]="selected.nombre" disabled>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateApellidos">Apellidos</label>
            <input id="updateApellidos" type="text" class="form-control" name="Apellidos" [(ngModel)]="selected.apellido" disabled>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateDni">N° documento de identidad</label>
            <input id="updateDni" type="text" class="form-control" name="DNI" [(ngModel)]="selected.documento" disabled>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateCelular">Celular</label>
            <input id="updateCelular" type="text" class="form-control" name="Celular" #Celular="ngModel" [(ngModel)]="selected.celular"
              [pattern]="celularPattern" required>
            @if (Celular.invalid && (Celular.dirty || Celular.touched)) {
              <div class="invalid-feedback d-block">
                @if (Celular.errors?.required) {
                  <span>Campo requerido</span>
                }
                @if (Celular.errors?.pattern) {
                  <span>Sólo números (7-9 dígitos)</span>
                }
              </div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateCorreo">Email</label>
            <input id="updateCorreo" type="text" class="form-control" name="Correo" #Correo="ngModel" [(ngModel)]="selected.correo"
              [pattern]="correoPattern" required>
            @if (Correo.invalid && (Correo.dirty || Correo.touched)) {
              <div class="invalid-feedback d-block">
                @if (Correo.errors?.required) {
                  <span>Campo requerido</span>
                }
                @if (Correo.errors?.pattern) {
                  <span>Ingrese un email válido</span>
                }
              </div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateEstado">Estado</label>
            <select id="updateEstado" class="form-select" name="Estado" #Estado="ngModel" [(ngModel)]="selected.idEstado" required>
              <option [ngValue]="1">Activo</option>
              <option [ngValue]="2">Inactivo</option>
            </select>
            @if (Estado.invalid && (Estado.dirty || Estado.touched)) {
              <div class="invalid-feedback d-block">
                <span>Campo requerido</span>
              </div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateAutonomo">Autónomo</label>
            <input id="updateAutonomo" type="text" class="form-control" name="Autonomo"
              [ngModel]="selected?.autonomo === 2 || selected?.autonomo === 'SI' ? 'Sí' : 'No'"
              disabled>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="updateCargo">Cargo</label>
            <input id="updateCargo" type="text" class="form-control" name="Cargo" [ngModel]="selected.cargo" disabled>
          </div>

          <div class="col-12">
            <label class="form-label" for="updateDireccion">Dirección</label>
            <textarea id="updateDireccion" class="form-control" name="Direccion" rows="3" #Direccion="ngModel" [(ngModel)]="selected.direccion"
              required></textarea>
            @if (Direccion.invalid && (Direccion.dirty || Direccion.touched)) {
              <div class="invalid-feedback d-block">
                <span>Campo requerido</span>
              </div>
            }
          </div>
        </div>
      </form>
    }

    @if (!selected && !modalEditarLoading && !modalEditarError) {
      <div class="text-muted">
        Selecciona un empleado para editar.
      </div>
    }
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeEditModal()"
      [disabled]="modalEditarLoading || modalEditarSaving">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" form="updateEmpleadoForm"
      [disabled]="modalEditarSaving || modalEditarLoading || !selected">
      @if (modalEditarSaving) {
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      }
      Actualizar
    </button>
  </div>

</app-modal-base>

<app-modal-base
  [open]="modalVerOpen"
  title="Detalles del empleado"
  [disableClose]="modalVerLoading"
  [useDefaultFooter]="false"
  (closed)="onViewModalClosed()">

  <app-formulario-base
    [open]="modalVerOpen"
    [loading]="modalVerLoading"
    [loadingMessage]="'Cargando empleado…'"
    [error]="!modalVerLoading ? modalVerError : null">

    @if (selected) {
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewNombres">Nombres</label>
          <input id="viewNombres" type="text" class="form-control" name="Nombres" [ngModel]="selected.nombre" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewApellidos">Apellidos</label>
          <input id="viewApellidos" type="text" class="form-control" name="Apellidos" [ngModel]="selected.apellido" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewDni">N° documento de identidad</label>
          <input id="viewDni" type="text" class="form-control" name="DNI" [ngModel]="selected.documento" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewCelular">Celular</label>
          <input id="viewCelular" type="text" class="form-control" name="Celular" [ngModel]="selected.celular" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewCorreo">Email</label>
          <input id="viewCorreo" type="text" class="form-control" name="Correo" [ngModel]="selected.correo" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewEstado">Estado</label>
          <input id="viewEstado" type="text" class="form-control" name="Estado"
            [ngModel]="getEstadoTexto(selected?.estado, selected?.idEstado)" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewAutonomo">Autónomo</label>
          <input id="viewAutonomo" type="text" class="form-control" name="Autonomo"
            [ngModel]="selected?.autonomo === 2 || selected?.autonomo === 'SI' ? 'Sí' : 'No'"
            disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="viewCargo">Cargo</label>
          <input id="viewCargo" type="text" class="form-control" name="Cargo" [ngModel]="selected.cargo" disabled>
        </div>
        <div class="col-12">
          <label class="form-label" for="viewDireccion">Dirección</label>
          <textarea id="viewDireccion" class="form-control" name="Direccion" rows="3" [ngModel]="selected.direccion" disabled></textarea>
        </div>
      </div>
    }

    @if (!selected && !modalVerLoading && !modalVerError) {
      <div class="text-muted">
        Selecciona un empleado para ver.
      </div>
    }
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeViewModal()" [disabled]="modalVerLoading">
      Cerrar
    </button>
  </div>

</app-modal-base>
