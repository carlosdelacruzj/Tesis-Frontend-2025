<div class="dashboard-content">

  <div class="py-4">
    <h1>Personal</h1>
  </div>

  <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>

  <ng-container *ngIf="!loadingList; else loadingState">
    <app-table-base [columns]="columns" [data]="rows" [pageSizeOptions]="[10, 25, 50]" [pageSize]="10"
      searchPlaceholder="Buscar: código, nombre, documento…" emptyText="Sin personal registrado"
       (sortChange)="onSortChange($event)" (pageChange)="onPageChange($event)"
      [showCreateButton]="true" createButtonLabel="Registrar empleado" (createClick)="navigateToCreate()">

      <ng-template appCell="codigoEmpleado" let-row>
        {{ row.codigoEmpleado || ('EMP-' + row.idEmpleado) }}
      </ng-template>

      <ng-template appCell="nombreCompleto" let-row>
        <div class="d-flex flex-column">
          <span>{{ row.nombre }} {{ row.apellido }}</span>
          <small class="text-muted">{{ row.autonomo === 2 ? 'Autónomo' : 'Dependiente' }}</small>
        </div>
      </ng-template>

      <ng-template appCell="documento" let-row>
        {{ row.documento || '—' }}
      </ng-template>

      <ng-template appCell="cargo" let-row>
        {{ row.cargo || '—' }}
      </ng-template>

      <ng-template appCell="estado" let-row>
        <span class="badge" [class.bg-success]="row.estado === 'DISPONIBLE'"
          [class.bg-danger]="row.estado === 'NO_DISPONIBLE'" [class.bg-secondary]="!row.estado">
          {{ row.estado || (row.autonomo === 2 ? 'Autónomo' : 'Dependiente') }}
        </span>
      </ng-template>

      <ng-template appCell="acciones" let-row>
        <div class="d-flex justify-content-center gap-1">
          <button mat-icon-button color="primary" type="button" (click)="$event.stopPropagation(); editarEmpleado(row)"
            matTooltip="Editar">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="accent" type="button" (click)="$event.stopPropagation(); verEmpleado(row)"
            matTooltip="Ver detalle">
            <mat-icon>visibility</mat-icon>
          </button>
        </div>
      </ng-template>

    </app-table-base>
  </ng-container>
</div>

<ng-template #loadingState>
  <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
    <mat-spinner diameter="40"></mat-spinner>
    <p class="mt-3 mb-0">Cargando personal…</p>
  </div>
</ng-template>

<app-modal-base
  [open]="modalCrearOpen"
  title="Registrar empleado"
  [disableClose]="modalCrearLoading || modalCrearSaving"
  [loading]="modalCrearSaving"
  [useDefaultFooter]="false"
  (closed)="onCreateModalClosed()">

  <app-formulario-base
    [open]="modalCrearOpen"
    [loading]="modalCrearLoading"
    [loadingMessage]="'Preparando formulario…'"
    [error]="!modalCrearLoading ? modalCrearError : null">

    <form #createForm="ngForm" id="createEmpleadoForm" novalidate (ngSubmit)="submitCreate(createForm)">

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Nombres</label>
          <input type="text" class="form-control" name="nombre" required [pattern]="nombresPattern"
            [(ngModel)]="nuevoEmpleado.nombre" #nombreCtrl="ngModel">
          <div class="invalid-feedback d-block" *ngIf="nombreCtrl.invalid && (nombreCtrl.dirty || nombreCtrl.touched)">
            <span *ngIf="nombreCtrl.errors?.required">Campo requerido</span>
            <span *ngIf="nombreCtrl.errors?.pattern">Sólo letras (2-20)</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Apellidos</label>
          <input type="text" class="form-control" name="apellido" required [pattern]="apellidoPattern"
            [(ngModel)]="nuevoEmpleado.apellido" #apellidoCtrl="ngModel">
          <div class="invalid-feedback d-block"
            *ngIf="apellidoCtrl.invalid && (apellidoCtrl.dirty || apellidoCtrl.touched)">
            <span *ngIf="apellidoCtrl.errors?.required">Campo requerido</span>
            <span *ngIf="apellidoCtrl.errors?.pattern">Sólo letras (2-30)</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Documento</label>
          <input type="text" class="form-control" name="documento" required [pattern]="docPattern"
            [(ngModel)]="nuevoEmpleado.documento" #documentoCtrl="ngModel">
          <div class="invalid-feedback d-block"
            *ngIf="documentoCtrl.invalid && (documentoCtrl.dirty || documentoCtrl.touched)">
            <span *ngIf="documentoCtrl.errors?.required">Campo requerido</span>
            <span *ngIf="documentoCtrl.errors?.pattern">Sólo números (8 dígitos)</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Celular</label>
          <input type="text" class="form-control" name="celular" required [pattern]="celularPattern"
            [(ngModel)]="nuevoEmpleado.celular" #celularCtrl="ngModel">
          <div class="invalid-feedback d-block"
            *ngIf="celularCtrl.invalid && (celularCtrl.dirty || celularCtrl.touched)">
            <span *ngIf="celularCtrl.errors?.required">Campo requerido</span>
            <span *ngIf="celularCtrl.errors?.pattern">Sólo números (7-9 dígitos)</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Correo</label>
          <input type="email" class="form-control" name="correo" required [pattern]="correoPattern"
            [(ngModel)]="nuevoEmpleado.correo" #correoCtrl="ngModel">
          <div class="invalid-feedback d-block" *ngIf="correoCtrl.invalid && (correoCtrl.dirty || correoCtrl.touched)">
            <span *ngIf="correoCtrl.errors?.required">Campo requerido</span>
            <span *ngIf="correoCtrl.errors?.pattern">Ingrese un correo válido</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Autónomo</label>
          <select class="form-select" name="autonomo" [(ngModel)]="nuevoEmpleado.autonomo" required>
            <option [ngValue]="1">No</option>
            <option [ngValue]="2">Sí</option>
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Estado</label>
          <select class="form-select" name="idEstado" [(ngModel)]="nuevoEmpleado.idEstado" required>
            <option [ngValue]="1">Disponible</option>
            <option [ngValue]="2">No disponible</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Cargo</label>
          <select class="form-select" name="idCargo" required [(ngModel)]="nuevoEmpleado.idCargo" #cargoCtrl="ngModel">
            <option [ngValue]="0" disabled>Seleccione un cargo</option>
            <option *ngFor="let cargo of cargos" [ngValue]="cargo.idCargo">{{ cargo.cargoNombre }}</option>
          </select>
          <div class="invalid-feedback d-block" *ngIf="cargoCtrl.invalid && (cargoCtrl.dirty || cargoCtrl.touched)">
            <span>Seleccione un cargo</span>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Dirección</label>
          <textarea class="form-control" name="direccion" rows="3" required [(ngModel)]="nuevoEmpleado.direccion"
            #direccionCtrl="ngModel"></textarea>
          <div class="invalid-feedback d-block"
            *ngIf="direccionCtrl.invalid && (direccionCtrl.dirty || direccionCtrl.touched)">
            <span>Campo requerido</span>
          </div>
        </div>
      </div>
    </form>
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeCreateModal()"
      [disabled]="modalCrearLoading || modalCrearSaving">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" form="createEmpleadoForm"
      [disabled]="modalCrearSaving || modalCrearLoading || createForm?.invalid">
      <span *ngIf="modalCrearSaving" class="spinner-border spinner-border-sm me-1" role="status"
        aria-hidden="true"></span>
      Registrar
    </button>
  </div>

</app-modal-base>

<app-modal-base
  [open]="modalEditarOpen"
  title="Actualizar empleado"
  [disableClose]="modalEditarLoading || modalEditarSaving"
  [loading]="modalEditarSaving"
  [useDefaultFooter]="false"
  (closed)="onEditModalClosed()">

  <app-formulario-base
    [open]="modalEditarOpen"
    [loading]="modalEditarLoading"
    [loadingMessage]="'Cargando empleado…'"
    [error]="!modalEditarLoading ? modalEditarError : null">

    <form *ngIf="selected" #EmpleadoUpdateForm="ngForm" id="updateEmpleadoForm"
      (ngSubmit)="UpdateEmpleado(EmpleadoUpdateForm)">

      <div class="row g-3">
        <input type="hidden" name="ID" [(ngModel)]="selected.idEmpleado">

        <div class="col-12 col-md-6">
          <label class="form-label">Nombres</label>
          <input type="text" class="form-control" name="Nombres" [(ngModel)]="selected.nombre" disabled>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Apellidos</label>
          <input type="text" class="form-control" name="Apellidos" [(ngModel)]="selected.apellido" disabled>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">N° documento de identidad</label>
          <input type="text" class="form-control" name="DNI" [(ngModel)]="selected.documento" disabled>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Celular</label>
          <input type="text" class="form-control" name="Celular" #Celular="ngModel" [(ngModel)]="selected.celular"
            [pattern]="celularPattern" required>
          <div class="invalid-feedback d-block" *ngIf="Celular.invalid && (Celular.dirty || Celular.touched)">
            <span *ngIf="Celular.errors?.required">Campo requerido</span>
            <span *ngIf="Celular.errors?.pattern">Sólo números (7-9 dígitos)</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Email</label>
          <input type="text" class="form-control" name="Correo" #Correo="ngModel" [(ngModel)]="selected.correo"
            [pattern]="correoPattern" required>
          <div class="invalid-feedback d-block" *ngIf="Correo.invalid && (Correo.dirty || Correo.touched)">
            <span *ngIf="Correo.errors?.required">Campo requerido</span>
            <span *ngIf="Correo.errors?.pattern">Ingrese un email válido</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Estado</label>
          <select class="form-select" name="Estado" #Estado="ngModel" [(ngModel)]="selected.idEstado" required>
            <option [ngValue]="1">Disponible</option>
            <option [ngValue]="2">No disponible</option>
          </select>
          <div class="invalid-feedback d-block" *ngIf="Estado.invalid && (Estado.dirty || Estado.touched)">
            <span>Campo requerido</span>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Autónomo</label>
          <input type="text" class="form-control" name="Autonomo" [ngModel]="selected?.autonomo === 2 ? 'Sí' : 'No'"
            disabled>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Cargo</label>
          <input type="text" class="form-control" name="Cargo" [ngModel]="selected.cargo" disabled>
        </div>

        <div class="col-12">
          <label class="form-label">Dirección</label>
          <textarea class="form-control" name="Direccion" rows="3" #Direccion="ngModel" [(ngModel)]="selected.direccion"
            required></textarea>
          <div class="invalid-feedback d-block" *ngIf="Direccion.invalid && (Direccion.dirty || Direccion.touched)">
            <span>Campo requerido</span>
          </div>
        </div>
      </div>
    </form>

    <div *ngIf="!selected && !modalEditarLoading && !modalEditarError" class="text-muted">
      Selecciona un empleado para editar.
    </div>
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeEditModal()"
      [disabled]="modalEditarLoading || modalEditarSaving">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" form="updateEmpleadoForm"
      [disabled]="modalEditarSaving || modalEditarLoading || !selected">
      <span *ngIf="modalEditarSaving" class="spinner-border spinner-border-sm me-1" role="status"
        aria-hidden="true"></span>
      Actualizar
    </button>
  </div>

</app-modal-base>

<app-modal-base
  [open]="modalVerOpen"
  title="Detalles del empleado"
  [disableClose]="modalVerLoading"
  [useDefaultFooter]="false"
  (closed)="onViewModalClosed()">

  <app-formulario-base
    [open]="modalVerOpen"
    [loading]="modalVerLoading"
    [loadingMessage]="'Cargando empleado…'"
    [error]="!modalVerLoading ? modalVerError : null">

    <ng-container *ngIf="selected">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Nombres</label>
          <input type="text" class="form-control" name="Nombres" [ngModel]="selected.nombre" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Apellidos</label>
          <input type="text" class="form-control" name="Apellidos" [ngModel]="selected.apellido" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">N° documento de identidad</label>
          <input type="text" class="form-control" name="DNI" [ngModel]="selected.documento" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Celular</label>
          <input type="text" class="form-control" name="Celular" [ngModel]="selected.celular" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Email</label>
          <input type="text" class="form-control" name="Correo" [ngModel]="selected.correo" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Estado</label>
          <input type="text" class="form-control" name="Estado"
            [ngModel]="selected.estado || (selected?.autonomo === 2 ? 'Autónomo' : 'Dependiente')" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Autónomo</label>
          <input type="text" class="form-control" name="Autonomo" [ngModel]="selected?.autonomo === 2 ? 'Sí' : 'No'"
            disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Cargo</label>
          <input type="text" class="form-control" name="Cargo" [ngModel]="selected.cargo" disabled>
        </div>
        <div class="col-12">
          <label class="form-label">Dirección</label>
          <textarea class="form-control" name="Direccion" rows="3" [ngModel]="selected.direccion" disabled></textarea>
        </div>
      </div>
    </ng-container>

    <div *ngIf="!selected && !modalVerLoading && !modalVerError" class="text-muted">
      Selecciona un empleado para ver.
    </div>
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeViewModal()" [disabled]="modalVerLoading">
      Cerrar
    </button>
  </div>

</app-modal-base>
