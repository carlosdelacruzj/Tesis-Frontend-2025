<div class="container-fluid p-5">
    <h1 class="font-weight-bold">Registrar Pagos</h1>

    <!-- === LISTADO DE PEDIDOS === -->
    <mat-tab-group *ngIf="listadoPedidos" animationDuration="200ms">
        <!-- PENDIENTES -->
        <mat-tab label="Pendientes">
            <table mat-table [dataSource]="pedidosPendientes" class="table" aria-label="Pedidos Pendientes">
                <ng-container matColumnDef="Id">
                    <th mat-header-cell *matHeaderCellDef class="text-center">ID</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.IdPed }}</td>
                </ng-container>

                <ng-container matColumnDef="Proyecto">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Proyecto</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Nombre }}</td>
                </ng-container>

                <ng-container matColumnDef="Fecha">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Fecha</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Fecha | date:'dd-MM-yyyy' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="Editar">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Editar</th>
                    <td mat-cell *matCellDef="let element" class="text-center">
                        <button class="btn" type="button" (click)="getIdPedido(element.IdPed)"
                            [attr.aria-label]="'Editar pedido ' + element.IdPed">
                            <i class="fas fa-edit fa-2x" aria-hidden="true"></i>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
        </mat-tab>
        <!-- PARCIALES -->
        <mat-tab label="Parciales">
            <table mat-table [dataSource]="pedidosParciales" class="table" aria-label="Pedidos Parciales">
                <ng-container matColumnDef="Id">
                    <th mat-header-cell *matHeaderCellDef class="text-center">ID</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.IdPed }}</td>
                </ng-container>

                <ng-container matColumnDef="Proyecto">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Proyecto</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Nombre }}</td>
                </ng-container>

                <ng-container matColumnDef="Fecha">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Fecha</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Fecha | date:'dd-MM-yyyy' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="Editar">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Editar</th>
                    <td mat-cell *matCellDef="let element" class="text-center">
                        <button class="btn" type="button" (click)="getIdPedido(element.IdPed)"
                            [attr.aria-label]="'Editar pedido ' + element.IdPed">
                            <i class="fas fa-edit fa-2x" aria-hidden="true"></i>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
        </mat-tab>

        <!-- PAGADOS -->
        <mat-tab label="Pagados">
            <table mat-table [dataSource]="pedidosPagados" class="table" aria-label="Pedidos Pagados">
                <ng-container matColumnDef="Id">
                    <th mat-header-cell *matHeaderCellDef class="text-center">ID</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.IdPed }}</td>
                </ng-container>

                <ng-container matColumnDef="Proyecto">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Proyecto</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Nombre }}</td>
                </ng-container>

                <ng-container matColumnDef="Fecha">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Fecha</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Fecha | date:'dd-MM-yyyy'}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="Editar">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Editar</th>
                    <td mat-cell *matCellDef="let element" class="text-center">
                        <button class="btn" type="button" (click)="getIdPedido(element.IdPed)"
                            [attr.aria-label]="'Editar pedido ' + element.IdPed">
                            <i class="fas fa-edit fa-2x" aria-hidden="true"></i>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
        </mat-tab>


    </mat-tab-group>

    <!-- === DETALLE DE PEDIDO === -->
    <div class="container-fluid d-flex flex-column" *ngIf="detallePedido">
        <div class="container-fluid d-flex">
            <!-- Info de pagos -->
            <div class="container d-flex flex-column align-items-start border border-primary rounded p-4 m-2">
                <h2>Informacion de Pagos</h2>
                <mat-form-field appearance="fill">
                    <mat-label>Costo Total</mat-label>
                    <input matInput disabled [(ngModel)]="monto.total" [attr.aria-label]="'Costo Total'">
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Monto Abonado</mat-label>
                    <input matInput disabled [(ngModel)]="monto.abonado" [attr.aria-label]="'Monto Abonado'">
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Saldo Pendiente</mat-label>
                    <input matInput disabled [(ngModel)]="monto.pendiente" [attr.aria-label]="'Saldo Pendiente'">
                </mat-form-field>
            </div>

            <!-- Registrar pago -->
            <div class="container d-flex flex-column align-items-start border border-primary rounded p-4 m-2">
                <h2>Registro de Pago</h2>
                <mat-spinner *ngIf="loadingFile" diameter="40" [attr.aria-label]="'Cargando'"></mat-spinner>

                <div *ngIf="!loadingFile" class="container d-flex flex-column align-items-start">
                    <span class="caption" *ngIf="excesoError" style="color:red">{{ excesoError }}</span>
                    <span class="caption" *ngIf="montoError" style="color:red">{{ montoError }}</span>

                    <mat-form-field appearance="fill">
                        <mat-label>Monto</mat-label>
                        <input matInput type="number" step="1" [(ngModel)]="montoAbonado"
                            (ngModelChange)="onMontoChange()" (keydown)="blockDecimal($event)" required
                            [attr.aria-label]="'Monto a registrar'">
                    </mat-form-field>

                    <mat-form-field appearance="fill">
                        <mat-label>Estado</mat-label>
                        <input matInput disabled [(ngModel)]="estado" [attr.aria-label]="'Estado del Voucher'">
                    </mat-form-field>

                    <span class="caption" *ngIf="metodoError" style="color:red">{{ metodoError }}</span>
                    <mat-form-field appearance="fill">
                        <mat-label>Metodos de Pago</mat-label>
                        <mat-select [ngModel]="metodoPago" (ngModelChange)="onMetodoChange($event)" required>
                            <mat-option *ngFor="let metodo of metodosPago" [value]="metodo.idMetodoPago">
                                {{ metodo.nombre }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <span class="caption" *ngIf="fileError" style="color:red">{{ fileError }}</span>
                    <input type="file" (change)="onFileSelected($event)"
                        [attr.accept]="isVoucherRequired ? '.png,.jpg,.jpeg' : null" [required]="isVoucherRequired"
                        [disabled]="loadingFile || !isVoucherRequired" [hidden]="!isVoucherRequired"
                        [attr.aria-label]="'Adjuntar voucher'">

                    <div class="container p-0 my-4">
                        <button mat-raised-button color="primary" type="button" (click)="uploadFile()"
                            [disabled]="!canSubmit || loadingFile">
                            Registrar
                        </button>

                        <small class="text-muted">
                            canSubmit={{ canSubmit }}
                            | monto={{ montoAbonado }}
                            | pendiente={{ monto.pendiente }}
                            | metodo={{ metodoPago }}
                            | file={{ !!selectedFile }}
                            | loading={{ loadingFile }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vouchers -->
        <div class="container-fluid p-4">
            <table mat-table [dataSource]="vouchersPago" class="table" aria-label="Vouchers del Pedido">
                <!-- <ng-container matColumnDef="Codigo">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Codigo</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Codigo }}</td>
                </ng-container> -->

                <ng-container matColumnDef="Fecha">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Fecha</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Fecha | date:'dd-MM-yyyy' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="Monto">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Monto</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.Monto }}</td>
                </ng-container>

                <ng-container matColumnDef="Metodo">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Metodo</th>
                    <td mat-cell *matCellDef="let element" class="text-center">{{ element.MetodoPago }}</td>
                </ng-container>

                <ng-container matColumnDef="Imagen">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Imagen</th>
                    <td mat-cell *matCellDef="let element" class="text-center">
                        <button *ngIf="element.MetodoPago !== 'Efectivo'" class="btn" type="button"
                            (click)="onOpenImgClick($event, element.Codigo)">
                            <i class="fas fa-image fa-2x" aria-hidden="true"></i>
                        </button>
                        <span *ngIf="element.MetodoPago === 'Efectivo'" class="text-muted">
                            –
                        </span>

                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns2"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns2"></tr>
            </table>
        </div>

        <div class="container-fluid d-flex justify-content-center">
            <button mat-raised-button color="warn" type="button" (click)="mostrarListado()">Atras</button>
        </div>
    </div>
</div>