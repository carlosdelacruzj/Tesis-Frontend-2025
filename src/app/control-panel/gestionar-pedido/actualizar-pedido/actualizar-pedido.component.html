<div class="dashboard-content" [class.is-saving]="saving">
  <app-list-toolbar [title]="'Actualizar pedido'" [showSearch]="false" [showCreateButton]="false">
  </app-list-toolbar>

  <form class="cotizacion-form" #EmpleadoForm="ngForm">
    <div class="row g-3 card-grid">
      <div class="col-md-6">
        <mat-card class="card">
          <mat-card-header>
            <mat-card-title>Datos del solicitante</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="form-group">
              <label class="col-form-label" for="clienteNombreCompleto">Nombre completo</label>
              <input id="clienteNombreCompleto" type="text" class="form-control"
                [value]="clienteNombreCompleto" placeholder="Nombre y apellidos" disabled>
            </div>
            <div class="form-group">
              <label class="col-form-label" for="clienteCelular">WhatsApp / contacto</label>
              <input id="clienteCelular" type="text" class="form-control" [value]="clienteCelular"
                placeholder="Ej. 999 999 999" disabled>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="col-md-6">
        <mat-card class="card">
          <mat-card-header>
            <mat-card-title>Detalles del evento</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="col-form-label" for="pedidoNombre">Pedido</label>
                  <input id="pedidoNombre" type="text" class="form-control" name="NombrePedido"
                    [(ngModel)]="visualizarService.selectAgregarPedido.NombrePedido"
                    #pedidoNombre="ngModel" required
                    [class.is-invalid]="pedidoNombre.invalid && pedidoNombre.touched">
                  @if (pedidoNombre.invalid && pedidoNombre.touched) {
                  <small class="text-danger">
                    Ingresa el nombre del pedido.
                  </small>
                  }
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="col-form-label" for="departamentoPedido">Departamento</label>
                  <select id="departamentoPedido" class="form-control" name="departamentoPedido"
                    [(ngModel)]="visualizarService.selectAgregarPedido.departamento"
                    (ngModelChange)="onDepartamentoChange($event)" #departamentoPedido="ngModel" required
                    [class.is-invalid]="departamentoPedido.invalid && departamentoPedido.touched">
                    <option value="">Selecciona un departamento</option>
                    @for (dep of departamentos; track dep) {
                    <option [value]="dep">{{ dep }}</option>
                    }
                  </select>
                  @if (departamentoPedido.invalid && departamentoPedido.touched) {
                  <small class="text-danger">
                    Selecciona el departamento del evento.
                  </small>
                  }
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="col-form-label" for="eventoSelect">Tipo de evento</label>
                  <select id="eventoSelect" class="form-control"
                    [value]="(eventoSeleccionado ?? '').toString()"
                    (change)="onEventoDropdownChange($event)" (blur)="eventoSelectTouched = true"
                    [disabled]="!evento.length"
                    [ngClass]="{'is-invalid': eventoSelectTouched && !eventoSeleccionado}">
                    <option value="" disabled>Selecciona un tipo de evento</option>
                    @for (e of evento; track e.id !== null && e.id !== undefined ? e.id : $index) {
                    <option [value]="(e.id ?? '').toString()" [selected]="e.id === eventoSeleccionado">
                      {{ e.nombre }}
                    </option>
                    }
                  </select>
                  @if (eventoSelectTouched && !eventoSeleccionado) {
                  <small class="text-danger">
                    Selecciona un tipo de evento.
                  </small>
                  }
                </div>
              </div>

            </div>

            <div class="row g-3 mt-1">
              <div [ngClass]="shouldShowFechaEvento() ? 'col-md-4' : 'col-md-6'">
                <div class="form-group">
                  <label class="col-form-label" for="diasTrabajo">Cantidad de días</label>
                  <input id="diasTrabajo" type="number" class="form-control" name="diasTrabajo"
                    [(ngModel)]="visualizarService.selectAgregarPedido.dias"
                    (ngModelChange)="onDiasChange($event)" min="1" step="1" inputmode="numeric"
                    pattern="^[0-9]+$" #diasTrabajo="ngModel" required
                    [class.is-invalid]="diasTrabajo.invalid && diasTrabajo.touched">
                  @if (diasTrabajo.hasError('required') && diasTrabajo.touched) {
                  <small class="text-danger">
                    Ingresa la cantidad de días.
                  </small>
                  }
                  @if (diasTrabajo.hasError('pattern') && diasTrabajo.touched) {
                  <small class="text-danger">
                    Usa solo números enteros.
                  </small>
                  }
                  @if (diasTrabajo.hasError('min') && diasTrabajo.touched) {
                  <small class="text-danger">
                    Ingresa un número mayor a 0.
                  </small>
                  }
                </div>
              </div>

              @if (shouldShowFechaEvento()) {
              <div class="col-md-4">
                <div class="form-group">
                  <label class="col-form-label" for="fechaEvent">Fecha del evento</label>
                  <input id="fechaEvent" type="date" class="form-control"
                    [min]="fechaMinimaEvento" [max]="fechaMaximaEvento"
                    name="fechaEvent" [(ngModel)]="visualizarService.selectAgregarPedido.fechaEvent"
                    #fechaEvent="ngModel"
                    [class.is-invalid]="!!getFechaEventoError() && fechaEvent.touched" required>
                  @if (getFechaEventoError() && fechaEvent.touched) {
                  @if (getFechaEventoError() === 'required') {
                  <small class="text-danger">Selecciona una fecha.</small>
                  }
                  @if (getFechaEventoError() === 'fechaEventoAnterior') {
                  <small class="text-danger">La fecha debe ser al menos un día después de hoy.</small>
                  }
                  @if (getFechaEventoError() === 'fechaEventoPosterior') {
                  <small class="text-danger">La fecha no puede superar los 6 meses desde hoy.</small>
                  }
                  @if (getFechaEventoError() === 'fechaEventoInvalida') {
                  <small class="text-danger">Selecciona una fecha válida.</small>
                  }
                  }
                </div>
              </div>
              }

              <div [ngClass]="shouldShowFechaEvento() ? 'col-md-4' : 'col-md-6'">
                <div class="form-group">
                  <label class="col-form-label" for="horasEstimadas">Horas estimadas por día</label>
                  <input id="horasEstimadas" type="number" class="form-control" name="horasEstimadas"
                    [(ngModel)]="visualizarService.selectAgregarPedido.horasEstimadas"
                    min="1" step="1" inputmode="numeric" pattern="^[0-9]+$"
                    #horasEstimadas="ngModel" required
                    [class.is-invalid]="horasEstimadas.invalid && horasEstimadas.touched">
                  @if (horasEstimadas.hasError('required') && horasEstimadas.touched) {
                  <small class="text-danger">
                    Ingresa las horas estimadas por día.
                  </small>
                  }
                  @if (horasEstimadas.hasError('pattern') && horasEstimadas.touched) {
                  <small class="text-danger">
                    Usa solo números enteros.
                  </small>
                  }
                  @if (horasEstimadas.hasError('min') && horasEstimadas.touched) {
                  <small class="text-danger">
                    Ingresa un número mayor a 0.
                  </small>
                  }
                </div>
              </div>
            </div>

          </mat-card-content>
            </mat-card>

      </div>

      <div class="col-12">
        <mat-card class="card mb-3">
          <mat-card-header class="programacion-header">
            <mat-card-title>Programación del evento</mat-card-title>
            <mat-card-subtitle>
              Define las locaciones clave y los horarios estimados. Siempre considera al menos {{
              programacionMinimaRecomendada }} puntos principales.
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <div class="programacion-list">
              @for (item of ubicacion; track $index) {
                <div class="programacion-item">
                  <div class="programacion-item__header d-flex align-items-center justify-content-between gap-2">
                    <h4 class="mb-0">{{ item.Direccion || ('Locación ' + ($index + 1)) }}</h4>
                    <button type="button" class="btn btn-link btn-sm text-danger"
                      (click)="deleteElement(item.Direccion, item.Hora)"
                      [disabled]="ubicacion.length <= 1"
                      [attr.aria-label]="'Eliminar locación ' + (item.Direccion || ('Locación ' + ($index + 1)))"
                      [attr.title]="ubicacion.length <= 1 ? 'Mantén al menos una locación' : 'Eliminar locación'">
                      Eliminar
                    </button>
                  </div>

                  <div class="row g-3 mt-2">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="col-form-label" [attr.for]="'programacionNombre' + $index">Nombre de la locación</label>
                        <input [attr.id]="'programacionNombre' + $index" type="text" class="form-control"
                          [(ngModel)]="item.Direccion" [ngModelOptions]="{standalone:true}"
                          placeholder="Ej. Recepción en casona">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="col-form-label" [attr.for]="'programacionDireccion' + $index">Dirección o punto de encuentro</label>
                        <input [attr.id]="'programacionDireccion' + $index" type="text" class="form-control"
                          [(ngModel)]="item.DireccionExacta" [ngModelOptions]="{standalone:true}"
                          placeholder="Ej. Av. La Marina 1234">
                      </div>
                    </div>
                    <div class="col-sm-6 col-md-3">
                      <div class="form-group">
                        <label class="col-form-label" [attr.for]="'programacionFecha' + $index">Fecha</label>
                        <input [attr.id]="'programacionFecha' + $index" type="date" class="form-control"
                          [(ngModel)]="item.Fecha" [ngModelOptions]="{standalone:true}"
                          (ngModelChange)="onUbicacionFechaChange(item, $event)"
                          [min]="fechaMinimaEvento" [max]="fechaMaximaEvento">
                      </div>
                    </div>
                    <div class="col-sm-6 col-md-3">
                      <div class="form-group">
                        <label class="col-form-label" [attr.for]="'programacionHora' + $index">Hora</label>
                        <div class="d-flex gap-2">
                          <select class="form-select" [(ngModel)]="item.hora12" [ngModelOptions]="{standalone:true}"
                            (ngModelChange)="syncHora(item)">
                            <option [ngValue]="null" disabled>Hora</option>
                            @for (hora of horaOptions; track hora) {
                              <option [ngValue]="hora">{{ hora }}</option>
                            }
                          </select>
                          <select class="form-select" [(ngModel)]="item.minuto" [ngModelOptions]="{standalone:true}"
                            (ngModelChange)="syncHora(item)">
                            <option [ngValue]="null" disabled>Min</option>
                            @for (minuto of minutoOptions; track minuto) {
                              <option [ngValue]="minuto">{{ minuto }}</option>
                            }
                          </select>
                          <select class="form-select" [(ngModel)]="item.ampm" [ngModelOptions]="{standalone:true}"
                            (ngModelChange)="syncHora(item)">
                            <option [ngValue]="null" disabled>AM/PM</option>
                            @for (meridiem of ampmOptions; track meridiem) {
                              <option [ngValue]="meridiem">{{ meridiem }}</option>
                            }
                          </select>
                        </div>
                        <input type="hidden" [(ngModel)]="item.Hora" [ngModelOptions]="{standalone:true}">
                        @if ((item.hora12 == null || item.minuto == null || item.ampm == null)
                          && (item.hora12 != null || item.minuto != null || item.ampm != null)) {
                          <small class="text-danger">
                            Ingresa la hora.
                          </small>
                        }
                        @if (isHoraFueraRango(item)) {
                          <small class="text-danger">
                            La hora debe estar entre 06:00 y 22:00.
                          </small>
                        }
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group mb-0">
                        <label class="col-form-label" [attr.for]="'programacionNotas' + $index">Notas internas</label>
                        <textarea [attr.id]="'programacionNotas' + $index" class="form-control" rows="2"
                          [(ngModel)]="item.Notas" [ngModelOptions]="{standalone:true}"
                          placeholder="Detalles adicionales para el equipo (opcional)"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>

            <div class="text-end mt-3">
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="onQuickAdd()"
                [disabled]="!canAgregarEvento">
                Agregar locación
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="col-12">
        <mat-card class="card mb-3">
          <mat-card-header>
            <mat-card-title>Servicios y paquetes</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="col-form-label" for="servicioSelect">Servicio</label>
                  <select id="servicioSelect" class="form-control"
                    [value]="(servicioSeleccionado ?? '').toString()"
                    (change)="asignarServicio($any($event.target).value)">
                    <option value="" disabled>Selecciona un servicio</option>
                    @for (s of servicios; track s.id !== null && s.id !== undefined ? s.id : $index) {
                      <option [value]="(s.id ?? '').toString()" [selected]="s.id === servicioSeleccionado">
                        {{ s.nombre }}
                      </option>
                    }
                  </select>
                </div>
              </div>
            </div>

            @if (!loadingPaquetes) {
              <div class="table-responsive">
                <app-table-base
                  [columns]="paquetesColumns"
                  [data]="paquetesRows"
                  [showSearch]="false"
                  [showFooterInfo]="false"
                  [showPagination]="false"
                  [showPageSizeSelector]="false"
                  [showCreateButton]="false"
                  [pageSize]="paquetesRows.length || 10"
                  [pageSizeOptions]="[paquetesRows.length || 10]"
                  emptyText="Sin paquetes disponibles">

                  <ng-template appCell="titulo" let-row>
                    {{ row.titulo || '—' }}
                  </ng-template>

                  <ng-template appCell="precio" let-row>
                    {{ row.precio | usd:'1.2-2' }}
                  </ng-template>

                  <ng-template appCell="staff" let-row>
                    {{ row.staff !== null ? row.staff : '—' }}
                  </ng-template>

                  <ng-template appCell="horas" let-row>
                    {{ row.horas !== null ? row.horas : '—' }}
                  </ng-template>

                  <ng-template appCell="acciones" let-row>
                    <div class="d-flex justify-content-center gap-2">
                      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="mostrarDetallePaquete(row)">
                        Mostrar
                      </button>
                      @if (!isInSeleccion(row.raw)) {
                        <button type="button" class="btn btn-outline-primary btn-sm"
                          [ngClass]="{'btn-outline-warning': hasOtroPaqueteDelServicio(row.raw)}"
                          (click)="addPaquete(row.raw)">
                          {{ hasOtroPaqueteDelServicio(row.raw) ? 'Reemplazar' : 'Agregar' }}
                        </button>
                      } @else {
                        <button type="button" class="btn btn-outline-danger btn-sm"
                          (click)="removePaquete(pkgKey(row.raw))">
                          Quitar
                        </button>
                      }
                    </div>
                  </ng-template>

                </app-table-base>
              </div>
            } @else {
              <div class="d-flex flex-column align-items-center justify-content-center py-4 text-muted">
                <mat-spinner diameter="32"></mat-spinner>
                <span class="mt-2">Cargando paquetes…</span>
              </div>
            }

            @if (selectedPaquetes.length) {
              <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between">
                  <h6>Paquetes seleccionados ({{ selectedPaquetes.length }})</h6>
                  @if (isMultipleDias()) {
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="abrirAsignacionFechas()">
                    Asignar fechas
                  </button>
                  }
                </div>
                <div class="table-responsive">
                  <app-table-base [columns]="selectedPaquetesColumns" [data]="selectedPaquetes" [showSearch]="false"
                    [showFooterInfo]="false" [showPagination]="false" [showPageSizeSelector]="false"
                    [showCreateButton]="false" [pageSize]="selectedPaquetes.length || 10"
                    [pageSizeOptions]="[selectedPaquetes.length || 10]" emptyText="Sin paquetes seleccionados">

                    <ng-template appCell="titulo" let-row>
                      {{ row.titulo }}
                    </ng-template>

                    <ng-template appCell="cantidad" let-row>
                      <div class="text-center qty-select-wrap">
                        <mat-form-field appearance="outline" class="qty-mat-field">
                          <mat-select
                            [ngModel]="row.cantidad || 1"
                            [ngModelOptions]="{standalone:true}"
                            (ngModelChange)="onCantidadChange(row, $event)"
                            panelClass="qty-mat-panel">
                            @for (cantidad of getCantidadOptions(); track cantidad) {
                              <mat-option [value]="cantidad" class="qty-mat-option">{{ cantidad }}</mat-option>
                            }
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </ng-template>

                    <ng-template appCell="precioUnit" let-row>
                      <div class="text-end">
                        @if (!row.editandoPrecio) {
                          <button type="button" class="btn btn-link p-0 text-decoration-underline"
                            (click)="enablePrecioEdit(row)" title="Haz clic para editar">
                            {{ row.precio | usd:'1.2-2' }}
                          </button>
                        } @else {
                          <input type="number" class="form-control form-control-sm text-end" [id]="getPrecioInputId(row)"
                            [value]="row.precio" step="0.01" [attr.min]="getPrecioMinimo(row)"
                            (blur)="confirmPrecioEdit(row, $any($event.target).value)"
                            (keydown.enter)="confirmPrecioEdit(row, $any($event.target).value)"
                            (keydown.escape)="cancelPrecioEdit(row)">
                          <small class="text-muted">Mínimo: {{ getPrecioMinimo(row) | number:'1.2-2' }}</small>
                        }
                      </div>
                    </ng-template>

                    <ng-template appCell="precioOriginal" let-row>
                      <div class="text-end">
                        <div>{{ row.precioOriginal | usd:'1.2-2' }}</div>
                        @if (getDescuentoPorcentaje(row) !== null) {
                          <div class="text-success small">
                            −{{ getDescuentoPorcentaje(row) | number:'1.0-1' }}%
                          </div>
                        }
                      </div>
                    </ng-template>

                    <ng-template appCell="horas" let-row>
                      <div class="text-center">{{ row.horas ?? '—' }}</div>
                    </ng-template>

                    <ng-template appCell="staff" let-row>
                      <div class="text-center">{{ row.personal ?? '—' }}</div>
                    </ng-template>

                    <ng-template appCell="subtotal" let-row>
                      <div class="text-end">{{ (row.precio * (row.cantidad || 1)) | usd:'1.2-2' }}</div>
                    </ng-template>

                    <ng-template appCell="notas" let-row>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.notas"
                        [ngModelOptions]="{standalone:true}" maxlength="200" placeholder="Notas opcionales">
                    </ng-template>

                    <ng-template appCell="quitar" let-row>
                      <button type="button" class="btn btn-link text-danger p-0" (click)="removePaquete(row.key)">✖</button>
                    </ng-template>

                  </app-table-base>
                </div>
                <div class="text-end mt-2">
                  <strong>Subtotal paquetes: {{ totalPaquetes | usd:'1.2-2' }}</strong>
                </div>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <div class="col-12">
        @if (!isDepartamentoLima()) {
        <mat-card class="card mb-3">
          <mat-card-header>
            <mat-card-title>Viáticos</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="form-check mb-3">
              <input id="viaticosClientePedido" type="checkbox" class="form-check-input"
                name="viaticosClientePedido"
                [(ngModel)]="visualizarService.selectAgregarPedido.viaticosCliente"
                (ngModelChange)="onViaticosClienteChange($event)">
              <label class="form-check-label" for="viaticosClientePedido">El cliente cubre viáticos</label>
            </div>
            @if (!visualizarService.selectAgregarPedido.viaticosCliente) {
            <div class="form-group">
              <label class="col-form-label" for="viaticosMontoPedido">Monto de viáticos (USD)</label>
              <input id="viaticosMontoPedido" type="number" class="form-control"
                name="viaticosMontoPedido"
                [(ngModel)]="visualizarService.selectAgregarPedido.viaticosMonto" min="1" step="1"
                (blur)="onViaticosMontoBlur($any($event.target).value)"
                inputmode="numeric">
            </div>
            }
          </mat-card-content>
        </mat-card>
        }
      </div>

      <div class="col-12">
        <mat-card class="card mb-3">
          <mat-card-header>
            <mat-card-title>Mensaje del solicitante</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <textarea class="form-control" rows="3" name="Observacion"
              [(ngModel)]="visualizarService.selectAgregarPedido.Observacion"
              placeholder="Mensaje proporcionado en la solicitud"></textarea>
          </mat-card-content>
        </mat-card>
      </div>

    </div>

    <div class="row mb-3">
      <div class="col-md-4 ms-auto">
        <small class="d-block text-end text-muted mt-1">Subtotal: {{ subtotalSinIgv | usd:'1.2-2' }}</small>
        <small class="d-block text-end text-muted">IGV (18%): {{ igvMonto | usd:'1.2-2' }}</small>
        <label class="col-form-label mt-2" for="totalEstimado">Total final</label>
        <div class="input-group">
          <span class="input-group-text">US$</span>
          <input id="totalEstimado" type="number" class="form-control" [value]="totalConIgv" disabled>
        </div>
      </div>
    </div>

    <div class="text-end">
      <button type="button" class="btn btn-outline-secondary me-2" [routerLink]="['/home/gestionar-pedido']"
        [disabled]="saving">Cancelar</button>
      <button type="button" class="btn btn-primary" [disabled]="saving" (click)="updatePedido()">
        @if (!saving) {
          <span>Guardar cambios</span>
        }
        @if (saving) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
      </button>
    </div>
  </form>
</div>

<app-modal-base [open]="detallePaqueteAbierto" [disableClose]="false" [loading]="false" [useDefaultFooter]="false"
  size="lg" title="Detalle del paquete" (closed)="cerrarDetallePaquete()">

  @if (detallePaqueteSeleccionado) {
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label" for="detallePaqueteTituloEdit">Título</label>
        <input id="detallePaqueteTituloEdit" class="form-control" [value]="detallePaqueteSeleccionado?.titulo ?? '—'"
          disabled>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="detallePaquetePrecioEdit">Precio</label>
        <input id="detallePaquetePrecioEdit" class="form-control"
          [value]="(detallePaqueteSeleccionado?.precio ?? 0) | usd:'1.0-0'" disabled>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="detallePaqueteHorasEdit">Horas</label>
        <input id="detallePaqueteHorasEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.horas ?? '—'" disabled>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="detallePaqueteServicioEdit">Servicio</label>
        <input id="detallePaqueteServicioEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.servicioNombre ?? detallePaqueteSeleccionado?.servicio?.nombre ?? '—'"
          disabled>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="detallePaqueteCategoriaEdit">Categoría</label>
        <input id="detallePaqueteCategoriaEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.categoriaNombre ?? detallePaqueteSeleccionado?.categoriaTipo ?? '—'"
          disabled>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="detallePaqueteTipoEdit">Tipo de paquete</label>
        <input id="detallePaqueteTipoEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.esAddon ? 'Add-on' : 'Paquete principal'" disabled>
      </div>
      <div class="col-12">
        <label class="form-label" for="detallePaqueteDescripcionEdit">Descripción</label>
        <textarea id="detallePaqueteDescripcionEdit" class="form-control" rows="3"
          [value]="detallePaqueteSeleccionado?.descripcion || '—'" disabled></textarea>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="detallePaqueteFotosEdit">Fotos impresas</label>
        <input id="detallePaqueteFotosEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.fotosImpresas ?? '—'" disabled>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="detallePaqueteTrailerEdit">Trailer (min)</label>
        <input id="detallePaqueteTrailerEdit" class="form-control"
          [value]="detallePaqueteSeleccionado?.trailerMin ?? '—'" disabled>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="detallePaqueteFilmEdit">Filmación (min)</label>
        <input id="detallePaqueteFilmEdit" class="form-control" [value]="detallePaqueteSeleccionado?.filmMin ?? '—'"
          disabled>
      </div>
      <div class="col-12">
        <div class="form-label">Staff</div>
        <div class="form-control" style="height: auto;" disabled>
          {{ getDetalleStaffTotal(detallePaqueteSeleccionado) }}
          @if (getDetalleStaffLista(detallePaqueteSeleccionado).length) {
            <div class="small text-muted">
              @for (miembro of getDetalleStaffLista(detallePaqueteSeleccionado); track $index) {
                <div>
                  {{ (miembro?.rol ?? miembro?.nombre ?? miembro?.puesto ?? 'Rol') }}
                  @if (miembro?.cantidad) {
                    <span>({{ miembro?.cantidad }})</span>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
      @if (getEquiposLista(detallePaqueteSeleccionado).length) {
        <div class="col-12">
          <div class="form-label">Equipamiento requerido</div>
          <ul class="list-group">
            @for (eq of getEquiposLista(detallePaqueteSeleccionado); track $index) {
              <li class="list-group-item py-2">
                <div class="fw-semibold">{{ eq?.tipoEquipo ?? eq?.tipo }}</div>
                <div class="small text-muted">
                  @if (eq?.cantidad) {
                    <span>Cantidad: {{ eq?.cantidad }}</span>
                  }
                  @if (eq?.notas) {
                    <span class="ms-2">({{ eq?.notas }})</span>
                  }
                </div>
              </li>
            }
          </ul>
        </div>
      }
    </div>
  } @else {
    <p class="text-muted mb-0">Selecciona un paquete para ver el detalle.</p>
  }

  <div modal-footer class="d-flex justify-content-end">
    <button type="button" class="btn btn-outline-secondary" (click)="cerrarDetallePaquete()">Cerrar</button>
  </div>
</app-modal-base>

<app-modal-base [open]="asignacionFechasAbierta" [disableClose]="false" [loading]="false" [useDefaultFooter]="false"
  size="lg" title="Asignar fechas a servicios" (closed)="cerrarAsignacionFechas()">

  @if (!fechasDisponibles.length) {
  <p class="text-muted mb-0">No hay fechas disponibles para asignar.</p>
  } @else {
  <p class="text-muted mb-2">Selecciona las fechas de trabajo por servicio. Deben coincidir con la cantidad.</p>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Servicio</th>
          @for (fecha of fechasDisponibles; track fecha) {
          <th class="text-center">{{ formatFechaConDia(fecha) }}</th>
          }
          <th class="text-center">Asignadas</th>
        </tr>
      </thead>
      <tbody>
        @for (item of selectedPaquetes; track item.key) {
        <tr>
          <td>
            <div class="fw-semibold">{{ item.titulo }}</div>
            <div class="small text-muted">Cantidad: {{ item.cantidad || 1 }}</div>
          </td>
          @for (fecha of fechasDisponibles; track fecha) {
          <td class="text-center">
            <input type="checkbox" class="form-check-input"
              [checked]="isFechaAsignada(item.tmpId, fecha)"
              [disabled]="!isFechaAsignada(item.tmpId, fecha) && getCantidadAsignada(item.tmpId) >= (item.cantidad || 1)"
              (change)="toggleFechaAsignada(item.tmpId, fecha, $any($event.target).checked, item.cantidad || 1)">
          </td>
          }
          <td class="text-center">
            {{ getCantidadAsignada(item.tmpId) }}/{{ item.cantidad || 1 }}
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  <div modal-footer class="d-flex justify-content-end">
    <button type="button" class="btn btn-outline-secondary" (click)="cerrarAsignacionFechas()">Cerrar</button>
  </div>
</app-modal-base>
