<div class="dashboard-ecommerce">
  <div class="container-fluid dashboard-content ">
    <h1>Actualizar pedido</h1>

    <form #EmpleadoForm="ngForm">
      <div class="row">
        <div class="col">
          <mat-card class="card">
            <mat-card-header>
              <mat-card-title>Datos del pedido</mat-card-title>
            </mat-card-header>
            <mat-card-content class="card-body">
              <div class="form-group">
                <label class='col-form-label'>Pedido</label>
                <input type="text" class="form-control" name="NombrePedido"
                  [(ngModel)]="visualizarService.selectAgregarPedido.NombrePedido" required>
              </div>

              <div class="form-group">
                <label class='col-form-label'>Empleado</label>
                <input type="text" name="CodigoEmpleado" [(ngModel)]="CodigoEmpleado" class="form-control" disabled>
              </div>

              <div class="form-group">
                <label class='col-form-label'>Fecha de registro</label>
                <input type="text" class="form-control" name="fechaCreate"
                  [(ngModel)]="visualizarService.selectAgregarPedido.fechaCreate" disabled>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="col ms-auto">
          <mat-card class="card">
            <mat-card-header>
              <mat-card-title>Datos del cliente</mat-card-title>
            </mat-card-header>
            <mat-card-content class="card-body">
              <div class="form-group">
                <label class='col-form-label'>Documento de identidad</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" name="dni" [(ngModel)]="dniCliente" disabled>
                  <!-- <div class="input-group-append">
                    <button (click)="buscarCliente(dniCliente)" type="button"
                            class="btn btn-danger">Buscar</button>
                  </div> -->
                </div>
              </div>
              <div class="form-group">
                <label class='col-form-label'>Nombres</label>
                <input type="text" class="form-control" name="nombre" [(ngModel)]="infoCliente.nombre" disabled>
              </div>
              <div class="form-group">
                <label class='col-form-label'>Apellidos</label>
                <input type="text" class="form-control" name="Apellido" [(ngModel)]="infoCliente.apellido" disabled>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <mat-card class="card">
        <mat-card-header>
          <mat-card-title>Programación del evento</mat-card-title>
        </mat-card-header>

        <mat-card-content class="card-body">
          <div class="row">
            <div class="col ms-auto">
              <div class="form-group">
                <label class='col-form-label'>Hora</label>
                <input type="time" class="form-control" name="horaEvent"
                  [(ngModel)]="visualizarService.selectAgregarPedido.horaEvent" required>
              </div>
            </div>
            <div class="col ms-auto">
              <div class="form-group">
                <label class='col-form-label'>Fecha</label>
                <input type="date" class="form-control" [min]="minimo" [max]="maximo" name="fechaEvent"
                  [(ngModel)]="visualizarService.selectAgregarPedido.fechaEvent" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col ms-auto">
              <div class="form-group">
                <label class='col-form-label'>Ubicacion</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" name="Direc" [(ngModel)]="Direccion" autocomplete="off"
                    (keyup.enter)="onQuickAdd()">
                  <div class="input-group-append"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-2" *ngIf="tagsPedido.length">
            <div class="col">
              <span class="me-2">Tags:</span>
              <ng-container *ngFor="let t of tagsPedido">
                <button type="button" class="btn btn-light btn-sm me-2" title="{{t.direccion}}" (click)="applyTag(t)">
                  {{ t.nombre }}
                </button>
                <button type="button" class="btn btn-link text-danger p-0 me-3" title="Eliminar tag"
                  (click)="removeTag(t,'pedido')">✖</button>
              </ng-container>
            </div>
          </div>

          <div class="row mt-2">
            <div class="col ms-auto">
              <div class="form-group">
                <label class="col-form-label">Dirección exacta</label>
                <input type="text" class="form-control" name="DireccionExacta" [(ngModel)]="DireccionExacta"
                  autocomplete="off">
              </div>
            </div>
            <div class="col ms-auto">
              <div class="form-group">
                <label class="col-form-label">Notas</label>
                <input type="text" class="form-control" name="NotasEvento" [(ngModel)]="NotasEvento" autocomplete="off">
              </div>
            </div>
          </div>

          <div class="row mt-2">
            <div class="col">
              <button type="button" class="btn btn-outline-primary btn-sm me-2" [disabled]="!canGuardarTag"
                (click)="saveTag('pedido')">Guardar como tag
              </button>
            </div>
          </div>

          <div class="row mt-2">
            <div class="col text-end">
              <button type="button" class="btn btn-danger" [disabled]="!canAgregarEvento"
                (click)="onQuickAdd()">Agregar</button>
            </div>
          </div>

          <div class="row">
            <table mat-table [dataSource]="dataSource" matSort #sortUbic="matSort" class="table" cdkDropList
              (cdkDropListDropped)="drop($event)">
              <ng-container matColumnDef="Nro">
                <th mat-header-cell *matHeaderCellDef> # </th>
                <td mat-cell *matCellDef="let element">
                  {{ (dataSource?.data?.indexOf(element) ?? 0) + 1 }}
                </td>
              </ng-container>

              <ng-container matColumnDef="Fecha">
                <th mat-header-cell *matHeaderCellDef> Fecha </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else fechaEdit">
                    {{ formatProgramDate(element.Fecha) }} ({{ weekdayPeru(element.Fecha) }})
                  </ng-container>
                  <ng-template #fechaEdit>
                    <input type="date" class="form-control form-control-sm" [(ngModel)]="element.Fecha"
                      [ngModelOptions]="{standalone:true}" required>
                    <small class="text-danger" *ngIf="!element.Fecha">Requerido</small>
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="Hora">
                <th mat-header-cell *matHeaderCellDef> Hora </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else horaEdit">
                    {{ element.Hora }}
                  </ng-container>
                  <ng-template #horaEdit>
                    <input type="time" class="form-control form-control-sm" [(ngModel)]="element.Hora"
                      [ngModelOptions]="{standalone:true}" required>
                    <small class="text-danger" *ngIf="!element.Hora">Requerido</small>
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="Direccion">
                <th mat-header-cell *matHeaderCellDef> Direccion </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else dirEdit">
                    {{ element.Direccion }}
                  </ng-container>
                  <ng-template #dirEdit>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="element.Direccion"
                      [ngModelOptions]="{standalone:true}" required>
                    <small class="text-danger" *ngIf="!element.Direccion">Requerido</small>
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="DireccionExacta">
                <th mat-header-cell *matHeaderCellDef> Dirección exacta </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else dexEdit">
                    {{ element.DireccionExacta }}
                  </ng-container>
                  <ng-template #dexEdit>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="element.DireccionExacta"
                      [ngModelOptions]="{standalone:true}" minlength="8" required>
                    <small class="text-danger" *ngIf="(element.DireccionExacta||'').trim().length < 8">
                      Mínimo 8 caracteres
                    </small>
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="Notas">
                <th mat-header-cell *matHeaderCellDef> Notas </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else notasEdit">
                    {{ element.Notas }}
                  </ng-container>
                  <ng-template #notasEdit>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="element.Notas" maxlength="255"
                      [ngModelOptions]="{standalone:true}">
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="Editar">
                <th mat-header-cell *matHeaderCellDef> Editar </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="!element.editing; else accionesEdit">
                    <button class="btn p-0" (click)="startEdit(element)">✏️ Editar</button>
                  </ng-container>
                  <ng-template #accionesEdit>
                    <button class="btn p-0 me-2" (click)="saveEdit(element)" [disabled]="rowInvalid(element)">💾
                      Guardar</button>
                    <button class="btn text-danger p-0" (click)="cancelEdit(element)">✖ Cancelar</button>
                  </ng-template>
                </td>
              </ng-container>

              <ng-container matColumnDef="Quitar">
                <th mat-header-cell *matHeaderCellDef> Quitar </th>
                <td mat-cell *matCellDef="let element">
                  <button class="btn mx-auto" style="background-color:transparent"
                    (click)="deleteElement(element.Direccion,element.Hora)">
                    <i class="fa fa-trash fa-2x"></i>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
              <tr mat-row *matRowDef="let row; columns: columnsToDisplay;" cdkDrag></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="card">
        <mat-card-header>
          <mat-card-title>Servicios disponibles</mat-card-title>
        </mat-card-header>
        <mat-card-content class="card-body">
          <div class="row">
            <div class="col ms-auto">
              <div class="form-group">
                <label class='col-form-label'>Servicio</label>
                <select type="text" class="form-control form-control-sm" name="servicio"
                  [(ngModel)]="servicioSeleccionado" (ngModelChange)="asignarServicio($event)" required>
                  <option *ngFor="let s of servicios" [value]="s.id">{{s.nombre}}</option>
                </select>
              </div>
            </div>
            <div class="col ms-auto">
              <div class="form-group">
                <label class='col-form-label'>Evento</label>
                <select type="text" class="form-control form-control-sm" name="evento" [(ngModel)]="eventoSeleccionado"
                  (ngModelChange)="asignarEvento($event)" required>
                  <option *ngFor="let e of evento" [value]="e.PK_E_Cod">{{e.E_Nombre}}</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <app-table-base-mejora
              [columns]="paquetesColumns"
              [data]="paquetesRows"
              [showSearch]="false"
              [showFooterInfo]="false"
              [showPagination]="false"
              [showPageSizeSelector]="false"
              [showCreateButton]="false"
              [pageSize]="paquetesRows.length || 10"
              [pageSizeOptions]="[paquetesRows.length || 10]"
              emptyText="Sin paquetes disponibles">

              <ng-template appCell="descripcion" let-row>
                {{ row.descripcion || '—' }}
              </ng-template>

              <ng-template appCell="precio" let-row>
                {{ row.precio != null ? (row.precio | number:'1.2-2') : '—' }}
              </ng-template>

              <ng-template appCell="staff" let-row>
                {{ row.staff != null ? row.staff : '—' }}
              </ng-template>

              <ng-template appCell="horas" let-row>
                {{ row.horas != null ? row.horas : '—' }}
              </ng-template>

              <ng-template appCell="acciones" let-row>
                <div class="d-flex justify-content-center">
                  <button type="button" class="btn btn-outline-primary btn-sm"
                    *ngIf="!isInSeleccion(row.raw); else quitarBtn" (click)="addPaquete(row.raw)">
                    Agregar
                  </button>
                  <ng-template #quitarBtn>
                    <button type="button" class="btn btn-outline-danger btn-sm"
                      (click)="removePaquete(pkgKey(row.raw))">
                      Quitar
                    </button>
                  </ng-template>
                </div>
              </ng-template>

            </app-table-base-mejora>
          </div>

          <div class="row mt-3" *ngIf="selectedPaquetes.length">
            <div class="col">
              <h6>Seleccionados ({{selectedPaquetes.length}})</h6>

              <app-table-base-mejora
                [columns]="selectedPaquetesColumns"
                [data]="selectedPaquetes"
                [showSearch]="false"
                [showFooterInfo]="false"
                [showPagination]="false"
                [showPageSizeSelector]="false"
                [showCreateButton]="false"
                [pageSize]="selectedPaquetes.length || 10"
                [pageSizeOptions]="[selectedPaquetes.length || 10]"
                emptyText="Sin paquetes seleccionados">

                <ng-template appCell="descripcion" let-row>
                  {{ row.descripcion }}
                </ng-template>

                <ng-template appCell="precio" let-row>
                  <div class="text-end">{{ row.precio | number:'1.2-2' }}</div>
                </ng-template>

                <ng-template appCell="cantidad">
                  <div class="text-center">1</div>
                </ng-template>

                <ng-template appCell="subtotal" let-row>
                  <div class="text-end">{{ row.precio | number:'1.2-2' }}</div>
                </ng-template>

                <ng-template appCell="notas" let-row>
                  <input type="text" class="form-control form-control-sm" placeholder="Notas del ítem (opcional)"
                    [(ngModel)]="row.notas" [ngModelOptions]="{standalone:true}" maxlength="255">
                </ng-template>

                <ng-template appCell="quitar" let-row>
                  <button type="button" class="btn btn-link text-danger p-0" title="Quitar"
                    (click)="removePaquete(row.key)">✖</button>
                </ng-template>

              </app-table-base-mejora>
              <div class="text-end mt-2">
                <strong>Total: {{ totalSeleccion | number:'1.2-2' }}</strong>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class='col-form-label'>Observaciones</label>
            <textarea type="text" class="form-control" name="Observacion" rows="5"
              [(ngModel)]="visualizarService.selectAgregarPedido.Observacion">
            </textarea>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="row" style="text-align: center;">
        <div class="col-6" style="text-align: right;">
          <!-- <button type="button" class="btn btn-outline-dark" (click)="updatePedido()">Actualizar</button> -->
          <button type="button" class="btn btn-outline-dark" [disabled]="saving" (click)="updatePedido()">
            Actualizar
          </button>
        </div>
        <div class="col-6" style="text-align: left;">
          <button type="button" class="btn btn-outline-dark" [routerLink]="['/home/gestionar-pedido']">Atrás</button>
        </div>
      </div>
    </form>
  </div>
</div>
