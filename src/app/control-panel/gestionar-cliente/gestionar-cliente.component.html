<div class="dashboard-content">

  <app-list-toolbar
    [title]="'Clientes'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: nombre, documento, correo…'"
    [searchValue]="searchTerm"
    [showCreateButton]="true"
    [createButtonLabel]="'Registrar cliente'"
    (searchChange)="onToolbarSearch($event)"
    (createClick)="navigateToCreate()">
  </app-list-toolbar>

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (!loadingList) {
    <app-table-base [columns]="columns" [data]="rows" [pageSizeOptions]="[10, 25, 50]" [pageSize]="10"
      emptyText="Sin resultados"
      (rowClick)="editarCliente($any($event))" (sortChange)="onSortChange($event)" (pageChange)="onPageChange($event)"
      [showCreateButton]="false" [showSearch]="false"
      [externalSearchTerm]="searchTerm">

      <ng-template appCell="codigoCliente" let-row>
        {{ row.codigo}}
      </ng-template>

      <ng-template appCell="correo" let-row>
        {{ row.correo || '—' }}
      </ng-template>

      <ng-template appCell="celular" let-row>
        {{ row.celular || '—' }}
      </ng-template>

      <ng-template appCell="doc" let-row>
        {{ row.doc || '—' }}
      </ng-template>

      <ng-template appCell="direccion" let-row>
        {{ row.direccion || '—' }}
      </ng-template>

      <ng-template appCell="acciones" let-row>
        <div class="d-flex justify-content-center gap-1">
          <button mat-icon-button color="primary" type="button" (click)="$event.stopPropagation(); editarCliente(row)"
            matTooltip="Editar">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
      </ng-template>

    </app-table-base>
  } @else {
    <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-3 mb-0">Cargando clientes…</p>
    </div>
  }

</div>

<app-modal-base
  [open]="modalRegistroOpen"
  title="Registrar cliente"
  [disableClose]="modalRegistroLoading"
  [loading]="modalRegistroLoading"
  [useDefaultFooter]="false"
  (closed)="onModalClosed()">

  <app-formulario-base
    [open]="modalRegistroOpen"
    [loading]="modalRegistroLoading"
    [loadingMessage]="'Preparando formulario…'"
    [error]="modalRegistroError">

    <form #createForm="ngForm" id="createClienteForm" (ngSubmit)="submitCreate(createForm)">

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label" for="clienteNombre">Nombre</label>
          <input id="clienteNombre" type="text" class="form-control" name="nombre" required
            [pattern]="nombrePattern" ngModel #nombre="ngModel">
          @if (nombre.invalid && (nombre.dirty || nombre.touched)) {
            <div class="invalid-feedback d-block">
              @if (nombre.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (nombre.errors?.pattern) {
                <span>Sólo letras (2-20)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="clienteApellido">Apellido</label>
          <input id="clienteApellido" type="text" class="form-control" name="apellido" required
            [pattern]="apellidoPattern" ngModel #apellido="ngModel">
          @if (apellido.invalid && (apellido.dirty || apellido.touched)) {
            <div class="invalid-feedback d-block">
              @if (apellido.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (apellido.errors?.pattern) {
                <span>Sólo letras (2-30)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="clienteCorreo">Correo</label>
          <input id="clienteCorreo" type="email" class="form-control" name="correo" required
            [pattern]="correoPattern" ngModel #correo="ngModel">
          @if (correo.invalid && (correo.dirty || correo.touched)) {
            <div class="invalid-feedback d-block">
              @if (correo.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (correo.errors?.pattern) {
                <span>Ingrese un correo válido</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="clienteDoc">Número de documento</label>
          <input id="clienteDoc" type="text" class="form-control" name="doc" required [pattern]="docPattern" ngModel
            #doc="ngModel">
          @if (doc.invalid && (doc.dirty || doc.touched)) {
            <div class="invalid-feedback d-block">
              @if (doc.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (doc.errors?.pattern) {
                <span>Sólo números (8 dígitos)</span>
              }
            </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="clienteCelular">Celular</label>
          <input id="clienteCelular" type="text" class="form-control" name="celular" required
            [pattern]="celularPattern" ngModel #celular="ngModel">
          @if (celular.invalid && (celular.dirty || celular.touched)) {
            <div class="invalid-feedback d-block">
              @if (celular.errors?.required) {
                <span>Campo requerido</span>
              }
              @if (celular.errors?.pattern) {
                <span>Sólo números (7-9 dígitos)</span>
              }
            </div>
          }
        </div>

        <div class="col-12">
          <label class="form-label" for="clienteDireccion">Dirección</label>
          <textarea id="clienteDireccion" class="form-control" name="direccion" required ngModel
            #direccion="ngModel"></textarea>
          @if (direccion.invalid && (direccion.dirty || direccion.touched)) {
            <div class="invalid-feedback d-block">
              <span>Campo requerido</span>
            </div>
          }
        </div>
      </div>
    </form>
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeCreateModal()"
      [disabled]="modalRegistroLoading">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" form="createClienteForm"
      [disabled]="modalRegistroLoading || createForm?.invalid">
      @if (modalRegistroLoading) {
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      }
      Registrar
    </button>
  </div>

</app-modal-base>

<app-modal-base
  [open]="modalEditarOpen"
  title="Editar cliente"
  [disableClose]="modalEditarLoading || modalEditarSaving"
  [loading]="modalEditarSaving"
  [useDefaultFooter]="false"
  (closed)="onEditModalClosed()">

  <app-formulario-base
    [open]="modalEditarOpen"
    [loading]="modalEditarLoading"
    [loadingMessage]="'Cargando cliente…'"
    [error]="!modalEditarLoading ? modalEditarError : null">

    @if (selectedCliente) {
      <form #editForm="ngForm" id="editClienteForm" (ngSubmit)="submitEdit(editForm)">

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label" for="editCodigoCliente">Código</label>
            <input id="editCodigoCliente" type="text" class="form-control" name="codigoCliente" readonly
              [value]="selectedCliente?.codigoCliente || ('CLI-' + selectedCliente?.idCliente)">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editNombreCliente">Nombre</label>
            <input id="editNombreCliente" type="text" class="form-control" name="nombre" readonly
              [value]="selectedCliente?.nombre || ''">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editApellidoCliente">Apellido</label>
            <input id="editApellidoCliente" type="text" class="form-control" name="apellido" readonly
              [value]="selectedCliente?.apellido || ''">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editCorreoCliente">Correo</label>
            <input id="editCorreoCliente" type="email" class="form-control" name="correo" required
              [pattern]="correoPattern" [(ngModel)]="editFormModel.correo" #correoEdit="ngModel">
            @if (correoEdit.invalid && (correoEdit.dirty || correoEdit.touched)) {
              <div class="invalid-feedback d-block">
                @if (correoEdit.errors?.required) {
                  <span>Campo requerido</span>
                }
                @if (correoEdit.errors?.pattern) {
                  <span>Ingrese un correo válido</span>
                }
              </div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editDocCliente">Número de documento</label>
            <input id="editDocCliente" type="text" class="form-control" name="doc" readonly
              [value]="selectedCliente?.doc || ''">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editCelularCliente">Celular</label>
            <input id="editCelularCliente" type="text" class="form-control" name="celular" required
              [pattern]="celularPattern" [(ngModel)]="editFormModel.celular" #celularEdit="ngModel">
            @if (celularEdit.invalid && (celularEdit.dirty || celularEdit.touched)) {
              <div class="invalid-feedback d-block">
                @if (celularEdit.errors?.required) {
                  <span>Campo requerido</span>
                }
                @if (celularEdit.errors?.pattern) {
                  <span>Sólo números (7-9 dígitos)</span>
                }
              </div>
            }
          </div>

          <div class="col-12">
            <label class="form-label" for="editDireccionCliente">Dirección</label>
            <textarea id="editDireccionCliente" class="form-control" name="direccion" required
              [(ngModel)]="editFormModel.direccion" #direccionEdit="ngModel"></textarea>
            @if (direccionEdit.invalid && (direccionEdit.dirty || direccionEdit.touched)) {
              <div class="invalid-feedback d-block">
                <span>Campo requerido</span>
              </div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label" for="editEstadoCliente">Estado</label>
            <select id="editEstadoCliente" class="form-select" name="estadoClienteId"
              [(ngModel)]="selectedEstadoClienteId">
              @for (estado of estadosCliente; track estado.idEstadoCliente) {
                <option [ngValue]="estado.idEstadoCliente">
                  {{ estado.nombreEstadoCliente }}
                </option>
              }
            </select>
          </div>
        </div>
      </form>
    } @else {
      @if (!modalEditarLoading && !modalEditarError) {
        <div class="text-muted">
          Selecciona un cliente para editar.
        </div>
      }
    }
  </app-formulario-base>

  <div modal-footer class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="closeEditModal()"
      [disabled]="modalEditarLoading || modalEditarSaving">
      Cerrar
    </button>
    <button type="submit" class="btn btn-primary" form="editClienteForm" [disabled]="
  modalEditarSaving ||
  modalEditarLoading ||
  !selectedCliente ||
  !editUiReady ||
  (editForm?.invalid ?? true)
">
      @if (modalEditarSaving) {
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      }
      Actualizar
    </button>
  </div>

</app-modal-base>
