<div class="dashboard-content">
  <app-list-toolbar
    [title]="'Inventario de equipos'"
    [description]="'Explora rápidamente los modelos disponibles agrupados por tipo y accede al detalle completo.'"
    [showSearch]="true"
    [searchPlaceholder]="'Tipo, marca o modelo'"
    [searchValue]="busqueda"
    [showCreateButton]="false"
    (searchChange)="onBuscar($event)"
  >
    <div actions>
      <div class="toolbar-actions">
        <button mat-stroked-button color="primary" [matMenuTriggerFor]="menuRegistrar" type="button">
          Registrar
          <mat-icon>expand_more</mat-icon>
        </button>
        <mat-menu #menuRegistrar="matMenu">
          <button mat-menu-item (click)="abrirModalTipo()">
            <mat-icon>category</mat-icon>
            <span>Tipo</span>
          </button>
          <button mat-menu-item (click)="abrirModalMarca()">
            <mat-icon>sell</mat-icon>
            <span>Marca</span>
          </button>
          <button mat-menu-item (click)="abrirModalModelo()">
            <mat-icon>devices</mat-icon>
            <span>Modelo</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </app-list-toolbar>

  @if (filtradoResumen.length) {
    <div class="card-grid">
      @for (tipo of filtradoResumen; track tipo.idTipoEquipo !== null && tipo.idTipoEquipo !== undefined ? tipo.idTipoEquipo : $index) {
      <mat-card class="equipment-card">
        <mat-card-header>
          <div mat-card-avatar class="equipment-avatar">
            {{ tipo.nombreTipoEquipo | slice: 0:1 }}
          </div>
          <mat-card-title>{{ tipo.nombreTipoEquipo }}</mat-card-title>
          <mat-card-subtitle>
            {{ tipo.totalCantidad }} {{ tipo.totalCantidad === 1 ? 'equipo' : 'equipos' }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <ul class="model-list">
            @for (modelo of tipo.modelos | slice: 0: maxModelosCompactos; track modelo.idModelo !== null && modelo.idModelo !== undefined ? modelo.idModelo : $index) {
            <li>
              <button
                type="button"
                class="model-item"
                (click)="verDetallePorModelo(tipo, modelo)"
              >
                <span class="model-name">
                  {{ modelo.nombreMarca }} · {{ modelo.nombreModelo }}
                </span>
                <span class="model-count">
                  {{ modelo.cantidad }}
                </span>
              </button>
            </li>
            }
          </ul>
          @if (tipo.modelos.length > maxModelosCompactos) {
          <span class="preview-note">
            + {{ tipo.modelos.length - maxModelosCompactos }} modelo{{ tipo.modelos.length - maxModelosCompactos === 1 ? '' : 's' }} más
          </span>
          }
        </mat-card-content>

        <mat-card-actions class="card-actions">
          <button mat-stroked-button color="primary" (click)="verDetallePorTipo(tipo)">
            Ver equipos
          </button>
        </mat-card-actions>
      </mat-card>
      }
    </div>
  } @else {
    <div class="empty-state">
      <mat-icon>inventory_2</mat-icon>
      <p>No hay equipos registrados en el inventario.</p>
    </div>
  }

  <app-modal-base
    [open]="modalTipoOpen"
    title="Registrar nuevo tipo"
    [disableClose]="formTipo.cargando"
    [useDefaultFooter]="false"
    [loading]="formTipo.cargando"
    (closed)="onModalTipoClosed()"
  >
    <app-formulario-base
      [open]="modalTipoOpen"
      [loading]="formTipo.cargando"
      [loadingMessage]="'Registrando tipo…'"
      [error]="formTipo.error"
    >
      <form
        id="crearTipoForm"
        #crearTipoForm="ngForm"
        class="row g-3"
        (ngSubmit)="confirmarCrearTipo()"
        autocomplete="off"
      >
        <div class="col-12 col-md-8">
          <label class="form-label" for="nombreTipo">Nombre del tipo</label>
          <input
            id="nombreTipo"
            name="nombreTipo"
            type="text"
            class="form-control"
            maxlength="80"
            required
            [(ngModel)]="formTipo.nombre"
            (ngModelChange)="formTipo.nombre = normalizarEntrada($event)"
            #nombreTipoCtrl="ngModel"
          />
          @if (nombreTipoCtrl.invalid && (nombreTipoCtrl.dirty || nombreTipoCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Ingresa un nombre válido.
          </div>
          }
        </div>

        <div class="col-12">
          <p class="mb-2">
            Por favor confirma que el nombre es correcto. Esta acción no podrá deshacerse.
          </p>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="confirmacionTipo"
              name="confirmacionTipo"
              [(ngModel)]="formTipo.confirmacion"
            />
            <label class="form-check-label" for="confirmacionTipo">
              Confirmo que el nombre es correcto
            </label>
          </div>
        </div>

        @if (formTipo.exito) {
        <div class="col-12 mensaje-exito">
          <mat-icon>check_circle</mat-icon>
          {{ formTipo.exito }}
        </div>
        }
      </form>
    </app-formulario-base>
    <div modal-footer class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="onModalTipoClosed()" [disabled]="formTipo.cargando">
        Cancelar
      </button>
      <button
        class="btn btn-primary d-inline-flex align-items-center gap-2"
        type="submit"
        form="crearTipoForm"
        [disabled]="!formTipo.confirmacion || crearTipoForm.invalid || formTipo.cargando"
      >
        @if (formTipo.cargando) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
        <span>Crear</span>
      </button>
    </div>
  </app-modal-base>

  <app-modal-base
    [open]="modalMarcaOpen"
    title="Registrar nueva marca"
    [disableClose]="formMarca.cargando"
    [useDefaultFooter]="false"
    [loading]="formMarca.cargando"
    (closed)="onModalMarcaClosed()"
  >
    <app-formulario-base
      [open]="modalMarcaOpen"
      [loading]="formMarca.cargando"
      [loadingMessage]="'Registrando marca…'"
      [error]="formMarca.error"
    >
      <form
        id="crearMarcaForm"
        #crearMarcaForm="ngForm"
        class="row g-3"
        (ngSubmit)="confirmarCrearMarca()"
        autocomplete="off"
      >
        <div class="col-12">
          <label class="form-label" for="nombreMarca">Nombre de la marca</label>
          <input
            id="nombreMarca"
            name="nombreMarca"
            type="text"
            class="form-control"
            maxlength="80"
            required
            [(ngModel)]="formMarca.nombre"
            #nombreMarcaCtrl="ngModel"
          />
          @if (nombreMarcaCtrl.invalid && (nombreMarcaCtrl.dirty || nombreMarcaCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Ingresa un nombre válido.
          </div>
          }
        </div>

        @if (formMarca.exito) {
        <div class="col-12 mensaje-exito">
          <mat-icon>check_circle</mat-icon>
          {{ formMarca.exito }}
        </div>
        }
      </form>
    </app-formulario-base>
    <div modal-footer class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="onModalMarcaClosed()" [disabled]="formMarca.cargando">
        Cancelar
      </button>
      <button
        class="btn btn-primary d-inline-flex align-items-center gap-2"
        type="submit"
        form="crearMarcaForm"
        [disabled]="crearMarcaForm.invalid || formMarca.cargando"
      >
        @if (formMarca.cargando) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
        <span>Crear</span>
      </button>
    </div>
  </app-modal-base>

  <app-modal-base
    [open]="modalModeloOpen"
    title="Registrar nuevo modelo"
    [disableClose]="formModelo.cargando"
    [useDefaultFooter]="false"
    [loading]="formModelo.cargando"
    (closed)="onModalModeloClosed()"
  >
    <app-formulario-base
      [open]="modalModeloOpen"
      [loading]="formModelo.cargando"
      [loadingMessage]="'Registrando modelo…'"
      [error]="formModelo.error"
    >
      <form
        id="crearModeloForm"
        #crearModeloForm="ngForm"
        class="row g-3"
        (ngSubmit)="confirmarCrearModelo()"
        autocomplete="off"
      >
        <div class="col-12">
          <label class="form-label" for="nombreModelo">Nombre del modelo</label>
          <input
            id="nombreModelo"
            name="nombreModelo"
            type="text"
            class="form-control"
            maxlength="120"
            required
            [(ngModel)]="formModelo.nombre"
            #nombreModeloCtrl="ngModel"
          />
          @if (nombreModeloCtrl.invalid && (nombreModeloCtrl.dirty || nombreModeloCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Ingresa un nombre válido.
          </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="tipoEquipoSelect">Tipo de equipo</label>
          <select
            id="tipoEquipoSelect"
            name="tipoEquipoSelect"
            class="form-select"
            required
            [(ngModel)]="formModelo.idTipoEquipo"
            #tipoEquipoCtrl="ngModel"
          >
            <option [ngValue]="null" disabled>Selecciona un tipo</option>
            @for (tipo of tiposDisponibles; track tipo.idTipoEquipo !== null && tipo.idTipoEquipo !== undefined ? tipo.idTipoEquipo : $index) {
            <option [ngValue]="tipo.idTipoEquipo">
              {{ tipo.nombre }}
            </option>
            }
          </select>
          @if (tipoEquipoCtrl.invalid && (tipoEquipoCtrl.dirty || tipoEquipoCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Selecciona un tipo de equipo.
          </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="marcaSelect">Marca</label>
          <select
            id="marcaSelect"
            name="marcaSelect"
            class="form-select"
            required
            [(ngModel)]="formModelo.idMarca"
            #marcaCtrl="ngModel"
          >
            <option [ngValue]="null" disabled>Selecciona una marca</option>
            @for (marca of marcasDisponibles; track marca.idMarca !== null && marca.idMarca !== undefined ? marca.idMarca : $index) {
            <option [ngValue]="marca.idMarca">
              {{ marca.nombre }}
            </option>
            }
          </select>
          @if (marcaCtrl.invalid && (marcaCtrl.dirty || marcaCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Selecciona una marca.
          </div>
          }
        </div>

        @if (formModelo.exito) {
        <div class="col-12 mensaje-exito">
          <mat-icon>check_circle</mat-icon>
          {{ formModelo.exito }}
        </div>
        }
      </form>
    </app-formulario-base>
    <div modal-footer class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="onModalModeloClosed()" [disabled]="formModelo.cargando">
        Cancelar
      </button>
      <button
        class="btn btn-primary d-inline-flex align-items-center gap-2"
        type="submit"
        form="crearModeloForm"
        [disabled]="crearModeloForm.invalid || formModelo.cargando"
      >
        @if (formModelo.cargando) {
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
        <span>Crear</span>
      </button>
    </div>
  </app-modal-base>
</div>
