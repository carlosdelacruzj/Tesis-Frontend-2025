<div class="dashboard-content">
  <div class="equipo-detalle">
  <app-list-toolbar
    [title]="toolbarTitle"
    [description]="toolbarDescription"
    [showSearch]="true"
    [searchPlaceholder]="'Serie, marca o modelo'"
    [searchValue]="busqueda"
    [showCreateButton]="false"
    (searchChange)="onBuscar($event)"
  >
    <div actions class="toolbar-actions">
       <button  type="button" class="btn   btn-sm" (click)="volver()">
         <i class="fa-solid fa-arrow-left-long"></i>
          Volver al inventario
        </button>
      <button type="button" class="btn btn-primary btn-sm" type="button" (click)="abrirModalEquipo()">
      <i class="fa-solid fa-plus"></i>
        Registrar equipo
      </button>
    </div>
  </app-list-toolbar>

  @if (cargando) {
  <div class="detalle-status">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <span>Cargando equipos...</span>
  </div>
  }

  @if (error) {
  <div class="detalle-status error">
    <mat-icon>error_outline</mat-icon>
    <span>No se pudo cargar la información. Intenta nuevamente.</span>
  </div>
  }

  @if (!cargando && !error) {
    @if (equipos.length) {
      <app-table-base
        [columns]="columnas"
        [data]="equiposFiltrados"
        [pageSize]="10"
        [pageSizeOptions]="[10, 25, 50]"
        [showCreateButton]="false"
        [showSearch]="false"
        [emptyText]="'No hay equipos registrados con estos filtros.'"
      >
        <ng-template appCell="nombreEstado" let-row>
          <app-estado-badge
            [estado]="row.nombreEstado || 'Sin estado'"
            [mapaColores]="{
              'disponible': 'success',
              'de baja': 'danger',
              'baja': 'danger',
              'mantenimiento': 'warning',
              'en mantenimiento': 'warning',
              'en uso': 'info',
              'prestado': 'info',
              'reservado': 'info'
            }"
          ></app-estado-badge>
        </ng-template>

        <ng-template appCell="fechaIngreso" let-row>
          {{ row.fechaIngreso | date: 'mediumDate' }}
        </ng-template>

        <ng-template appCell="acciones" let-row>
          <button
            class="btn btn-outline-secondary btn-sm"
            type="button"
            (click)="abrirModalEstado(row)"
          >
            Cambiar estado
          </button>
        </ng-template>
      </app-table-base>
    } @else {
      <div class="empty-state">
        <mat-icon>inventory_2</mat-icon>
        <p>No hay equipos registrados con estos filtros.</p>
      </div>
    }
  }

  <app-modal-base
    [open]="modalEquipoOpen"
    title="Registrar equipo"
    [disableClose]="formEquipo.cargando"
    [useDefaultFooter]="false"
    [loading]="formEquipo.cargando"
    (closed)="onModalEquipoClosed()"
  >
    <app-formulario-base
      [open]="modalEquipoOpen"
      [loading]="formEquipo.cargando"
      [loadingMessage]="'Registrando equipo…'"
      [error]="formEquipo.error"
    >
      <form
        id="crearEquipoForm"
        #crearEquipoForm="ngForm"
        class="row g-3"
        (ngSubmit)="confirmarCrearEquipo()"
      >
        <div class="col-12 col-md-6">
          <label class="form-label" for="fechaIngresoEquipo">Fecha de ingreso</label>
          <input
            id="fechaIngresoEquipo"
            name="fechaIngresoEquipo"
            type="date"
            class="form-control"
            required
            [(ngModel)]="formEquipo.fechaIngreso"
            #fechaIngresoCtrl="ngModel"
          />
          @if (fechaIngresoCtrl.invalid && (fechaIngresoCtrl.dirty || fechaIngresoCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Selecciona una fecha válida.
          </div>
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="modeloEquipoSelect">Modelo</label>
          @if (modeloFijo) {
            <div class="form-control-plaintext fw-semibold">
              {{ filtros.marcaNombre }} · {{ filtros.modeloNombre }}
            </div>
            <input type="hidden" name="modeloEquipoSelect" [(ngModel)]="formEquipo.idModelo" />
          } @else {
            <select
              id="modeloEquipoSelect"
              name="modeloEquipoSelect"
              class="form-select"
              required
              [disabled]="!modelosDisponibles.length"
              [(ngModel)]="formEquipo.idModelo"
              #modeloCtrl="ngModel"
            >
              <option [ngValue]="null" disabled>Selecciona un modelo</option>
              @for (modelo of modelosDisponibles; track modelo.idModelo !== null && modelo.idModelo !== undefined ? modelo.idModelo : $index) {
              <option [ngValue]="modelo.idModelo">
                {{ modelo.nombreMarca }} · {{ modelo.nombre }}
              </option>
              }
            </select>
            @if (modeloCtrl.invalid && (modeloCtrl.dirty || modeloCtrl.touched)) {
            <div class="invalid-feedback d-block">
              Selecciona un modelo.
            </div>
            }
          }
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="estadoEquipoSelect">Estado</label>
          <select
            id="estadoEquipoSelect"
            name="estadoEquipoSelect"
            class="form-select"
            [disabled]="true"
            [ngModelOptions]="{ standalone: true }"
            [(ngModel)]="formEquipo.idEstado"
          >
            <option [ngValue]="null" disabled>Selecciona un estado</option>
            @for (estado of estadosDisponibles; track estado.idEstado !== null && estado.idEstado !== undefined ? estado.idEstado : $index) {
            <option [ngValue]="estado.idEstado">
              {{ estado.nombreEstado }}
            </option>
            }
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="serieEquipo">Número de serie</label>
          <input
            id="serieEquipo"
            name="serieEquipo"
            type="text"
            class="form-control text-uppercase"
            maxlength="80"
            required
            [(ngModel)]="formEquipo.serie"
            #serieCtrl="ngModel"
          />
          @if (serieCtrl.invalid && (serieCtrl.dirty || serieCtrl.touched)) {
          <div class="invalid-feedback d-block">
            Ingrese un número de serie.
          </div>
          }
        </div>

        @if (formEquipo.exito) {
        <div class="col-12 mensaje-exito">
          <mat-icon>check_circle</mat-icon>
          {{ formEquipo.exito }}
        </div>
        }
      </form>
    </app-formulario-base>
    <div modal-footer class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-danger btn-sm" type="button" (click)="onModalEquipoClosed()" [disabled]="formEquipo.cargando">
        Cancelar
      </button>
      <button
        class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2"
        type="submit"
        form="crearEquipoForm"
        [disabled]="crearEquipoForm.invalid || formEquipo.cargando"
      >
        @if (formEquipo.cargando) {
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
        <span>Registrar</span>
      </button>
    </div>
  </app-modal-base>

  <app-modal-base
    [open]="estadoModal.open"
    title="Cambiar estado del equipo"
    [disableClose]="estadoModal.cargando"
    [useDefaultFooter]="false"
    [loading]="estadoModal.cargando"
    (closed)="cerrarModalEstado()"
  >
    <app-formulario-base
      [open]="estadoModal.open"
      [loading]="estadoModal.cargando"
      [loadingMessage]="'Actualizando estado…'"
      [error]="estadoModal.error"
    >
      <form class="row g-3" (ngSubmit)="confirmarCambioEstado()" id="cambiarEstadoForm">
        <div class="col-12">
          <label class="form-label" for="estadoNuevoSelect">Nuevo estado</label>
          <select
            id="estadoNuevoSelect"
            name="estadoNuevoSelect"
            class="form-select"
            required
            [disabled]="estadoModal.cargando || !estadosDisponibles.length || equipoEnBaja"
            [(ngModel)]="estadoModal.idEstado"
          >
            <option [ngValue]="null" disabled>Selecciona un estado</option>
            @for (estado of estadosDisponibles; track estado.idEstado !== null && estado.idEstado !== undefined ? estado.idEstado : $index) {
            <option [ngValue]="estado.idEstado">
              {{ estado.nombreEstado }}
            </option>
            }
          </select>
          @if (equipoEnBaja) {
          <div class="form-text">
            Un equipo dado de baja no puede cambiar a otro estado.
          </div>
          }
        </div>

        <div class="col-12">
          @if (estadoModal.equipo) {
          <div class="alert alert-secondary" role="status">
            Equipo: <strong>{{ estadoModal.equipo.serie }}</strong> · {{ estadoModal.equipo.nombreModelo }}
          </div>
          }
        </div>
      </form>
    </app-formulario-base>
    <div modal-footer class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-danger btn-sm" type="button" (click)="cerrarModalEstado()" [disabled]="estadoModal.cargando">
        Cancelar
      </button>
      <button
        class="btn btn-primary btn-sm"
        type="submit"
        form="cambiarEstadoForm"
        [disabled]="estadoModal.cargando || !estadoModal.idEstado || equipoEnBaja"
      >
        Guardar cambios
      </button>
    </div>
  </app-modal-base>
  </div>
</div>
