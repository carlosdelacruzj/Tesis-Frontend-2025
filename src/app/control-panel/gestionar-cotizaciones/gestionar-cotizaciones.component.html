<div class="container-fluid dashboard-content">
  <div class="container-fluid">
    <div>
      <h1>Cotizaciones</h1>
    </div>

    <div class="row align-items-center mb-3">
      <div class="col-12 col-md-8">
        <mat-form-field appearance="fill" class="w-100">
          <mat-label>Buscar</mat-label>
          <input matInput placeholder="Cliente, código, servicio…" autocomplete="off" (keyup)="filterData($event)" [disabled]="loadingList">
        </mat-form-field>
      </div>
      <div class="col-12 col-md-4 text-md-end text-start mt-2 mt-md-0">
        <button class="btn btn-outline-dark btn-lg" type="button" (click)="navigateToCreate()" [disabled]="loadingList">
          Registrar cotización
        </button>
      </div>
    </div>

    <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>

    <ng-container *ngIf="!loadingList; else loadingState">
      <table mat-table [dataSource]="dataSource" matSort class="table" [trackBy]="trackById">

        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Código </th>
          <td mat-cell *matCellDef="let element">{{ element.codigo || ('COT-' + element.id) }}</td>
        </ng-container>

        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
          <td mat-cell *matCellDef="let element">
            {{ element.cliente || '—' }}
            <small class="text-muted" *ngIf="element.contacto"> — {{ element.contacto }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="servicio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Servicio </th>
          <td mat-cell *matCellDef="let element">{{ element.servicio || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="evento">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Evento </th>
          <td mat-cell *matCellDef="let element">{{ element.evento || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha / horas </th>
          <td mat-cell *matCellDef="let element">
            {{ element.fecha | date:'dd-MM-yyyy' }}
            <small class="text-muted" *ngIf="element.horasEstimadas"> — {{ element.horasEstimadas }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
          <td mat-cell *matCellDef="let element">{{ element.estado || 'Pendiente' }}</td>
        </ng-container>

        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
          <td mat-cell *matCellDef="let element">{{ element.total | currency:'PEN':'symbol-narrow':'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-center"> Acciones </th>
          <td mat-cell *matCellDef="let element" class="text-center">
            <button mat-icon-button color="primary" type="button" (click)="editCotizacion(element)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="accent" type="button" (click)="downloadPdf(element)" [disabled]="downloadingId === element.id" matTooltip="Descargar PDF">
              <mat-icon *ngIf="downloadingId !== element.id">picture_as_pdf</mat-icon>
              <mat-icon *ngIf="downloadingId === element.id" class="spin">hourglass_top</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
        <tr mat-row *matRowDef="let row; columns: columnsToDisplay;"></tr>
      </table>

      <div class="text-center text-muted" *ngIf="dataSource && dataSource.data?.length === 0">
        Sin resultados
      </div>

      <mat-paginator [pageSize]="10" [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </ng-container>
  </div>
</div>

<ng-template #loadingState>
  <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
    <mat-spinner diameter="40"></mat-spinner>
    <p class="mt-3 mb-0">Cargando cotizaciones…</p>
  </div>
</ng-template>
