<div class="dashboard-ecommerce">
  <div class="container-fluid dashboard-content">
    <h1>Registrar cotización</h1>

    <form class="cotizacion-form" [formGroup]="form" (ngSubmit)="submit()">
      <div class="row">
        <div class="col-md-6 mb-3">
          <mat-card class="card">
            <mat-card-header>
              <mat-card-title>Datos del solicitante</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="form-group">
                <label class="col-form-label">Nombre completo</label>
                <input type="text" class="form-control" formControlName="clienteNombre"
                  placeholder="Nombre y apellidos">
                <small class="text-danger"
                  *ngIf="form.get('clienteNombre')?.invalid && form.get('clienteNombre')?.touched">
                  Ingresa al menos 2 caracteres.
                </small>
              </div>

              <div class="form-group">
                <label class="col-form-label">WhatsApp / contacto</label>
                <input type="tel" class="form-control" formControlName="clienteContacto" placeholder="Ej. 999 999 999">
                <small class="text-danger"
                  *ngIf="form.get('clienteContacto')?.invalid && form.get('clienteContacto')?.touched">
                  Ingresa un medio de contacto válido.
                </small>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="col-md-6 mb-3">
          <mat-card class="card">
            <mat-card-header>
              <mat-card-title>Detalles del evento</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="row g-3">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="col-form-label">Fecha del evento</label>
                    <input type="date" class="form-control" formControlName="fechaEvento">
                    <small class="text-danger"
                      *ngIf="form.get('fechaEvento')?.invalid && form.get('fechaEvento')?.touched">
                      Selecciona una fecha válida.
                    </small>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="col-form-label">Horas estimadas</label>
                    <input type="text" class="form-control" formControlName="horasEstimadas" placeholder="Ej. 6 horas">
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="col-form-label">Lugar del evento</label>
                <input type="text" class="form-control" formControlName="ubicacion" placeholder="Ej. Hotel Belmond">
                <small class="text-danger" *ngIf="form.get('ubicacion')?.invalid && form.get('ubicacion')?.touched">
                  Ingresa el lugar del evento.
                </small>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <mat-card class="card mb-3">
        <mat-card-header>
          <mat-card-title>Mensaje del solicitante</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <textarea class="form-control" rows="3" formControlName="descripcion"
            placeholder="Mensaje proporcionado en la solicitud"></textarea>
        </mat-card-content>
      </mat-card>

      <mat-card class="card mb-3">
        <mat-card-header>
          <mat-card-title>Servicios y paquetes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="row g-3 mb-3">
            <div class="col-sm-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Tipo de evento</mat-label>
                <mat-select [value]="selectedEventoId" (selectionChange)="onEventoChange($event.value)"
                  [disabled]="!eventos.length">

                  <mat-option *ngFor="let evento of eventos" [value]="evento.id ?? evento.ID ?? evento.PK_E_Cod">
                    {{ evento.nombre ?? evento.Evento ?? evento.E_Nombre ?? 'Evento' }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Servicio</mat-label>
                <mat-select [value]="selectedServicioId" (selectionChange)="onServicioChange($event.value)"
                  [disabled]="!servicios.length">
                  <mat-option *ngFor="let servicio of servicios" [value]="servicio.id ?? servicio.ID">
                    {{ servicio.nombre ?? servicio.Servicio ?? 'Servicio' }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>


          </div>

          <div class="table-responsive" *ngIf="!loadingPaquetes; else paquetesLoading">
            <table mat-table [dataSource]="paquetesDataSource" matSort #paquetesSort="matSort" class="table">

              <ng-container matColumnDef="Descripcion">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Descripción</th>
                <td mat-cell *matCellDef="let element">{{ element.descripcion || element.Descripcion }}</td>
              </ng-container>

              <ng-container matColumnDef="Precio">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
                <td mat-cell *matCellDef="let element">{{ (element.precio || element.Precio) | number:'1.2-2' }}</td>
              </ng-container>

              <ng-container matColumnDef="Staff">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Staff</th>
                <td mat-cell *matCellDef="let element">{{ element.staff || element.Staff || '—' }}</td>
              </ng-container>

              <ng-container matColumnDef="Horas">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Horas</th>
                <td mat-cell *matCellDef="let element">{{ element.horas || element.Horas || '—' }}</td>
              </ng-container>

              <ng-container matColumnDef="Seleccionar">
                <th mat-header-cell *matHeaderCellDef class="text-center">Seleccionar</th>
                <td mat-cell *matCellDef="let element" class="text-center">
                  <button type="button" class="btn btn-outline-primary btn-sm"
                    *ngIf="!isInSeleccion(element); else quitarBtn" (click)="addPaquete(element)">
                    Agregar
                  </button>
                  <ng-template #quitarBtn>
                    <button type="button" class="btn btn-outline-danger btn-sm"
                      (click)="removePaquete(pkgKey(element))">
                      Quitar
                    </button>
                  </ng-template>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="paquetesColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: paquetesColumns;"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="card mb-3" *ngIf="selectedPaquetes.length">
        <mat-card-header>
          <mat-card-title>Paquetes seleccionados ({{ selectedPaquetes.length }})</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Título</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Precio unit.</th>
                  <th class="text-end" *ngIf="shouldShowPrecioOriginal()">Original</th>
                  <th class="text-center">Horas</th>
                  <th class="text-center">Personal</th>
                  <th class="text-end">Subtotal</th>
                  <th style="width:30%">Notas</th>
                  <th class="text-center">Quitar</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedPaquetes">
                  <td>{{ item.titulo }}</td>
                  <td class="text-center">{{ item.cantidad }}</td>
                  <td class="text-end">
                    <ng-container *ngIf="!item.editandoPrecio; else precioEditor">
                      <span role="button" class="text-decoration-underline"
                        (click)="enablePrecioEdit(item)"
                        title="Haz clic para editar">
                        {{ item.precio | number:'1.2-2' }}
                      </span>
                    </ng-container>
                    <ng-template #precioEditor>
                      <input type="number" class="form-control form-control-sm text-end"
                        [id]="getPrecioInputId(item)" [value]="item.precio" step="0.01"
                        [attr.min]="getPrecioMinimo(item)"
                        (blur)="confirmPrecioEdit(item, $any($event.target).value)"
                        (keydown.enter)="confirmPrecioEdit(item, $any($event.target).value)"
                        (keydown.escape)="cancelPrecioEdit(item)">
                      <small class="text-muted">Mínimo: {{ getPrecioMinimo(item) | number:'1.2-2' }}</small>
                    </ng-template>
                  </td>
                  <td class="text-end" *ngIf="shouldShowPrecioOriginal()">
                    <div>{{ item.precioOriginal | number:'1.2-2' }}</div>
                    <div *ngIf="getDescuentoPorcentaje(item) != null" class="text-success small">
                      −{{ getDescuentoPorcentaje(item) | number:'1.0-1' }}%
                    </div>
                  </td>
                  <td class="text-center">{{ item.horas ?? '—' }}</td>
                  <td class="text-center">{{ item.personal ?? '—' }}</td>
                  <td class="text-end">{{ (item.precio * (item.cantidad || 1)) | number:'1.2-2' }}</td>
                  <td>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="item.notas"
                      [ngModelOptions]="{standalone:true}" maxlength="200" placeholder="Notas opcionales">
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-link text-danger p-0"
                      (click)="removePaquete(item.key)">✖</button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <th [attr.colspan]="shouldShowPrecioOriginal() ? 6 : 5" class="text-end">Total</th>
                  <th class="text-end">{{ totalSeleccion | number:'1.2-2' }}</th>
                  <th colspan="2"></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="row mb-3">
        <div class="col-md-4 ms-auto">
          <label class="col-form-label">Total estimado</label>
          <div class="input-group">
            <span class="input-group-text">US$</span>
            <input type="number" class="form-control" formControlName="totalEstimado" min="0" step="0.01">
          </div>
          <small class="text-muted">Se calcula automáticamente con los paquetes seleccionados, pero puedes ajustarlo
            manualmente.</small>
        </div>
      </div>

      <div class="text-end">
        <button type="button" class="btn btn-outline-secondary me-2" (click)="cancel()"
          [disabled]="loading">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="loading">
          <span *ngIf="!loading">Guardar cotización</span>
          <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </form>
  </div>
</div>

<ng-template #paquetesLoading>
  <div class="d-flex flex-column align-items-center justify-content-center py-4 text-muted">
    <mat-spinner diameter="32"></mat-spinner>
    <span class="mt-2">Cargando paquetes…</span>
  </div>
</ng-template>
