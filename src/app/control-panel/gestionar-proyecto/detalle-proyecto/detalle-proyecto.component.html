<div class="dashboard-content">
  <app-list-toolbar
    [title]="proyecto?.proyectoNombre || 'Proyecto'"
    [showSearch]="false"
    [showCreateButton]="false">
  </app-list-toolbar>

  @if (loading) {
    <div class="estado-centro">
      <ng-container *ngTemplateOutlet="loadingState"></ng-container>
    </div>
  } @else {
    @if (proyecto) {
      <section class="card hero" id="resumen-proyecto">
        <header class="card-header">
          <div>
            <p class="eyebrow">Proyecto #{{ proyecto.proyectoId }}</p>
            <h2 class="title">{{ proyecto.proyectoNombre }}</h2>
            <p class="muted small">Pedido #{{ proyecto.pedidoCodigo || proyecto.pedidoId }}</p>
          </div>
          <div class="estado">
            <span class="label">Estado</span>
            <app-estado-badge
              [estado]="proyecto.estadoNombre || '—'"
              [mapaColores]="{
                'planificado': 'info',
                'en ejecucion': 'warning',
                'en ejecución': 'warning',
                'entregado': 'success-light',
                'cerrado': 'success'
              }"
            ></app-estado-badge>
          </div>
        </header>

        <div class="stat-grid">
          <div class="stat-card">
            <p class="stat-label">Inicio edición</p>
            <p class="stat-value">{{ formatFechaDisplay(proyecto.fechaInicioEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Fin edición</p>
            <p class="stat-value">{{ formatFechaDisplay(proyecto.fechaFinEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Enlace</p>
            <p class="stat-value">
              @if (proyecto.enlace) {
                <a class="link" [href]="proyecto.enlace" target="_blank" rel="noopener">Abrir enlace</a>
              } @else {
                —
              }
            </p>
          </div>
        </div>

        <div class="ops-bar">
          <button class="ops-chip ops-chip--action" type="button" (click)="irASeccion('agenda-proyecto')">
            <span>Días</span>
            <strong>{{ totalDias }}</strong>
          </button>
          <button class="ops-chip ops-chip--action" type="button" (click)="irASeccion('agenda-proyecto')">
            <span>Servicios</span>
            <strong>{{ totalServiciosDia }}</strong>
          </button>
          <button class="ops-chip ops-chip--action" type="button" (click)="irASeccion('asignaciones-proyecto')">
            <span>Personal</span>
            <strong>{{ totalEmpleadosDia }}</strong>
          </button>
          <button class="ops-chip ops-chip--action" type="button" (click)="irASeccion('devoluciones-proyecto')">
            <span>Equipos</span>
            <strong>{{ totalEquiposDia }}</strong>
          </button>
          <button class="ops-chip ops-alert ops-chip--action" type="button" (click)="irASeccion('asignaciones-proyecto')">
            <span>Pendientes</span>
            <strong>{{ pendientesTotales.personal + pendientesTotales.equipos }}</strong>
          </button>
        </div>

        @if (proyecto.notas) {
          <div class="note-box">
            <div class="note-title">Notas</div>
            <p class="note-text">{{ proyecto.notas }}</p>
          </div>
        }
      </section>

      @if (detalle && detalle.dias?.length) {
      <section class="card section agenda-section" id="agenda-proyecto">
        <header class="card-header">
          <div class="section-heading">
            <p class="eyebrow">Agenda</p>
            <h3>Días de proyecto ({{ detalle.dias.length }})</h3>
            <p class="muted small section-help">Explora cada día para revisar bloques, servicios y pendientes.</p>
          </div>
          <button class="toggle-btn" type="button" (click)="toggleSoloPendientes()">
            @if (soloPendientes) { Ver todos } @else { Solo con pendientes }
          </button>
        </header>
        <div class="timeline">
          @for (dia of diasTimeline; track dia.diaId) {
            <details
              class="timeline-item"
              [open]="openDiaId === dia.diaId"
              (toggle)="onToggleDia(dia.diaId, $event)">
              <summary class="timeline-summary">
                <div class="timeline-date">
                  <div class="timeline-date__title">{{ formatFechaLarga(dia.fecha) }}</div>
                  <div class="timeline-date__metrics">
                    <span class="metric-chip">Bloques {{ getBloquesCount(dia.diaId) }}</span>
                    <span class="metric-chip">Servicios {{ getServiciosCountDia(dia.diaId) }}</span>
                    <span class="metric-chip">Personal {{ getAsignadosPersonalDia(dia.diaId) }}/{{ getReqPersonalCountDia(dia.diaId) }}</span>
                    <span class="metric-chip">Equipos {{ getAsignadosEquiposDia(dia.diaId) }}/{{ getReqEquiposCountDia(dia.diaId) }}</span>
                  </div>
                  @if (getRangoHorasDia(dia.diaId); as rango) {
                    <div class="timeline-date__range">{{ rango.inicio }} – {{ rango.fin }}</div>
                  }
                  <div class="timeline-badges">
                    <app-estado-badge
                      [estado]="dia.estadoDiaNombre || '—'"
                      [mapaColores]="{
                        'planificado': 'info',
                        'en ejecucion': 'warning',
                        'en ejecución': 'warning',
                        'pendiente': 'warning',
                        'entregado': 'success-light',
                        'cerrado': 'success'
                      }"
                    ></app-estado-badge>
                    @if (getEstadoAsignacionDia(dia.diaId) !== '—') {
                      <app-estado-badge
                        [estado]="getEstadoAsignacionDia(dia.diaId)"
                        [mapaColores]="{
                          'pendiente': 'warning',
                          'sin asignar': 'neutral',
                          'completo': 'success'
                        }"
                      ></app-estado-badge>
                    }
                    @if (isAsignacionDiaDirtyFor(dia.diaId)) {
                      <app-estado-badge [estado]="'Cambios'" [mapaColores]="{ 'cambios': 'warning' }"></app-estado-badge>
                    }
                  </div>
                </div>
                <div class="timeline-dot"></div>
              </summary>
              <div class="timeline-content">
                <div class="dia-grid">
                  <div class="dia-col">
                    <div class="locacion-list">
                      @for (bloque of getBloquesDia(dia.diaId); track bloque.bloqueId) {
                        <div class="locacion-card">
                          <div class="locacion-card__time">{{ formatHora12(bloque.hora) }}</div>
                          <div class="locacion-card__body">
                            <div class="locacion-card__title">{{ bloque.ubicacion || '—' }}</div>
                            <div class="locacion-card__meta">{{ bloque.direccion || '—' }}</div>
                            @if (bloque.notas) {
                              <div class="locacion-card__notes">{{ bloque.notas }}</div>
                            }
                          </div>
                        </div>
                      }
                      @if (!getBloquesDia(dia.diaId).length) {
                        <div class="empty-inline">Sin bloques cargados para este día.</div>
                      }
                    </div>
                  </div>
                  <div class="dia-col">
                    <div class="servicios-dia">
                      <div class="servicios-dia__header">
                        <span class="label">Servicios contratados</span>
                        <span class="muted small">{{ getServiciosDia(dia.diaId).length }} ítem(s)</span>
                      </div>
                      @if (getServiciosDia(dia.diaId).length) {
                        <div class="servicios-dia__list">
                          @for (serv of getServiciosDia(dia.diaId); track serv.id) {
                            <div class="servicio-chip" [ngClass]="getServiceColorClass(serv.nombre)">
                              <div class="servicio-chip__title">{{ serv.nombre || '—' }}</div>
                            </div>
                          }
                        </div>
                      } @else {
                        <p class="muted">Sin servicios asignados. Revisa la configuración del pedido para este día.</p>
                      }
                      <div class="pendientes-dia">
                        <span class="muted small">Pendientes</span>
                        <span class="pill pill-muted">Personal: {{ getPendientesDia(dia.diaId).personal }}</span>
                        <span class="pill pill-muted">Equipos: {{ getPendientesDia(dia.diaId).equipos }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </details>
          }
        </div>
      </section>
      } @else if (detalle) {
      <section class="card section">
        <div class="estado-centro">
          <p class="muted">Este proyecto todavía no tiene días registrados.</p>
          <p class="muted small">Cuando agregues días, aquí verás la agenda y sus pendientes.</p>
        </div>
      </section>
      }

      @if ((detalle?.empleadosDia?.length || detalle?.equiposDia?.length) || (detalle?.requerimientosPersonalDia?.length || detalle?.requerimientosEquipoDia?.length)) {
      <section class="card section" id="asignaciones-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div>
              <p class="eyebrow">Asignaciones</p>
              <h3>Personal y equipos</h3>
            </div>
            <div class="collapsible__actions">
              <button mat-stroked-button color="primary" type="button" (click)="$event.stopPropagation(); abrirModalAsignar()">
                Ver/gestionar asignaciones
              </button>
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>

          <div class="asignaciones-resumen">
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              <div class="asignaciones-resumen__card">
                <div class="asignaciones-resumen__header">
                  <div>
                    <div class="asignaciones-resumen__title">{{ formatFechaLarga(dia.fecha) }}</div>
                    <div class="asignaciones-resumen__meta">
                      Personal: {{ getAsignadosPersonalDia(dia.diaId) }}/{{ getReqPersonalCountDia(dia.diaId) }}
                      · Equipos: {{ getAsignadosEquiposDia(dia.diaId) }}/{{ getReqEquiposCountDia(dia.diaId) }}
                    </div>
                  </div>
                  <app-estado-badge
                    [estado]="getEstadoAsignacionDia(dia.diaId)"
                    [mapaColores]="{
                      'pendiente': 'warning',
                      'sin asignar': 'neutral',
                      'completo': 'success'
                    }"
                  ></app-estado-badge>
                </div>
              </div>
            }
          </div>
        </details>
      </section>
      }

      <section class="card section" id="incidencias-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div>
              <p class="eyebrow">Incidencias</p>
              <h3>Registro del día</h3>
            </div>
            <div class="collapsible__actions">
              <button mat-stroked-button color="primary" type="button" (click)="$event.stopPropagation(); abrirModalIncidencia()">
                Registrar incidencia
              </button>
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>
          <div class="incidencias-resumen">
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              <div class="incidencias-resumen__card">
                <div class="incidencias-resumen__header">
                  <div>
                    <div class="incidencias-resumen__title">{{ formatFechaLarga(dia.fecha) }}</div>
                    <div class="incidencias-resumen__meta">{{ getIncidenciasCountDia(dia.diaId) }} incidencia(s)</div>
                  </div>
                  <div class="incidencias-resumen__actions">
                    <button mat-stroked-button type="button" (click)="abrirModalDevolucion(dia.diaId)">Devoluciones</button>
                    <button mat-button type="button" (click)="abrirModalIncidencia(dia.diaId)">Agregar</button>
                  </div>
                </div>
                <div class="incidencias-resumen__list">
                  @for (inc of getIncidenciasDia(dia.diaId); track inc.incidenciaId) {
                    <div class="incidencia-item">
                      <div class="incidencia-item__tipo">
                        @switch (inc.tipo) {
                          @case ('PERSONAL_NO_ASISTE') { Personal no asiste }
                          @case ('EQUIPO_FALLA_EN_EVENTO') { Equipo falla en evento }
                          @default { Otros }
                        }
                      </div>
                      <div class="incidencia-item__meta" *ngIf="inc.empleadoNombre">
                        <span class="chip chip-light">Afectado: {{ inc.empleadoNombre }}<span class="muted" *ngIf="inc.empleadoCargo"> · {{ inc.empleadoCargo }}</span></span>
                        <span class="chip chip-light" *ngIf="inc.empleadoReemplazoNombre">Reemplazo: {{ inc.empleadoReemplazoNombre }}<span class="muted" *ngIf="inc.empleadoReemplazoCargo"> · {{ inc.empleadoReemplazoCargo }}</span></span>
                      </div>
                      <div class="incidencia-item__desc">{{ inc.descripcion }}</div>
                    </div>
                  }
                  @if (!getIncidenciasCountDia(dia.diaId)) {
                    <div class="muted small">Sin incidencias.</div>
                  }
                </div>
              </div>
            }
          </div>
        </details>
      </section>

      @if (detalle?.equiposDia?.length) {
      <section class="card section" id="devoluciones-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div>
              <p class="eyebrow">Devoluciones</p>
              <h3>Estado de equipos</h3>
            </div>
            <span class="collapsible__caret">▾</span>
          </summary>
          <div class="devoluciones-grid">
            @for (eq of detalle.equiposDia; track eq.asignacionId) {
              <div class="devolucion-card">
                <div class="devolucion-header">
                  <div>
                    <div class="fw-semibold">{{ eq.modelo || '—' }}</div>
                    <div class="muted small">Serie: {{ eq.equipoSerie || '—' }}</div>
                  </div>
                  <app-estado-badge
                    [estado]="eq.estadoDevolucion || 'Sin devolución'"
                    [mapaColores]="{
                      'sin devolución': 'neutral',
                      'pendiente': 'warning',
                      'devuelto': 'success',
                      'entregado': 'success-light'
                    }"
                  ></app-estado-badge>
                </div>
                <div class="muted small">Fecha devolución: {{ eq.fechaDevolucion || '—' }}</div>
                @if (eq.notasDevolucion) {
                  <div class="devolucion-notas">{{ eq.notasDevolucion }}</div>
                }
              </div>
            }
          </div>
        </details>
      </section>
      }

    } @else {
      <p class="estado-centro">{{ error }}</p>
    }
  }
</div>

<app-modal-base
  [open]="modalAsignarAbierto"
  title="Asignaciones"
  [useDefaultFooter]="false"
  size="xl"
  (closed)="cerrarModalAsignar()">

  <div class="modal-section">
    <h4>Asignaciones por día</h4>
    <div class="asignaciones-editor">
      <label class="form-field">
        <span class="label">Selecciona un día</span>
        <select
          class="form-control"
          [ngModel]="asignacionDiaId"
          (ngModelChange)="cambiarDiaAsignacion($event)"
          name="asignacionDiaId">
          <option [ngValue]="null">Selecciona un día</option>
          @for (dia of detalle?.dias ?? []; track dia.diaId) {
            <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
          }
        </select>
      </label>
      <label class="form-field">
        <span class="label">Copiar desde</span>
        <select
          class="form-control"
          [(ngModel)]="copiarDesdeDiaId"
          name="copiarDesdeDiaId">
          <option [ngValue]="null">Selecciona un día</option>
          @for (dia of detalle?.dias ?? []; track dia.diaId) {
            @if (dia.diaId !== asignacionDiaId) {
              <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
            }
          }
        </select>
      </label>
      <button mat-stroked-button color="primary" type="button" (click)="copiarAsignacionesDesde(copiarDesdeDiaId)"
        [disabled]="!copiarDesdeDiaId || !asignacionDiaId || !hasRequerimientosDia(asignacionDiaId)">
        Copiar
      </button>
      <button mat-stroked-button color="primary" type="button" (click)="limpiarAsignacionesDia()" [disabled]="!asignacionDiaId">
        Limpiar día
      </button>
      <button mat-stroked-button type="button" (click)="descartarCambiosDia()" [disabled]="!isAsignacionDiaDirty(asignacionDiaId)">
        Descartar cambios
      </button>
      @if (hasFiltrosActivos()) {
        <button mat-button type="button" (click)="limpiarFiltrosAsignacion()">Quitar filtros</button>
      }
    </div>

    @if (asignacionDiaId) {
      <div class="asignaciones-summary">
        <app-estado-badge
          [estado]="'Personal: ' + getTotalAsignadoPersonal() + '/' + getTotalRequeridoPersonal(asignacionDiaId)">
        </app-estado-badge>
        <app-estado-badge
          [estado]="'Equipos: ' + getTotalAsignadoEquipos() + '/' + getTotalRequeridoEquipos(asignacionDiaId)">
        </app-estado-badge>
        @if (isAsignacionDiaDirty(asignacionDiaId)) {
          <app-estado-badge [estado]="'Cambios sin guardar'" [mapaColores]="{ 'cambios sin guardar': 'warning' }"></app-estado-badge>
        }
      </div>
    }

    @if (!asignacionDiaId) {
    } @else if (!hasRequerimientosDia(asignacionDiaId)) {
      <div class="muted small">Sin requerimientos para este día.</div>
    } @else {
    <mat-stepper class="asignaciones-stepper" [orientation]="stepperOrientation" [linear]="false">
      <mat-step>
        <ng-template matStepLabel>
          Personal <span class="stepper-meta">{{ getProgresoPersonalLabel(asignacionDiaId) }}</span>
        </ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Selecciona personal operativo</h5>
            @if (asignacionDiaId) {
              <div class="asignaciones-badges">
                @for (row of getRequeridosPersonalPorRol(asignacionDiaId); track row.rol) {
                  <button class="badge-button" type="button" (click)="toggleFiltroRol(row.rol)">
                    <app-estado-badge
                      [estado]="row.rol + ': ' + row.asignado + '/' + row.requerido"
                      [mapaColores]="getBadgeMapa(row.rol + ': ' + row.asignado + '/' + row.requerido, row.asignado, row.requerido)"
                    ></app-estado-badge>
                  </button>
                }
              </div>
            }
            @if (filtroRol) {
              <div class="filtro-activo">
                <span class="muted small">Filtro activo: {{ filtroRol }}</span>
                <button mat-button type="button" (click)="toggleFiltroRol(filtroRol)">Quitar</button>
              </div>
            }
            <div class="asignaciones-editor-form">
              <div class="transfer">
                <div class="transfer__col">
                  <div class="transfer__header">
                    <span>Disponibles</span>
                    <input
                      class="form-control form-control--compact"
                      type="text"
                      [(ngModel)]="searchEmpleado"
                      name="searchEmpleado"
                      placeholder="Buscar personal">
                  </div>
                  <div class="transfer__list">
                    @for (op of getEmpleadosDisponiblesFiltrados(); track op.empleadoId) {
                      <button class="transfer__item" type="button" (click)="onEmpleadoSeleccionado(op.empleadoId)">
                        <span [innerHTML]="highlightMatch(op.nombre + ' ' + op.apellido, searchEmpleado)"></span>
                        <span class="transfer__meta">{{ op.cargo }}</span>
                      </button>
                    }
                  </div>
                </div>
                <div class="transfer__col">
                  <div class="transfer__header">
                    <span>Seleccionados ({{ asignacionEmpleados.length }})</span>
                  </div>
                  <div class="transfer__list">
                    @for (item of asignacionEmpleados; track item.empleadoId; let i = $index) {
                      <div class="transfer__item is-selected">
                        <span>{{ getDisponibleEmpleadoLabel(item.empleadoId) }}</span>
                        <button class="transfer__remove" type="button" (click)="eliminarEmpleado(i)">Quitar</button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
            @if (!disponiblesEmpleados.length) {
              <div class="muted small">No hay personal disponible para este día.</div>
            } @else if (!getEmpleadosDisponiblesFiltrados().length) {
              <div class="muted small">Sin resultados.</div>
            }
          </div>
        </div>
      </mat-step>

      <mat-step>
        <ng-template matStepLabel>
          Equipos <span class="stepper-meta">{{ getProgresoEquiposLabel(asignacionDiaId) }}</span>
        </ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Selecciona equipos disponibles</h5>
            @if (asignacionDiaId) {
              <div class="asignaciones-badges">
                @for (row of getRequeridosEquiposPorTipo(asignacionDiaId); track row.tipo) {
                  <button class="badge-button" type="button" (click)="toggleFiltroTipo(row.tipo)">
                    <app-estado-badge
                      [estado]="row.tipo + ': ' + row.asignado + '/' + row.requerido"
                      [mapaColores]="getBadgeMapa(row.tipo + ': ' + row.asignado + '/' + row.requerido, row.asignado, row.requerido)"
                    ></app-estado-badge>
                  </button>
                }
              </div>
            }
            @if (filtroTipoEquipo) {
              <div class="filtro-activo">
                <span class="muted small">Filtro activo: {{ filtroTipoEquipo }}</span>
                <button mat-button type="button" (click)="toggleFiltroTipo(filtroTipoEquipo)">Quitar</button>
              </div>
            }
            <div class="asignaciones-editor-form">
              <div class="equipos-resumen">
                @for (row of getRequeridosEquiposPorTipo(asignacionDiaId); track row.tipo) {
                  @if (!filtroTipoEquipo || row.tipo === filtroTipoEquipo) {
                    <div class="equipos-row">
                      <div class="equipos-row__main">
                        <div class="equipos-row__title">{{ row.tipo }}</div>
                      <div class="equipos-row__meta">
                        <span class="meta-chip">Req: {{ row.requerido }}</span>
                        <span class="meta-chip">Asig: {{ row.asignado }}</span>
                        <span class="meta-chip">Disp: {{ getEquiposDisponiblesPorTipo(row.tipo).length }}</span>
                      </div>
                      </div>
                      <div class="equipos-row__status">
                        <app-estado-badge [estado]="row.asignado + '/' + row.requerido"></app-estado-badge>
                      </div>
                      <div class="equipos-row__actions">
                        <button mat-stroked-button type="button" (click)="quitarEquipoPorTipo(row.tipo)" [disabled]="row.asignado === 0">
                          −
                        </button>
                        <button mat-stroked-button color="primary" type="button"
                          (click)="agregarEquipoPorTipo(row.tipo, row.requerido)"
                          [disabled]="row.asignado >= row.requerido || getEquiposDisponiblesPorTipo(row.tipo).length === 0 || tieneMultiplesModelos(row.tipo)">
                          +
                        </button>
                        <button mat-button type="button"
                          (click)="completarEquiposPorTipo(row.tipo, row.requerido)"
                          [disabled]="row.asignado >= row.requerido || getEquiposDisponiblesPorTipo(row.tipo).length === 0 || tieneMultiplesModelos(row.tipo)">
                          Completar
                        </button>
                        <button mat-button type="button" (click)="toggleTipoDetalle(row.tipo)">
                          {{ isTipoDetalleAbierto(row.tipo) ? 'Ocultar' : 'Detalle' }}
                        </button>
                      </div>
                    </div>
                    @if (isTipoDetalleAbierto(row.tipo)) {
                      <div class="equipos-detalle equipos-detalle--open">
                        <div>
                          <div class="muted small">Disponibles</div>
                          <div class="equipos-detalle__filters">
                            <input
                              class="form-control form-control--compact"
                              type="text"
                              [(ngModel)]="searchEquipo"
                              name="searchEquipo-detalle"
                              placeholder="Buscar serie o modelo">
                            @if (getModelosPorTipo(row.tipo).length) {
                              <select
                                class="form-control form-control--compact"
                                [ngModel]="getModeloFiltro(row.tipo)"
                                (ngModelChange)="setModeloFiltro(row.tipo, $event)">
                                <option value="">Todos los modelos</option>
                                @for (modelo of getModelosPorTipo(row.tipo); track modelo) {
                                  <option [value]="modelo">{{ modelo }}</option>
                                }
                              </select>
                            }
                          </div>
                          <div class="equipos-disponibles">
                            @for (eq of getEquiposDisponiblesPorTipoFiltrados(row.tipo); track eq.equipoId) {
                              <label class="equipos-disponibles__item">
                                <input
                                  type="checkbox"
                                  [checked]="isEquipoSeleccionado(eq.equipoId)"
                                  [disabled]="!isEquipoSeleccionado(eq.equipoId) && row.asignado >= row.requerido"
                                  (change)="toggleEquipoSeleccion(eq.equipoId, row.tipo, row.requerido)">
                                <span>{{ eq.nombreModelo }} · {{ eq.serie }}</span>
                              </label>
                            }
                          </div>
                        </div>
                        <div>
                          <div class="muted small">Asignados</div>
                          <div class="chip-list">
                            @for (item of getEquiposAsignadosPorTipo(row.tipo); track item.equipoId) {
                              <div class="chip">
                                <span>{{ getDisponibleEquipoLabel(item.equipoId) }}</span>
                                <button class="chip__close" type="button" (click)="eliminarEquipo(asignacionEquipos.indexOf(item))" aria-label="Quitar">
                                  <mat-icon>close</mat-icon>
                                </button>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                    }
                  }
                }
              </div>
            </div>
          </div>
        </div>
      </mat-step>

      <mat-step>
        <ng-template matStepLabel>Responsables</ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Asigna responsables</h5>
            @if (!asignacionEmpleados.length) {
              <p class="muted">Primero selecciona personal operativo.</p>
            } @else if (!asignacionEquipos.length) {
              <p class="muted">Primero selecciona equipos disponibles.</p>
            } @else {
              <div class="asignaciones-meta">
                <span class="meta-chip">Total: {{ asignacionEquipos.length }}</span>
                <span class="meta-chip">Asignados: {{ asignacionEquipos.length - getEquiposReserva().length }}</span>
                <span class="meta-chip">Reserva: {{ getEquiposReserva().length }}</span>
              </div>
              <div class="drag-grid" cdkDropListGroup>
                <div class="drag-col">
                  <h6>Reserva</h6>
                  <div
                    class="drag-list drag-list--reserve"
                    [class.drop-highlight]="ultimoDropDestino === 'reserva'"
                    cdkDropList
                    id="reserva"
                    [cdkDropListConnectedTo]="dropListIds"
                    (cdkDropListDropped)="onEquipoDrop($event, null)">
                    @for (grupo of getEquiposReservaPorTipo(); track grupo.tipo) {
                      <details class="reserva-grupo" open>
                        <summary class="reserva-grupo__header">
                          <span>{{ grupo.tipo }}</span>
                          <span class="meta-chip">{{ grupo.items.length }}</span>
                        </summary>
                        <div class="reserva-grupo__items">
                          @for (item of grupo.items; track item.equipoId) {
                            <div class="drag-item" cdkDrag [cdkDragData]="item" [title]="getDisponibleEquipoLabel(item.equipoId)">
                              <span>{{ getDisponibleEquipoLabelSinTipo(item.equipoId) }}</span>
                              <mat-icon class="drag-handle">drag_indicator</mat-icon>
                            </div>
                          }
                        </div>
                      </details>
                    }
                  </div>
                </div>
                <div class="drag-col">
                  <h6>Personal</h6>
                  @for (emp of asignacionEmpleados; track emp.empleadoId) {
                    <div class="drag-panel">
                      <div class="drag-panel__title">
                        <span>{{ getDisponibleEmpleadoLabel(emp.empleadoId) }}</span>
                        <span class="drag-panel__count">{{ getEquiposCountResponsable(emp.empleadoId) }}</span>
                      </div>
                      <div
                        class="drag-list drag-list--scroll"
                        [class.drop-highlight]="ultimoDropDestino === emp.empleadoId"
                        [id]="'emp-' + emp.empleadoId"
                        [cdkDropListConnectedTo]="dropListIds"
                        cdkDropList
                        (cdkDropListDropped)="onEquipoDrop($event, emp.empleadoId)">
                        @for (item of getEquiposPorResponsable(emp.empleadoId); track item.equipoId) {
                          <div class="drag-item" cdkDrag [cdkDragData]="item" [title]="getDisponibleEquipoLabel(item.equipoId)">
                            <span>{{ getDisponibleEquipoLabelSinTipo(item.equipoId) }}</span>
                            <mat-icon class="drag-handle">drag_indicator</mat-icon>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </mat-step>
    </mat-stepper>
    }
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalAsignar()">Cerrar</button>
    <button mat-flat-button color="primary" type="button" (click)="guardarAsignacionesDia()"
      [disabled]="guardandoAsignaciones || !asignacionDiaId || !hasRequerimientosDia(asignacionDiaId) || !isAsignacionDiaDirty(asignacionDiaId)">
      {{ guardandoAsignaciones ? 'Guardando…' : 'Guardar asignaciones' }}
    </button>
  </div>
</app-modal-base>

<app-modal-base
  [open]="modalIncidenciaAbierto"
  title="Registrar incidencia"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="cerrarModalIncidencia()">

  <div class="modal-section">
    <div class="asignaciones-editor">
      <label class="form-field">
        <span class="label">Día</span>
        <select
          class="form-control"
          [ngModel]="incidenciaDiaId"
          (ngModelChange)="onIncidenciaDiaChange($event)"
          name="incidenciaDiaId">
          <option [ngValue]="null">Selecciona un día</option>
          @for (dia of detalle?.dias ?? []; track dia.diaId) {
            <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
          }
        </select>
      </label>
      <label class="form-field">
        <span class="label">Tipo</span>
        <select
          class="form-control"
          [ngModel]="incidenciaTipo"
          (ngModelChange)="onIncidenciaTipoChange($event)"
          name="incidenciaTipo">
          <option value="">Selecciona un tipo</option>
          <option value="PERSONAL_NO_ASISTE">Personal no asiste</option>
          <option value="EQUIPO_FALLA_EN_EVENTO">Equipo falla en evento</option>
          <option value="EQUIPO_ROBO_PERDIDA">Equipo robo/pérdida</option>
          <option value="OTROS">Otros</option>
        </select>
      </label>
    </div>

    @if (incidenciaTipo === 'PERSONAL_NO_ASISTE') {
      <div class="edit-form-grid">
        <label class="form-field">
          <span class="label">Personal afectado</span>
          <select class="form-control" [ngModel]="incidenciaEmpleadoId" (ngModelChange)="onIncidenciaEmpleadoChange($event)" name="incidenciaEmpleadoId">
            <option [ngValue]="null">Selecciona</option>
            @for (emp of getEmpleadosDiaOptions(incidenciaDiaId || 0); track emp.empleadoId) {
              <option [ngValue]="emp.empleadoId">{{ emp.empleadoNombre }}</option>
            }
          </select>
        </label>
        <label class="form-field">
          <span class="label">Reemplazo</span>
          <select class="form-control" [(ngModel)]="incidenciaEmpleadoReemplazoId" name="incidenciaEmpleadoReemplazoId" [disabled]="!incidenciaEmpleadoId || cargandoDisponiblesIncidencia">
            <option [ngValue]="null">Selecciona</option>
            @for (emp of getReemplazoEmpleadoOptions(); track emp.empleadoId) {
              <option [ngValue]="emp.empleadoId">{{ emp.empleadoNombre }}</option>
            }
          </select>
          @if (!getReemplazoEmpleadoOptions().length && incidenciaEmpleadoId) {
            <div class="muted small">No hay reemplazos disponibles con el mismo cargo para este día.</div>
          }
        </label>
      </div>
    }

    @if (incidenciaTipo === 'EQUIPO_FALLA_EN_EVENTO' || incidenciaTipo === 'EQUIPO_ROBO_PERDIDA') {
      <div class="edit-form-grid">
        <label class="form-field">
          <span class="label">Equipo afectado</span>
          <select class="form-control" [ngModel]="incidenciaEquipoId" (ngModelChange)="onIncidenciaEquipoChange($event)" name="incidenciaEquipoId">
            <option [ngValue]="null">Selecciona</option>
            @for (eq of getEquiposAfectadosOptions(incidenciaDiaId || 0); track eq.equipoId) {
              <option [ngValue]="eq.equipoId">{{ eq.label }}</option>
            }
          </select>
        </label>
        <label class="form-field">
          <span class="label">Reemplazo</span>
          <select class="form-control" [(ngModel)]="incidenciaEquipoReemplazoId" name="incidenciaEquipoReemplazoId" [disabled]="!incidenciaEquipoId || cargandoDisponiblesIncidencia">
            <option [ngValue]="null">Selecciona</option>
            @for (eq of getReemplazoEquipoOptions(); track eq.equipoId) {
              <option [ngValue]="eq.equipoId">{{ eq.label }}</option>
            }
          </select>
          @if (!getReemplazoEquipoOptions().length && incidenciaEquipoId) {
            <div class="muted small">No hay equipos disponibles del mismo tipo para este día.</div>
          }
          @if (incidenciaTipo === 'EQUIPO_ROBO_PERDIDA') {
            <div class="muted small">El reemplazo es opcional en robo/pérdida.</div>
          }
        </label>
      </div>
    }

    <label class="form-field">
      <span class="label">Descripción</span>
      <textarea
        class="form-control"
        rows="3"
        [(ngModel)]="incidenciaDescripcion"
        name="incidenciaDescripcion"
        placeholder="Describe la incidencia"></textarea>
    </label>
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalIncidencia()">Cancelar</button>
    <button mat-flat-button color="primary" type="button" (click)="guardarIncidencia()"
      [disabled]="guardandoIncidencia || !canGuardarIncidencia()">
      {{ guardandoIncidencia ? 'Guardando…' : 'Registrar incidencia' }}
    </button>
  </div>
</app-modal-base>

<app-modal-base
  [open]="modalDevolucionAbierto"
  title="Registrar devoluciones"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="cerrarModalDevolucion()">

  <div class="modal-section">
    @if (devolucionDiaId) {
      <div class="devolucion-grid">
        @for (eq of getEquiposDevolucionDia(devolucionDiaId); track eq.equipoId) {
          <div class="devolucion-row">
            <div class="devolucion-info">
              <div class="devolucion-title">{{ eq.modelo || 'Equipo' }} ({{ eq.equipoSerie || '—' }})</div>
              <div class="muted small">{{ eq.tipoEquipo }}</div>
              @if (eq.responsableNombre) {
                <div class="muted small">Responsable: {{ eq.responsableNombre }}</div>
              }
            </div>
            <div class="devolucion-form">
              <label class="form-field small">
                <span class="label">Estado</span>
                <select class="form-control" [ngModel]="devolucionDraft[eq.equipoId]?.estado || ''" (ngModelChange)="onDevolucionEstadoChange(eq.equipoId, $event)">
                  <option value="">Selecciona</option>
                  <option value="DEVUELTO">Devuelto</option>
                  <option value="DANADO">Dañado</option>
                  <option value="PERDIDO">Perdido</option>
                  <option value="ROBADO">Robado</option>
                </select>
              </label>
              <label class="form-field small">
                <span class="label">Fecha</span>
                <input class="form-control" type="datetime-local" [ngModel]="devolucionDraft[eq.equipoId]?.fecha || ''" (ngModelChange)="onDevolucionFechaChange(eq.equipoId, $event)">
                <div class="muted micro">Vacío = ahora</div>
              </label>
              <label class="form-field small">
                <span class="label">Notas</span>
                <textarea class="form-control" rows="2" [ngModel]="devolucionDraft[eq.equipoId]?.notas || ''" (ngModelChange)="onDevolucionNotasChange(eq.equipoId, $event)" placeholder="Opcional"></textarea>
              </label>
            </div>
          </div>
        }
        @if (!getEquiposDevolucionDia(devolucionDiaId).length) {
          <div class="muted">No hay equipos asignados en este día.</div>
        }
      </div>
    }
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalDevolucion()">Cerrar</button>
    <button mat-flat-button color="primary" type="button" (click)="guardarDevoluciones()"
      [disabled]="guardandoDevolucion || !canGuardarDevoluciones()">
      {{ guardandoDevolucion ? 'Guardando…' : 'Guardar devoluciones' }}
    </button>
  </div>
</app-modal-base>

<ng-template #loadingState>
  <mat-spinner diameter="40"></mat-spinner>
  <p>Cargando proyecto…</p>
</ng-template>
