<div class="dashboard-content operativo-mode">
  <app-list-toolbar
    [title]="proyecto?.proyectoNombre || 'Proyecto'"
    [showSearch]="false"
    [showCreateButton]="false">
  </app-list-toolbar>

  @if (loading) {
    <div class="estado-centro">
      <ng-container *ngTemplateOutlet="loadingState"></ng-container>
    </div>
  } @else {
    @if (proyecto) {
      <section class="card hero" id="resumen-proyecto">
        <header class="card-header">
          <div>
            <p class="eyebrow">Proyecto #{{ proyecto.proyectoId }}</p>
            <h2 class="title">{{ proyecto.proyectoNombre }}</h2>
            <p class="muted small">Pedido #{{ proyecto.pedidoCodigo || proyecto.pedidoId }}</p>
          </div>
          <div class="estado">
            <span class="label">Estado</span>
            <app-estado-badge
              [estado]="proyecto.estadoNombre || '—'"
              [mapaColores]="{
                'planificado': 'info',
                'en ejecucion': 'warning',
                'en ejecución': 'warning',
                'entregado': 'success-light',
                'cerrado': 'success'
              }"
            ></app-estado-badge>
          </div>
        </header>

        <div class="stat-grid">
          <div class="stat-card">
            <p class="stat-label">Inicio edición</p>
            <p class="stat-value">{{ formatFechaDisplay(postproduccion.fechaInicioEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Fin edición</p>
            <p class="stat-value">{{ formatFechaDisplay(postproduccion.fechaFinEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Enlace</p>
            <p class="stat-value">
              @if (postproduccion.entregaFinalEnlace) {
                <a class="link" [href]="postproduccion.entregaFinalEnlace" target="_blank" rel="noopener">Abrir enlace</a>
              } @else {
                —
              }
            </p>
          </div>
        </div>

        <div class="workflow-lane" aria-label="Flujo de trabajo del proyecto">
          <button class="workflow-item" type="button" (click)="irASeccion('agenda-proyecto')">
            <span class="workflow-item__step">1</span>
            <span class="workflow-item__text">
              <strong>Agenda</strong>
              <small>Revisa días y pendientes</small>
            </span>
          </button>
          <button class="workflow-item" type="button" (click)="irASeccion('asignaciones-proyecto')">
            <span class="workflow-item__step">2</span>
            <span class="workflow-item__text">
              <strong>Asignaciones</strong>
              <small>Define personal y equipos</small>
            </span>
          </button>
          <button class="workflow-item" type="button" (click)="irASeccion('incidencias-proyecto')">
            <span class="workflow-item__step">3</span>
            <span class="workflow-item__text">
              <strong>Incidencias</strong>
              <small>Registra eventos del día</small>
            </span>
          </button>
          <button class="workflow-item" type="button" (click)="irASeccion('devoluciones-proyecto')">
            <span class="workflow-item__step">4</span>
            <span class="workflow-item__text">
              <strong>Devoluciones</strong>
              <small>Confirma estado de equipos</small>
            </span>
          </button>
          <button class="workflow-item" type="button" (click)="irASeccion('postproduccion-proyecto')">
            <span class="workflow-item__step">5</span>
            <span class="workflow-item__text">
              <strong>Postproducción</strong>
              <small>Edición y entregas</small>
            </span>
          </button>
        </div>

        <div class="control-kpis" aria-label="Indicadores de control operativo">
          <article class="control-kpi control-kpi--primary">
            <p class="control-kpi__label">Avance de asignación</p>
            <div class="control-kpi__value">{{ avanceAsignacionGeneral }}%</div>
            <p class="control-kpi__meta">{{ totalDiasConPendientes }} día(s) con pendientes · {{ totalDias }} día(s) totales</p>
          </article>
          <article class="control-kpi" [ngClass]="getRiesgoGeneralClass()">
            <p class="control-kpi__label">Pendientes activos</p>
            <div class="control-kpi__value">{{ pendientesTotales.personal + pendientesTotales.equipos }}</div>
            <p class="control-kpi__meta">Personal: {{ pendientesTotales.personal }} · Equipos: {{ pendientesTotales.equipos }} · Riesgo alto: {{ totalDiasRiesgoAlto }}</p>
          </article>
          <article class="control-kpi control-kpi--neutral">
            <p class="control-kpi__label">Incidencias registradas</p>
            <div class="control-kpi__value">{{ totalIncidencias }}</div>
            <p class="control-kpi__meta">Monitoreo diario del proyecto</p>
          </article>
          <article class="control-kpi control-kpi--danger">
            <p class="control-kpi__label">Equipos por devolver</p>
            <div class="control-kpi__value">{{ totalEquiposPendientesDevolucion }}</div>
            <p class="control-kpi__meta">Revisar cierre de jornada</p>
          </article>
        </div>
        @if (proyecto.notas) {
          <div class="note-box">
            <div class="note-title">Notas</div>
            <p class="note-text">{{ proyecto.notas }}</p>
          </div>
        }
      </section>

      @if (detalle && detalle.dias?.length) {
      <section class="card section agenda-section" id="agenda-proyecto">
        <header class="card-header">
          <div class="section-heading">
            <span class="flow-step">Paso 1</span>
            <p class="eyebrow">Agenda</p>
            <h3>Días de proyecto ({{ detalle.dias.length }})</h3>
            <p class="muted small section-help">Explora cada día para revisar bloques, servicios y pendientes.</p>
          </div>
          <div class="agenda-actions">
            <button class="toggle-btn" type="button" (click)="toggleSoloPendientes()">
              @if (soloPendientes) { Ver todos } @else { Solo pendientes }
            </button>
            <button class="toggle-btn" type="button" (click)="irAPrimerPendiente()">Ir a pendiente</button>
          </div>
        </header>
        @if (openDiaId) {
          <div class="agenda-sticky-bar">
            <div>
              <div class="agenda-sticky-bar__title">{{ getOpenDiaLabel() }}</div>
              <div class="agenda-sticky-bar__meta">
                Pendientes: personal {{ getPendientesDia(openDiaId).personal }} · equipos {{ getPendientesDia(openDiaId).equipos }}
              </div>
            </div>
            <button mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar(openDiaId)">
              @if (isDiaPendienteEstado(openDiaId)) { Asignar ahora } @else { Ver asignaciones }
            </button>
          </div>
        }
        <div class="timeline">
          @for (dia of diasTimeline; track dia.diaId) {
            <details
              class="timeline-item"
              [class.timeline-item--pending]="getEstadoAsignacionDia(dia.diaId) === 'Pendiente' || getEstadoAsignacionDia(dia.diaId) === 'Sin asignar'"
              [class.timeline-item--done]="getEstadoAsignacionDia(dia.diaId) === 'Asignaciones completas'"
              [open]="openDiaId === dia.diaId"
              (toggle)="onToggleDia(dia.diaId, $event)">
              <summary class="timeline-summary">
                <div class="timeline-date">
                  <div class="timeline-date__title">{{ formatFechaLarga(dia.fecha) }}</div>
                  <div class="timeline-date__metrics">
                    <span class="metric-chip">Bloques {{ getBloquesCount(dia.diaId) }}</span>
                    <span class="metric-chip">Servicios {{ getServiciosCountDia(dia.diaId) }}</span>
                    <span class="metric-chip">Personal {{ getAsignadosPersonalDia(dia.diaId) }}/{{ getReqPersonalCountDia(dia.diaId) }}</span>
                    <span class="metric-chip">Equipos {{ getAsignadosEquiposDia(dia.diaId) }}/{{ getReqEquiposCountDia(dia.diaId) }}</span>
                  </div>
                  @if (getRangoHorasDia(dia.diaId); as rango) {
                    <div class="timeline-date__range">{{ rango.inicio }} – {{ rango.fin }}</div>
                  }
                  <div class="timeline-badges">
                    <div class="timeline-badges__group">
                      <app-estado-badge
                        [estado]="dia.estadoDiaNombre || '—'"
                        [mapaColores]="{
                          'pendiente': 'warning',
                          'en curso': 'info',
                          'terminado': 'success',
                          'suspendido': 'neutral',
                          'cancelado': 'danger'
                        }"
                      ></app-estado-badge>
                      @if (getEstadoAsignacionDia(dia.diaId) !== '—') {
                        <app-estado-badge
                          [estado]="getEstadoAsignacionDia(dia.diaId)"
                        [mapaColores]="{
                            'pendiente': 'warning',
                            'sin asignar': 'neutral',
                            'asignaciones completas': 'success'
                          }"
                        ></app-estado-badge>
                      }
                      @if (isAsignacionDiaDirtyFor(dia.diaId)) {
                        <app-estado-badge [estado]="'Cambios'" [mapaColores]="{ 'cambios': 'warning' }"></app-estado-badge>
                      }
                    </div>
                  </div>
                </div>
                <div class="timeline-side">
                  <div class="timeline-dot"></div>
                  <span class="timeline-expand">{{ openDiaId === dia.diaId ? 'Ocultar' : 'Ver detalle' }}</span>
                  <div class="estado-dia-action-wrap estado-dia-action-wrap--right" (click)="$event.stopPropagation()">
                    <button
                      class="estado-dia-action"
                      type="button"
                      [disabled]="!getEstadosDiaPermitidos(dia).length || estadoDiaLoading[dia.diaId]"
                      (click)="toggleEstadoDiaMenu(dia.diaId, $event)">
                      <app-estado-badge
                        [estado]="'Cambiar estado'"
                        [mapaColores]="{ 'cambiar estado': 'info' }"
                      ></app-estado-badge>
                    </button>
                    @if (estadoDiaMenuOpenId === dia.diaId) {
                      <div class="estado-dia-menu" (click)="$event.stopPropagation()">
                        @for (estado of getEstadosDiaPermitidos(dia); track estado.estadoDiaId) {
                          <button
                            class="estado-dia-menu__item"
                            type="button"
                            [class.is-active]="estado.estadoDiaId === dia.estadoDiaId"
                            [disabled]="estadoDiaLoading[dia.diaId]"
                            (click)="onEstadoDiaSelect(dia, estado.estadoDiaId)">
                            <span>{{ estado.estadoDiaNombre }}</span>
                          </button>
                        }
                      </div>
                    }
                  </div>
                </div>
              </summary>
              <div class="timeline-content">
                <div class="dia-grid">
                  <div class="dia-col">
                    <div class="locacion-list">
                      @for (bloque of getBloquesDia(dia.diaId); track bloque.bloqueId) {
                        <div class="locacion-card">
                          <div class="locacion-card__time">{{ formatHora12(bloque.hora) }}</div>
                          <div class="locacion-card__body">
                            <div class="locacion-card__title">{{ bloque.ubicacion || '—' }}</div>
                            <div class="locacion-card__meta">{{ bloque.direccion || '—' }}</div>
                            @if (bloque.notas) {
                              <div class="locacion-card__notes">{{ bloque.notas }}</div>
                            }
                          </div>
                        </div>
                      }
                      @if (!getBloquesDia(dia.diaId).length) {
                        <div class="empty-inline">Sin bloques cargados para este día.</div>
                      }
                    </div>
                  </div>
                  <div class="dia-col">
                    <div class="servicios-dia">
                      <div class="servicios-dia__header">
                        <span class="label">Servicios contratados</span>
                        <span class="muted small">{{ getServiciosDia(dia.diaId).length }} ítem(s)</span>
                      </div>
                      @if (getServiciosDia(dia.diaId).length) {
                        <div class="servicios-dia__list">
                          @for (serv of getServiciosDia(dia.diaId); track serv.id) {
                            <div class="servicio-chip" [ngClass]="getServiceColorClass(serv.nombre)">
                              <div class="servicio-chip__title">{{ serv.nombre || '—' }}</div>
                            </div>
                          }
                        </div>
                      } @else {
                        <p class="muted">Sin servicios asignados. Revisa la configuración del pedido para este día.</p>
                      }
                      <div class="pendientes-dia">
                        <span class="muted small">Pendientes</span>
                        <span class="pill pill-muted">Personal: {{ getPendientesDia(dia.diaId).personal }}</span>
                        <span class="pill pill-muted">Equipos: {{ getPendientesDia(dia.diaId).equipos }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </details>
          }
        </div>
      </section>
      } @else if (detalle) {
      <section class="card section">
        <div class="estado-centro">
          <p class="muted">Este proyecto todavía no tiene días registrados.</p>
          <p class="muted small">Cuando agregues días, aquí verás la agenda y sus pendientes.</p>
        </div>
      </section>
      }

      @if ((detalle?.empleadosDia?.length || detalle?.equiposDia?.length) || (detalle?.requerimientosPersonalDia?.length || detalle?.requerimientosEquipoDia?.length)) {
      <section class="card section section--flow" id="asignaciones-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div class="section-heading">
              <span class="flow-step">Paso 2</span>
              <p class="eyebrow">Asignaciones</p>
              <h3>Personal y equipos</h3>
            </div>
            <div class="collapsible__actions">
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>

          <div class="asignaciones-resumen">
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              <div class="asignaciones-resumen__card">
                <div class="asignaciones-resumen__header">
                  <div>
                    <div class="asignaciones-resumen__title">{{ formatFechaLarga(dia.fecha) }}</div>
                    <div class="asignaciones-resumen__meta">
                      Personal: {{ getAsignadosPersonalDia(dia.diaId) }}/{{ getReqPersonalCountDia(dia.diaId) }}
                      · Equipos: {{ getAsignadosEquiposDia(dia.diaId) }}/{{ getReqEquiposCountDia(dia.diaId) }}
                    </div>
                  </div>
                  <div class="asignaciones-resumen__right">
                    <div class="asignaciones-resumen__actions">
                      <button mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar(dia.diaId)">
                        @if (isDiaPendienteEstado(dia.diaId)) { Asignar } @else { Ver }
                      </button>
                    </div>
                    <app-estado-badge
                      [estado]="getEstadoAsignacionDia(dia.diaId)"
                      [mapaColores]="{
                        'pendiente': 'warning',
                        'sin asignar': 'neutral',
                        'asignaciones completas': 'success'
                      }"
                    ></app-estado-badge>
                  </div>
                </div>
              </div>
            }
          </div>
        </details>
      </section>
      }

      <section class="card section section--flow" id="incidencias-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div class="section-heading">
              <span class="flow-step">Paso 3</span>
              <p class="eyebrow">Incidencias</p>
              <h3>Registro del día</h3>
            </div>
            <div class="collapsible__actions">
              <button mat-stroked-button color="primary" type="button" (click)="$event.stopPropagation(); abrirModalIncidencia()" [disabled]="!isDiaEnCurso(openDiaId)">
                Agregar incidencia
              </button>
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>
          <div class="incidencias-resumen">
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              <div class="incidencias-resumen__card">
                <div class="incidencias-resumen__header">
                  <div>
                    <div class="incidencias-resumen__title">{{ formatFechaLarga(dia.fecha) }}</div>
                    <div class="incidencias-resumen__meta">{{ getIncidenciasCountDia(dia.diaId) }} incidencia(s)</div>
                  </div>
                  <div class="incidencias-resumen__actions">
                    <button mat-button type="button" (click)="abrirModalIncidencia(dia.diaId)" [disabled]="!isDiaEnCurso(dia.diaId)">Agregar</button>
                  </div>
                </div>
                <div class="incidencias-resumen__list">
                  @for (inc of getIncidenciasRecientesDia(dia.diaId); track inc.incidenciaId) {
                    <div class="incidencia-item">
                      <div class="incidencia-item__header">
                        <div class="incidencia-item__tipo">{{ getIncidenciaTipoLabel(inc.tipo) }}</div>
                        <span class="incidencia-severity" [ngClass]="'incidencia-severity--' + getIncidenciaSeveridad(inc)">
                          {{ getIncidenciaSeveridad(inc) }}
                        </span>
                      </div>
                      <div class="incidencia-item__meta" *ngIf="inc.empleadoNombre">
                        <span class="chip chip-light">Afectado: {{ inc.empleadoNombre }}<span class="muted" *ngIf="inc.empleadoCargo"> · {{ inc.empleadoCargo }}</span></span>
                        <span class="chip chip-light" *ngIf="inc.empleadoReemplazoNombre">Reemplazo: {{ inc.empleadoReemplazoNombre }}<span class="muted" *ngIf="inc.empleadoReemplazoCargo"> · {{ inc.empleadoReemplazoCargo }}</span></span>
                      </div>
                      <div class="incidencia-item__time">
                        <span>Hora del incidente: {{ inc.fechaHoraEvento ? formatHora12(inc.fechaHoraEvento) : 'No registrada' }}</span>
                      </div>
                      <div class="incidencia-item__desc">{{ inc.descripcion }}</div>
                    </div>
                  }
                  @if (getIncidenciasCountDia(dia.diaId) > 3) {
                    <button class="incidencia-more" type="button" (click)="abrirModalIncidenciasDia(dia.diaId)">
                      Ver {{ getIncidenciasCountDia(dia.diaId) - 3 }} incidencia(s) más
                    </button>
                  }
                  @if (!getIncidenciasCountDia(dia.diaId)) {
                    <div class="muted small">Sin incidencias.</div>
                  }
                </div>
              </div>
            }
          </div>
        </details>
      </section>

      @if (detalle?.equiposDia?.length) {
      <section class="card section section--flow" id="devoluciones-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div class="section-heading">
              <span class="flow-step">Paso 4</span>
              <p class="eyebrow">Devoluciones</p>
              <h3>Estado de equipos</h3>
            </div>
            <div class="collapsible__actions">
              <button mat-button type="button" (click)="$event.stopPropagation(); toggleSoloExcepcionesEstado()">
                @if (mostrarSoloExcepcionesEstado) { Ver todo } @else { Solo excepciones }
              </button>
              @if (getDiasDevolucionPendientes().length) {
                <button mat-stroked-button color="primary" type="button"
                  (click)="$event.stopPropagation(); abrirModalDevolucion(openDiaId || undefined)">
                  Registrar devoluciones del día
                </button>
              } @else {
                <span class="muted small">Sin devoluciones pendientes.</span>
              }
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>
          <div class="estado-equipos-view">
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              @if (getResumenEstadoDia(dia.diaId).total) {
                <details class="estado-dia-card" [open]="openDiaId === dia.diaId">
                  <summary class="estado-dia-card__summary">
                    <div>
                      <div class="estado-dia-card__title">{{ formatFechaLarga(dia.fecha) }}</div>
                      <div class="estado-dia-card__meta">
                        Total: {{ getResumenEstadoDia(dia.diaId).total }} ·
                        Devueltos: {{ getResumenEstadoDia(dia.diaId).devueltos }} ·
                        Excepciones: {{ getResumenEstadoDia(dia.diaId).excepciones }}
                      </div>
                    </div>
                  </summary>

                  <div class="estado-dia-card__body">
                    @for (grupo of getGruposEstadoDia(dia.diaId); track grupo.responsable) {
                      <details class="estado-responsable-card">
                        <summary class="estado-responsable-card__summary">
                          <div class="estado-responsable-card__title">{{ grupo.responsable }}</div>
                          <div class="estado-responsable-card__meta">
                            {{ grupo.total }} equipo(s) · Excepciones: {{ grupo.excepciones }}
                          </div>
                        </summary>
                        <div class="estado-equipos-list">
                          @for (eq of grupo.items; track eq.asignacionId) {
                            <div class="estado-equipo-row" [ngClass]="getEstadoDevolucionClass(eq.estadoDevolucion)">
                              <div class="estado-equipo-row__main">
                                <div class="estado-equipo-row__name">{{ eq.modelo || '—' }} · {{ eq.equipoSerie || '—' }}</div>
                                <div class="estado-equipo-row__meta">{{ eq.tipoEquipo || '—' }}</div>
                              </div>
                              <app-estado-badge
                                [estado]="getEstadoDevolucionDisplay(eq.estadoDevolucion)"
                                [mapaColores]="{
                                  'pendiente': 'warning',
                                  'devuelto': 'success',
                                  'dañado': 'warning',
                                  'perdido': 'danger',
                                  'robado': 'danger'
                                }"
                              ></app-estado-badge>
                            </div>
                          }
                        </div>
                      </details>
                    }
                    @if (!getGruposEstadoDia(dia.diaId).length && mostrarSoloExcepcionesEstado) {
                      <div class="muted small">Sin excepciones para este día.</div>
                    }
                  </div>
                </details>
              }
            }
          </div>
        </details>
      </section>
      }

      <section class="card section section--flow" id="postproduccion-proyecto">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div class="section-heading">
              <span class="flow-step">Paso 5</span>
              <p class="eyebrow">Postproducción</p>
              <h3>Edición y entregas</h3>
            </div>
            <div class="collapsible__actions">
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>

          <div class="postprod-grid">
            <div class="postprod-card">
              <h4>Inicio de edición</h4>
              <label class="form-field">
                <span class="label">Fecha inicio</span>
                <input class="form-control" type="date" [(ngModel)]="postproduccion.fechaInicioEdicion" [disabled]="!!postproduccion.fechaInicioEdicion">
              </label>
              <button mat-stroked-button color="primary" type="button" (click)="iniciarEdicionPost()" [disabled]="guardandoPostproduccion || !!postproduccion.fechaInicioEdicion">
                Iniciar edición
              </button>
            </div>

            <div class="postprod-card">
              <h4>Pre-entrega</h4>
              <label class="form-field">
                <span class="label">Enlace pre-entrega</span>
                <input class="form-control" type="text" [(ngModel)]="postproduccion.preEntregaEnlace" placeholder="https://...">
              </label>
              <label class="form-field">
                <span class="label">Tipo de pre-entrega</span>
                <select class="form-control" [(ngModel)]="postproduccion.preEntregaTipo">
                  <option [ngValue]="null">Selecciona</option>
                  <option [ngValue]="'VIDEO'">Video (trailer)</option>
                  <option [ngValue]="'FOTOS'">Fotos (selección)</option>
                  <option [ngValue]="'AMBOS'">Ambos</option>
                </select>
              </label>
              <label class="form-field">
                <span class="label">Feedback / Selección del cliente</span>
                <textarea class="form-control" rows="3" [(ngModel)]="postproduccion.preEntregaFeedback" placeholder="Aprobado, cambios solicitados o fotos elegidas..."></textarea>
              </label>
              <div class="muted small">Fecha de envío: {{ postproduccion.preEntregaFecha || '—' }}</div>
              <button mat-stroked-button type="button" (click)="enviarPreEntregaPost()" [disabled]="guardandoPostproduccion || !postproduccion.fechaInicioEdicion">
                Enviar pre-entrega
              </button>
            </div>

            <div class="postprod-card">
              <h4>Cierre de edición</h4>
              <label class="form-field">
                <span class="label">Fecha fin</span>
                <input class="form-control" type="date" [(ngModel)]="postproduccion.fechaFinEdicion">
              </label>
              <label class="form-field">
                <span class="label">Ubicación de respaldo</span>
                <input class="form-control" type="text" [(ngModel)]="postproduccion.respaldoUbicacion" placeholder="HDD 2026-A · Disco #3 · Carpeta PRO-000004">
              </label>
              <label class="form-field">
                <span class="label">Notas de respaldo</span>
                <textarea class="form-control" rows="2" [(ngModel)]="postproduccion.respaldoNotas" placeholder="Observaciones, claves, etc."></textarea>
              </label>
              <button mat-stroked-button type="button" (click)="guardarRespaldoPost()" [disabled]="guardandoPostproduccion">
                Guardar ubicación
              </button>
              <button mat-stroked-button type="button" (click)="cerrarEdicionPost()" [disabled]="guardandoPostproduccion">
                Cerrar edición
              </button>
            </div>

            <div class="postprod-card">
              <h4>Entrega final</h4>
              <label class="form-field">
                <span class="label">Enlace final</span>
                <input class="form-control" type="text" [(ngModel)]="postproduccion.entregaFinalEnlace" placeholder="https://...">
              </label>
              <label class="form-field">
                <span class="label">Fecha de entrega final</span>
                <input class="form-control" type="date" [(ngModel)]="postproduccion.entregaFinalFecha">
              </label>
              <label class="form-field">
                <span class="label">Entrega física requerida</span>
                <select class="form-control" [(ngModel)]="postEntregaFisicaRequerida">
                  <option [ngValue]="false">No</option>
                  <option [ngValue]="true">Sí</option>
                </select>
              </label>
              @if (postEntregaFisicaRequerida) {
                <label class="form-field">
                  <span class="label">Tipo de entrega física</span>
                  <input class="form-control" type="text" [(ngModel)]="postTipoEntregaFisica" placeholder="Impresiones, photobook, USB, etc.">
                </label>
                <label class="form-field">
                  <span class="label">Fecha de entrega física</span>
                  <input class="form-control" type="date" [(ngModel)]="postFechaEntregaFisica">
                </label>
                <label class="form-field">
                  <span class="label">Responsable de entrega</span>
                  <input class="form-control" type="text" [(ngModel)]="postResponsableEntregaFisica" placeholder="Nombre y apellido">
                </label>
                <label class="form-field">
                  <span class="label">Observaciones</span>
                  <textarea class="form-control" rows="2" [(ngModel)]="postObservacionesEntregaFisica" placeholder="Notas sobre la entrega física"></textarea>
                </label>
              }
              <div class="muted small">Entrega solo con pago completo.</div>
              <button mat-flat-button color="primary" type="button" (click)="marcarEntregaPost()"
                [disabled]="guardandoPostproduccion || !postproduccion.fechaFinEdicion || !tienePagoCompletoMock()">
                Marcar entrega
              </button>
            </div>
          </div>
        </details>
      </section>

    } @else {
      <p class="estado-centro">{{ error }}</p>
    }
  }
</div>

<app-modal-base
  [open]="modalAsignarAbierto"
  title="Asignaciones"
  [useDefaultFooter]="false"
  size="xl"
  (closed)="cerrarModalAsignar()">

  <div class="modal-section">
    <h4>Asignaciones por día</h4>
    @if (asignacionSoloLectura) {
      <div class="muted small">Solo lectura: el día no está en Pendiente, las asignaciones no se pueden editar.</div>
    }
    <div class="asignaciones-editor">
      @if (!asignacionDiaLocked) {
        <label class="form-field">
          <span class="label">Selecciona un día</span>
          <select
            class="form-control"
            [ngModel]="asignacionDiaId"
            (ngModelChange)="cambiarDiaAsignacion($event)"
            name="asignacionDiaId">
            <option [ngValue]="null">Selecciona un día</option>
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
            }
          </select>
        </label>
      } @else {
        <div class="form-field">
          <span class="label">Día</span>
          <div class="form-control form-control--static">
            {{ getAsignacionDiaLabel() }}
          </div>
        </div>
      }
      @if (!asignacionSoloLectura) {
        <label class="form-field">
          <span class="label">Copiar desde</span>
          <select
            class="form-control"
            [(ngModel)]="copiarDesdeDiaId"
            name="copiarDesdeDiaId">
            <option [ngValue]="null">Selecciona un día</option>
            @for (dia of detalle?.dias ?? []; track dia.diaId) {
              @if (dia.diaId !== asignacionDiaId) {
                <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
              }
            }
          </select>
        </label>
        <div class="asignaciones-editor-actions">
          <button mat-stroked-button color="primary" type="button" (click)="copiarAsignacionesDesde(copiarDesdeDiaId)"
            [disabled]="!copiarDesdeDiaId || !asignacionDiaId || !hasRequerimientosDia(asignacionDiaId)">
            Copiar
          </button>
          <button mat-stroked-button color="primary" type="button" (click)="limpiarAsignacionesDia()" [disabled]="!asignacionDiaId">
            Limpiar día
          </button>
          <button mat-stroked-button type="button" (click)="descartarCambiosDia()" [disabled]="!isAsignacionDiaDirty(asignacionDiaId)">
            Descartar cambios
          </button>
          @if (hasFiltrosActivos()) {
            <button mat-button type="button" (click)="limpiarFiltrosAsignacion()">Quitar filtros</button>
          }
        </div>
      }
    </div>

    @if (asignacionDiaId) {
      <div class="asignaciones-summary">
        <app-estado-badge
          [estado]="'Personal: ' + getTotalAsignadoPersonal() + '/' + getTotalRequeridoPersonal(asignacionDiaId)">
        </app-estado-badge>
        <app-estado-badge
          [estado]="'Equipos: ' + getTotalAsignadoEquipos() + '/' + getTotalRequeridoEquipos(asignacionDiaId)">
        </app-estado-badge>
        @if (isAsignacionDiaDirty(asignacionDiaId)) {
          <app-estado-badge [estado]="'Cambios sin guardar'" [mapaColores]="{ 'cambios sin guardar': 'warning' }"></app-estado-badge>
        }
      </div>
    }

    @if (!asignacionDiaId) {
    } @else if (!hasRequerimientosDia(asignacionDiaId)) {
      <div class="muted small">Sin requerimientos para este día.</div>
    } @else {
    <mat-stepper #asignacionesStepper class="asignaciones-stepper" [orientation]="stepperOrientation" [linear]="!asignacionSoloLectura">
      <mat-step [completed]="canCompletarPasoPersonal()">
        <ng-template matStepLabel>
          Personal <span class="stepper-meta">{{ getProgresoPersonalLabel(asignacionDiaId) }}</span>
        </ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Selecciona personal operativo</h5>
            @if (!asignacionSoloLectura) {
              @if (asignacionDiaId) {
                <div class="asignaciones-badges">
                  @for (row of getRequeridosPersonalPorRol(asignacionDiaId); track row.rol) {
                    <button class="badge-button" type="button" (click)="toggleFiltroRol(row.rol)">
                      <app-estado-badge
                        [estado]="row.rol + ': ' + row.asignado + '/' + row.requerido"
                        [mapaColores]="getBadgeMapa(row.rol + ': ' + row.asignado + '/' + row.requerido, row.asignado, row.requerido)"
                      ></app-estado-badge>
                    </button>
                  }
                </div>
              }
              @if (filtroRol) {
                <div class="filtro-activo">
                  <span class="muted small">Filtro activo: {{ filtroRol }}</span>
                  <button mat-button type="button" (click)="toggleFiltroRol(filtroRol)">Quitar</button>
                </div>
              }
              <div class="asignaciones-editor-form">
                <div class="transfer">
                  <div class="transfer__col">
                    <div class="transfer__header">
                      <span>Disponibles</span>
                      <input
                        class="form-control form-control--compact"
                        type="text"
                        [(ngModel)]="searchEmpleado"
                        name="searchEmpleado"
                        placeholder="Buscar personal">
                    </div>
                    <div class="transfer__list">
                      @for (op of getEmpleadosDisponiblesFiltrados(); track op.empleadoId) {
                        <button class="transfer__item" type="button" (click)="onEmpleadoSeleccionado(op.empleadoId)">
                          <span [innerHTML]="highlightMatch(op.nombre + ' ' + op.apellido, searchEmpleado)"></span>
                          <span class="transfer__meta">{{ op.cargo }}</span>
                        </button>
                      }
                    </div>
                  </div>
                  <div class="transfer__col">
                    <div class="transfer__header">
                      <span>Seleccionados ({{ asignacionEmpleados.length }})</span>
                    </div>
                    <div class="transfer__list">
                      @for (item of asignacionEmpleados; track item.empleadoId; let i = $index) {
                        <div class="transfer__item is-selected">
                          <span>{{ getDisponibleEmpleadoLabel(item.empleadoId) }}</span>
                          <button class="transfer__remove" type="button" (click)="eliminarEmpleado(i)">Quitar</button>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="chip-list">
                @for (item of asignacionEmpleados; track item.empleadoId) {
                  <div class="chip">
                    <span>{{ getDisponibleEmpleadoLabel(item.empleadoId) }}</span>
                  </div>
                }
                @if (!asignacionEmpleados.length) {
                  <div class="muted small">Sin personal asignado.</div>
                }
              </div>
            }
            @if (!asignacionSoloLectura) {
              @if (!disponiblesEmpleados.length) {
                <div class="muted small">No hay personal disponible para este día.</div>
              } @else if (!getEmpleadosDisponiblesFiltrados().length) {
                <div class="muted small">Sin resultados.</div>
              }
            }
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="canCompletarPasoEquipos()">
        <ng-template matStepLabel>
          Equipos <span class="stepper-meta">{{ getProgresoEquiposLabel(asignacionDiaId) }}</span>
        </ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Selecciona equipos disponibles</h5>
            @if (!asignacionSoloLectura) {
              @if (asignacionDiaId) {
                <div class="asignaciones-badges">
                  @for (row of getRequeridosEquiposPorTipo(asignacionDiaId); track row.tipo) {
                    <button class="badge-button" type="button" (click)="toggleFiltroTipo(row.tipo)">
                      <app-estado-badge
                        [estado]="row.tipo + ': ' + row.asignado + '/' + row.requerido"
                        [mapaColores]="getBadgeMapa(row.tipo + ': ' + row.asignado + '/' + row.requerido, row.asignado, row.requerido)"
                      ></app-estado-badge>
                    </button>
                  }
                </div>
              }
              @if (filtroTipoEquipo) {
                <div class="filtro-activo">
                  <span class="muted small">Filtro activo: {{ filtroTipoEquipo }}</span>
                  <button mat-button type="button" (click)="toggleFiltroTipo(filtroTipoEquipo)">Quitar</button>
                </div>
              }
              <div class="asignaciones-editor-form">
                <div class="equipos-resumen">
                  @for (row of getRequeridosEquiposPorTipo(asignacionDiaId); track row.tipo) {
                    @if (!filtroTipoEquipo || row.tipo === filtroTipoEquipo) {
                      <div class="equipos-row">
                        <div class="equipos-row__main">
                          <div class="equipos-row__title">{{ row.tipo }}</div>
                        <div class="equipos-row__meta">
                          <span class="meta-chip">Req: {{ row.requerido }}</span>
                          <span class="meta-chip">Asig: {{ row.asignado }}</span>
                          <span class="meta-chip">Disp: {{ getEquiposDisponiblesPorTipo(row.tipo).length }}</span>
                        </div>
                        </div>
                      <div class="equipos-row__status">
                        <app-estado-badge [estado]="row.asignado + '/' + row.requerido"></app-estado-badge>
                      </div>
                      <div class="equipos-row__actions">
                        <button mat-button type="button" (click)="toggleTipoDetalle(row.tipo)">
                          {{ isTipoDetalleAbierto(row.tipo) ? 'Ocultar' : 'Detalle' }}
                        </button>
                      </div>
                      </div>
                      @if (isTipoDetalleAbierto(row.tipo)) {
                        <div class="equipos-detalle equipos-detalle--open">
                          <div>
                            <div class="muted small">Disponibles</div>
                            <div class="equipos-detalle__filters">
                              <input
                                class="form-control form-control--compact"
                                type="text"
                                [(ngModel)]="searchEquipo"
                                name="searchEquipo-detalle"
                                placeholder="Buscar serie o modelo">
                              @if (getModelosPorTipo(row.tipo).length) {
                                <select
                                  class="form-control form-control--compact"
                                  [ngModel]="getModeloFiltro(row.tipo)"
                                  (ngModelChange)="setModeloFiltro(row.tipo, $event)">
                                  <option value="">Todos los modelos</option>
                                  @for (modelo of getModelosPorTipo(row.tipo); track modelo) {
                                    <option [value]="modelo">{{ modelo }}</option>
                                  }
                                </select>
                              }
                            </div>
                            <div class="equipos-disponibles">
                              @for (eq of getEquiposDisponiblesPorTipoFiltrados(row.tipo); track eq.equipoId) {
                                <label class="equipos-disponibles__item">
                                  <input
                                    type="checkbox"
                                    [checked]="isEquipoSeleccionado(eq.equipoId)"
                                    [disabled]="!isEquipoSeleccionado(eq.equipoId) && row.asignado >= row.requerido"
                                    (change)="toggleEquipoSeleccion(eq.equipoId, row.tipo, row.requerido)">
                                  <span>{{ eq.nombreModelo }} · {{ eq.serie }}</span>
                                </label>
                              }
                            </div>
                          </div>
                          <div>
                            <div class="muted small">Asignados</div>
                            <div class="chip-list">
                              @for (item of getEquiposAsignadosPorTipo(row.tipo); track item.equipoId) {
                                <div class="chip">
                                  <span>{{ getDisponibleEquipoLabel(item.equipoId) }}</span>
                                  <button class="chip__close" type="button" (click)="eliminarEquipo(asignacionEquipos.indexOf(item))" [disabled]="asignacionSoloLectura" aria-label="Quitar">
                                    <mat-icon>close</mat-icon>
                                  </button>
                                </div>
                              }
                            </div>
                          </div>
                        </div>
                      }
                    }
                  }
                </div>
              </div>
            } @else {
              <div class="equipos-resumen">
                @for (row of getRequeridosEquiposPorTipo(asignacionDiaId); track row.tipo) {
                  <div class="equipos-row">
                    <div class="equipos-row__main">
                      <div class="equipos-row__title">{{ row.tipo }}</div>
                      <div class="equipos-row__meta">
                        <span class="meta-chip">Req: {{ row.requerido }}</span>
                        <span class="meta-chip">Asig: {{ row.asignado }}</span>
                      </div>
                    </div>
                    <div class="equipos-row__status">
                      <app-estado-badge [estado]="row.asignado + '/' + row.requerido"></app-estado-badge>
                    </div>
                  </div>
                  <div class="chip-list">
                    @for (item of getEquiposAsignadosPorTipo(row.tipo); track item.equipoId) {
                      <div class="chip">
                        <span>{{ getDisponibleEquipoLabel(item.equipoId) }}</span>
                      </div>
                    }
                    @if (!getEquiposAsignadosPorTipo(row.tipo).length) {
                      <div class="muted small">Sin equipos asignados.</div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="canCompletarPasoResponsables()">
        <ng-template matStepLabel>Responsables</ng-template>
        <div class="asignaciones-editor-grid">
          <div class="asignaciones-editor-card">
            <h5>Asigna responsables</h5>
            @if (!asignacionEmpleados.length) {
              <p class="muted">Primero selecciona personal operativo.</p>
            } @else if (!asignacionEquipos.length) {
              <p class="muted">Primero selecciona equipos disponibles.</p>
            } @else {
              @if (asignacionSoloLectura) {
                <div class="asignaciones-meta">
                  <span class="meta-chip">Total: {{ asignacionEquipos.length }}</span>
                  <span class="meta-chip">Asignados: {{ asignacionEquipos.length - getEquiposReserva().length }}</span>
                  <span class="meta-chip">Reserva: {{ getEquiposReserva().length }}</span>
                </div>
                <div class="drag-grid">
                  <div class="drag-col">
                    <h6>Reserva</h6>
                    <div class="chip-list">
                      @for (item of getEquiposReserva(); track item.equipoId) {
                        <div class="chip">
                          <span>{{ getDisponibleEquipoLabel(item.equipoId) }}</span>
                        </div>
                      }
                      @if (!getEquiposReserva().length) {
                        <div class="muted small">Sin equipos en reserva.</div>
                      }
                    </div>
                  </div>
                  <div class="drag-col">
                    <h6>Personal</h6>
                    @for (emp of asignacionEmpleados; track emp.empleadoId) {
                      <div class="drag-panel">
                        <div class="drag-panel__title">
                          <span>{{ getDisponibleEmpleadoLabel(emp.empleadoId) }}</span>
                          <span class="drag-panel__count">{{ getEquiposCountResponsable(emp.empleadoId) }}</span>
                        </div>
                        <div class="chip-list">
                          @for (item of getEquiposPorResponsable(emp.empleadoId); track item.equipoId) {
                            <div class="chip">
                              <span>{{ getDisponibleEquipoLabel(item.equipoId) }}</span>
                            </div>
                          }
                          @if (!getEquiposPorResponsable(emp.empleadoId).length) {
                            <div class="muted small">Sin equipos asignados.</div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <div class="asignaciones-meta">
                  <span class="meta-chip">Total: {{ asignacionEquipos.length }}</span>
                  <span class="meta-chip">Asignados: {{ asignacionEquipos.length - getEquiposReserva().length }}</span>
                  <span class="meta-chip">Reserva: {{ getEquiposReserva().length }}</span>
                  <span class="meta-chip meta-chip--warn">Sin equipo: {{ getResponsablesSinEquipoCount() }}</span>
                </div>
                <div class="drag-grid" cdkDropListGroup>
                  <div class="drag-col">
                    <h6>Reserva</h6>
                    <div
                      class="drag-list drag-list--reserve"
                      [class.drop-highlight]="ultimoDropDestino === 'reserva'"
                      cdkDropList
                      id="reserva"
                      [cdkDropListDisabled]="asignacionSoloLectura"
                      [cdkDropListConnectedTo]="dropListIds"
                      (cdkDropListDropped)="onEquipoDrop($event, null)">
                      @for (grupo of getEquiposReservaPorTipo(); track grupo.tipo) {
                        <details class="reserva-grupo" open>
                          <summary class="reserva-grupo__header">
                            <span>{{ grupo.tipo }}</span>
                            <span class="meta-chip">{{ grupo.items.length }}</span>
                          </summary>
                          <div class="reserva-grupo__items">
                            @for (item of grupo.items; track item.equipoId) {
                              <div class="drag-item" cdkDrag [cdkDragData]="item" [cdkDragDisabled]="asignacionSoloLectura" [title]="getDisponibleEquipoLabel(item.equipoId)">
                                <span>{{ getDisponibleEquipoLabelSinTipo(item.equipoId) }}</span>
                                <mat-icon class="drag-handle">drag_indicator</mat-icon>
                              </div>
                            }
                          </div>
                        </details>
                      }
                    </div>
                  </div>
                  <div class="drag-col">
                    <h6>Personal</h6>
                    @for (emp of asignacionEmpleados; track emp.empleadoId) {
                      <div class="drag-panel">
                        <div class="drag-panel__title">
                          <span>{{ getDisponibleEmpleadoLabel(emp.empleadoId) }}</span>
                          <span class="drag-panel__count">{{ getEquiposCountResponsable(emp.empleadoId) }}</span>
                        </div>
                        <div
                          class="drag-list drag-list--scroll"
                          [class.drop-highlight]="ultimoDropDestino === emp.empleadoId"
                          [id]="'emp-' + emp.empleadoId"
                          [cdkDropListConnectedTo]="dropListIds"
                          cdkDropList
                          [cdkDropListDisabled]="asignacionSoloLectura"
                          (cdkDropListDropped)="onEquipoDrop($event, emp.empleadoId)">
                          @for (item of getEquiposPorResponsable(emp.empleadoId); track item.equipoId) {
                            <div class="drag-item" cdkDrag [cdkDragData]="item" [cdkDragDisabled]="asignacionSoloLectura" [title]="getDisponibleEquipoLabel(item.equipoId)">
                              <span>{{ getDisponibleEquipoLabelSinTipo(item.equipoId) }}</span>
                              <mat-icon class="drag-handle">drag_indicator</mat-icon>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        </div>
      </mat-step>
    </mat-stepper>
    }
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalAsignar()">Cerrar</button>
    @if (!asignacionSoloLectura) {
      <button mat-button type="button" (click)="asignacionesAnterior()"
        [disabled]="!canIrAnteriorAsignaciones()">
        Anterior
      </button>
      <button mat-stroked-button type="button" (click)="asignacionesSiguiente()"
        [disabled]="!canIrSiguienteAsignaciones()">
        Siguiente
      </button>
      <button mat-flat-button color="primary" type="button" (click)="guardarAsignacionesDia()"
        [disabled]="guardandoAsignaciones || !canGuardarAsignacionesFinal() || !esUltimoPasoAsignaciones()">
        {{ guardandoAsignaciones ? 'Guardando…' : 'Guardar asignaciones' }}
      </button>
    }
  </div>
</app-modal-base>

<app-modal-base
  [open]="modalIncidenciasListaAbierto"
  title="Historial de incidencias"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="cerrarModalIncidenciasDia()">
  <div class="modal-section">
    <div class="asignaciones-editor">
      <label class="form-field">
        <span class="label">Tipo</span>
        <select class="form-control" [(ngModel)]="incidenciaFiltroTipo" name="incidenciaFiltroTipo">
          <option value="">Todos</option>
          <option value="PERSONAL_NO_ASISTE">Personal no asiste</option>
          <option value="EQUIPO_FALLA_EN_EVENTO">Equipo falla en evento</option>
          <option value="EQUIPO_ROBO_PERDIDA">Equipo robo/pérdida</option>
          <option value="OTROS">Otros</option>
        </select>
      </label>
      <label class="form-field">
        <span class="label">Buscar</span>
        <input class="form-control" type="text" [(ngModel)]="incidenciaFiltroTexto" name="incidenciaFiltroTexto"
          placeholder="Tipo, descripción o afectado">
      </label>
    </div>

    <div class="incidencias-modal-list">
      @for (inc of getIncidenciasModalFiltradas(); track inc.incidenciaId) {
        <div class="incidencia-item incidencia-item--modal">
          <div class="incidencia-item__header">
            <div class="incidencia-item__tipo">{{ getIncidenciaTipoLabel(inc.tipo) }}</div>
            <span class="incidencia-severity" [ngClass]="'incidencia-severity--' + getIncidenciaSeveridad(inc)">
              {{ getIncidenciaSeveridad(inc) }}
            </span>
          </div>
          <div class="incidencia-item__meta" *ngIf="inc.empleadoNombre">
            <span class="chip chip-light">Afectado: {{ inc.empleadoNombre }}<span class="muted" *ngIf="inc.empleadoCargo"> · {{ inc.empleadoCargo }}</span></span>
            <span class="chip chip-light" *ngIf="inc.empleadoReemplazoNombre">Reemplazo: {{ inc.empleadoReemplazoNombre }}<span class="muted" *ngIf="inc.empleadoReemplazoCargo"> · {{ inc.empleadoReemplazoCargo }}</span></span>
          </div>
          <div class="incidencia-item__time">
            <span>Hora del incidente: {{ inc.fechaHoraEvento ? formatHora12(inc.fechaHoraEvento) : 'No registrada' }}</span>
          </div>
          <div class="incidencia-item__desc">{{ inc.descripcion }}</div>
        </div>
      }
      @if (!getIncidenciasModalFiltradas().length) {
        <div class="muted">No hay incidencias para los filtros seleccionados.</div>
      }
    </div>
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalIncidenciasDia()">Cerrar</button>
    @if (canCargarMasIncidenciasModal()) {
      <button mat-stroked-button type="button" (click)="cargarMasIncidenciasModal()">Cargar más</button>
    }
    <button mat-flat-button color="primary" type="button" (click)="abrirModalIncidencia(incidenciaListaDiaId || undefined)" [disabled]="!isDiaEnCurso(incidenciaListaDiaId)">
      Nueva incidencia
    </button>
  </div>
</app-modal-base>

<app-modal-base
  [open]="modalIncidenciaAbierto"
  title="Registrar incidencia"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="cerrarModalIncidencia()">

  <div class="modal-section">
    <div class="asignaciones-editor">
      <label class="form-field">
        <span class="label">Día</span>
        <select
          class="form-control"
          [ngModel]="incidenciaDiaId"
          (ngModelChange)="onIncidenciaDiaChange($event)"
          name="incidenciaDiaId"
          [disabled]="incidenciaDiaLocked">
          <option [ngValue]="null">Selecciona un día</option>
          @for (dia of detalle?.dias ?? []; track dia.diaId) {
            <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
          }
        </select>
      </label>
      <label class="form-field">
        <span class="label">Tipo</span>
        <select
          class="form-control"
          [ngModel]="incidenciaTipo"
          (ngModelChange)="onIncidenciaTipoChange($event)"
          name="incidenciaTipo">
          <option value="">Selecciona un tipo</option>
          <option value="PERSONAL_NO_ASISTE">Personal no asiste</option>
          <option value="EQUIPO_FALLA_EN_EVENTO">Equipo falla en evento</option>
          <option value="EQUIPO_ROBO_PERDIDA">Equipo robo/pérdida</option>
          <option value="OTROS">Otros</option>
        </select>
      </label>
      <label class="form-field">
        <span class="label">Hora del incidente (real)</span>
        <div class="time-picker-row">
          <select class="form-control" [(ngModel)]="incidenciaHora12" name="incidenciaHora12">
            @for (hora of incidenciaHoraOptions; track hora) {
              <option [value]="hora">{{ hora }}</option>
            }
          </select>
          <span class="time-picker-sep">:</span>
          <select class="form-control" [(ngModel)]="incidenciaMinuto" name="incidenciaMinuto">
            @for (minuto of incidenciaMinutoOptions; track minuto) {
              <option [value]="minuto">{{ minuto }}</option>
            }
          </select>
          <select class="form-control" [(ngModel)]="incidenciaAmPm" name="incidenciaAmPm">
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </div>
        <div class="muted micro">Preseleccionada con la hora actual.</div>
      </label>
    </div>

    @if (incidenciaTipo === 'PERSONAL_NO_ASISTE') {
      <div class="edit-form-grid">
        <label class="form-field">
          <span class="label">Personal afectado</span>
          <select class="form-control" [ngModel]="incidenciaEmpleadoId" (ngModelChange)="onIncidenciaEmpleadoChange($event)" name="incidenciaEmpleadoId">
            <option [ngValue]="null">Selecciona</option>
            @for (emp of getEmpleadosDiaOptions(incidenciaDiaId || 0); track emp.empleadoId) {
              <option [ngValue]="emp.empleadoId">{{ emp.empleadoNombre }}</option>
            }
          </select>
        </label>
        <label class="form-field">
          <span class="label">Reemplazo</span>
          <select class="form-control" [(ngModel)]="incidenciaEmpleadoReemplazoId" name="incidenciaEmpleadoReemplazoId" [disabled]="!incidenciaEmpleadoId || cargandoDisponiblesIncidencia">
            <option [ngValue]="null">Selecciona</option>
            @for (emp of getReemplazoEmpleadoOptions(); track emp.empleadoId) {
              <option [ngValue]="emp.empleadoId">{{ emp.empleadoNombre }}</option>
            }
          </select>
          @if (!getReemplazoEmpleadoOptions().length && incidenciaEmpleadoId) {
            <div class="muted small">No hay reemplazos disponibles con el mismo cargo para este día.</div>
          }
        </label>
      </div>
    }

    @if (incidenciaTipo === 'EQUIPO_FALLA_EN_EVENTO' || incidenciaTipo === 'EQUIPO_ROBO_PERDIDA') {
      <div class="edit-form-grid">
        <label class="form-field">
          <span class="label">Equipo afectado</span>
          <select class="form-control" [ngModel]="incidenciaEquipoId" (ngModelChange)="onIncidenciaEquipoChange($event)" name="incidenciaEquipoId">
            <option [ngValue]="null">Selecciona</option>
            @for (eq of getEquiposAfectadosOptions(incidenciaDiaId || 0); track eq.equipoId) {
              <option [ngValue]="eq.equipoId">{{ eq.label }}</option>
            }
          </select>
        </label>
        <label class="form-field">
          <span class="label">Reemplazo</span>
          <select class="form-control" [(ngModel)]="incidenciaEquipoReemplazoId" name="incidenciaEquipoReemplazoId" [disabled]="!incidenciaEquipoId || cargandoDisponiblesIncidencia">
            <option [ngValue]="null">Selecciona</option>
            @for (eq of getReemplazoEquipoOptions(); track eq.equipoId) {
              <option [ngValue]="eq.equipoId">{{ eq.label }}</option>
            }
          </select>
          @if (!getReemplazoEquipoOptions().length && incidenciaEquipoId) {
            <div class="muted small">No hay equipos disponibles del mismo tipo para este día.</div>
          }
          @if (incidenciaTipo === 'EQUIPO_ROBO_PERDIDA') {
            <div class="muted small">El reemplazo es opcional en robo/pérdida.</div>
          }
        </label>
      </div>
    }

    <label class="form-field">
      <span class="label">Descripción</span>
      <textarea
        class="form-control"
        rows="3"
        [(ngModel)]="incidenciaDescripcion"
        name="incidenciaDescripcion"
        placeholder="Describe la incidencia"></textarea>
    </label>
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalIncidencia()">Cancelar</button>
    <button mat-flat-button color="primary" type="button" (click)="guardarIncidencia()"
      [disabled]="guardandoIncidencia || !canGuardarIncidencia()">
      {{ guardandoIncidencia ? 'Guardando…' : 'Registrar incidencia' }}
    </button>
  </div>
</app-modal-base>

<app-modal-base
  [open]="modalDevolucionAbierto"
  title="Registrar devoluciones"
  [useDefaultFooter]="false"
  size="lg"
  (closed)="cerrarModalDevolucion()">

  <div class="modal-section">
    <div class="asignaciones-editor">
      <label class="form-field">
        <span class="label">Día del proyecto</span>
        <select class="form-control" [ngModel]="devolucionDiaId" (ngModelChange)="onDevolucionDiaChange($event)">
          <option [ngValue]="null">Selecciona un día</option>
          @for (dia of getDiasDevolucionPendientes(); track dia.diaId) {
            <option [ngValue]="dia.diaId">{{ formatFechaLarga(dia.fecha) }}</option>
          }
        </select>
      </label>
      <p class="muted small">Se prellena como <strong>Devuelto</strong> para agilizar el cierre diario. Ajusta solo excepciones (dañado, perdido, robado).</p>
      @if (!getDiasDevolucionPendientes().length) {
        <p class="muted small">No hay días pendientes de devolución.</p>
      }
    </div>
    @if (devolucionDiaId) {
      <div class="devolucion-toolbar">
        <div class="devolucion-kpis">
          <span class="meta-chip">Total: {{ getResumenDevolucionDia(devolucionDiaId).total }}</span>
          <span class="meta-chip">Devueltos: {{ getResumenDevolucionDia(devolucionDiaId).devueltos }}</span>
          <span class="meta-chip meta-chip--warn">Excepciones: {{ getResumenDevolucionDia(devolucionDiaId).excepciones }}</span>
        </div>
        <div class="chip-toggle-group">
          <button type="button" class="chip-toggle"
            [class.is-active]="!mostrarSoloExcepcionesDevolucion"
            (click)="mostrarSoloExcepcionesDevolucion = false">
            Todas
          </button>
          <button type="button" class="chip-toggle"
            [class.is-active]="mostrarSoloExcepcionesDevolucion"
            [disabled]="getResumenDevolucionDia(devolucionDiaId).excepciones === 0"
            (click)="mostrarSoloExcepcionesDevolucion = true">
            Excepciones
          </button>
        </div>
      </div>
      <div class="asignaciones-editor">
        <label class="form-field">
          <span class="label">Responsable</span>
          <select class="form-control" [(ngModel)]="devolucionFiltroResponsable">
            <option value="">Todos</option>
            @for (nombre of getResponsablesDevolucionOptions(devolucionDiaId); track nombre) {
              <option [value]="nombre">{{ nombre }}</option>
            }
          </select>
        </label>
        <label class="form-field">
          <span class="label">Buscar equipo</span>
          <input class="form-control" type="text" [(ngModel)]="devolucionBusqueda" placeholder="Modelo, serie o tipo">
        </label>
      </div>
      <div class="devolucion-grid">
        @for (grupo of getGruposDevolucion(devolucionDiaId); track grupo.key) {
          <details class="devolucion-grupo" [open]="isGrupoDevolucionAbierto(grupo.key)" (toggle)="onToggleGrupoDevolucion(grupo.key, $event)">
            <summary class="devolucion-grupo__header">
              <div>
                <div class="devolucion-grupo__title">{{ grupo.responsable }}</div>
                <div class="muted small">Equipos: {{ getResumenGrupoDevolucion(grupo.items).total }} · Excepciones: {{ getResumenGrupoDevolucion(grupo.items).excepciones }}</div>
              </div>
              <div class="devolucion-grupo__actions">
                <button mat-stroked-button type="button" (click)="$event.stopPropagation(); marcarGrupoDevuelto(grupo.items)">
                  Marcar grupo devuelto
                </button>
              </div>
            </summary>

            <div class="devolucion-grupo__body">
              @for (eq of grupo.items; track eq.equipoId) {
              <div class="devolucion-row" [ngClass]="{
                'devolucion-row--ok': getEstadoDevolucionActual(eq.equipoId) === 'DEVUELTO',
                'devolucion-row--alert': getEstadoDevolucionActual(eq.equipoId) === 'DANADO' || getEstadoDevolucionActual(eq.equipoId) === 'PERDIDO' || getEstadoDevolucionActual(eq.equipoId) === 'ROBADO'
              }">
                <div class="devolucion-info">
                  <div class="devolucion-title">{{ eq.modelo || 'Equipo' }} ({{ eq.equipoSerie || '—' }})</div>
                  <div class="muted small">{{ eq.tipoEquipo }}</div>
                </div>
                <div class="devolucion-form">
                  <label class="form-field small">
                    <span class="label">Estado</span>
                    <div class="estado-selector">
                      <button type="button" class="estado-btn" [class.is-active]="getEstadoDevolucionActual(eq.equipoId) === 'DEVUELTO'"
                        (click)="onDevolucionEstadoChange(eq.equipoId, 'DEVUELTO')">Devuelto</button>
                      <button type="button" class="estado-btn estado-btn--warn" [class.is-active]="getEstadoDevolucionActual(eq.equipoId) === 'DANADO'"
                        (click)="onDevolucionEstadoChange(eq.equipoId, 'DANADO')">Dañado</button>
                      <button type="button" class="estado-btn estado-btn--danger" [class.is-active]="getEstadoDevolucionActual(eq.equipoId) === 'PERDIDO'"
                        (click)="onDevolucionEstadoChange(eq.equipoId, 'PERDIDO')">Perdido</button>
                      <button type="button" class="estado-btn estado-btn--danger" [class.is-active]="getEstadoDevolucionActual(eq.equipoId) === 'ROBADO'"
                        (click)="onDevolucionEstadoChange(eq.equipoId, 'ROBADO')">Robado</button>
                    </div>
                  </label>
                  <label class="form-field small">
                    <span class="label">Fecha</span>
                    <input class="form-control" type="datetime-local" [ngModel]="devolucionDraft[eq.equipoId]?.fecha || ''" (ngModelChange)="onDevolucionFechaChange(eq.equipoId, $event)">
                    <div class="muted micro">Prellenado con fecha/hora actual.</div>
                  </label>
                  <label class="form-field small">
                    <span class="label">Notas</span>
                    <textarea class="form-control" rows="2" [ngModel]="devolucionDraft[eq.equipoId]?.notas || ''" (ngModelChange)="onDevolucionNotasChange(eq.equipoId, $event)" placeholder="Solo si hubo alguna incidencia en la devolución"></textarea>
                  </label>
                </div>
              </div>
              }
            </div>
          </details>
        }
        @if (!getGruposDevolucion(devolucionDiaId).length) {
          <div class="muted">No hay equipos asignados en este día.</div>
        }
      </div>
    }
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalDevolucion()">Cerrar</button>
    <button mat-stroked-button type="button" (click)="marcarTodosDevueltos()"
      [disabled]="!isDiaFinalizado(devolucionDiaId) || !devolucionDiaId || !isDiaPendienteDevolucion(devolucionDiaId) || !getEquiposDevolucionDia(devolucionDiaId).length">
      Marcar todo devuelto
    </button>
    <button mat-flat-button color="primary" type="button" (click)="guardarDevoluciones()"
      [disabled]="guardandoDevolucion || !canGuardarDevoluciones()">
      {{ guardandoDevolucion ? 'Guardando…' : 'Guardar devoluciones' }}
    </button>
  </div>
</app-modal-base>

<ng-template #loadingState>
  <mat-spinner diameter="40"></mat-spinner>
  <p>Cargando proyecto…</p>
</ng-template>

