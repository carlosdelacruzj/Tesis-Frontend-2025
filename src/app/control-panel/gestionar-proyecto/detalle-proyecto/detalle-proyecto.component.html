<div class="dashboard-content">
  <app-list-toolbar
    [title]="proyecto?.proyectoNombre || 'Proyecto'"
    [showSearch]="false"
    [showCreateButton]="false">
  </app-list-toolbar>

  <ng-container *ngIf="loading; else loaded">
    <div class="estado-centro">
      <ng-container *ngTemplateOutlet="loadingState"></ng-container>
    </div>
  </ng-container>

  <ng-template #loaded>
    <ng-container *ngIf="proyecto; else errorState">
      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Proyecto #{{ proyecto.proyectoId }}</p>
            <h2>{{ proyecto.proyectoNombre }}</h2>
          </div>
          <div class="estado">
            <span class="label">Estado</span>
            <span class="pill">{{ proyecto.estadoNombre || '—' }}</span>
          </div>
        </header>

        <div class="info-grid">
          <div>
            <p class="label">Pedido</p>
            <p class="value">#{{ proyecto.pedidoId }}</p>
          </div>
          <div>
            <p class="label">Responsable</p>
            <p class="value">{{ proyecto.responsableNombre || '—' }}</p>
          </div>
          <div>
            <p class="label">Inicio edición</p>
            <p class="value">{{ formatFechaDisplay(proyecto.fechaInicioEdicion) }}</p>
          </div>
          <div>
            <p class="label">Fin edición</p>
            <p class="value">{{ formatFechaDisplay(proyecto.fechaFinEdicion) }}</p>
          </div>
          <div>
            <p class="label">Enlace</p>
            <p class="value">{{ proyecto.enlace || '—' }}</p>
          </div>
          <div>
            <p class="label">Notas</p>
            <p class="value">{{ proyecto.notas || '—' }}</p>
          </div>
          <div>
            <p class="label">Edición</p>
            <p class="value">{{ proyecto.edicion ?? '—' }}</p>
          </div>
          <div>
            <p class="label">Multimedia</p>
            <p class="value">{{ proyecto.multimedia ?? '—' }}</p>
          </div>
          <div>
            <p class="label">Creado</p>
            <p class="value">{{ formatFechaDisplay(proyecto.createdAt) }}</p>
          </div>
          <div>
            <p class="label">Actualizado</p>
            <p class="value">{{ formatFechaDisplay(proyecto.updatedAt) }}</p>
          </div>
        </div>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Edición rápida</p>
            <h3>Actualizar proyecto</h3>
            <p class="muted small">Cambia el estado, fechas o campos básicos y guarda con PATCH.</p>
          </div>
          <button mat-flat-button color="primary" type="button" (click)="guardarProyecto()" [disabled]="guardandoProyecto">
            Guardar cambios
          </button>
        </header>
        <form class="edit-form" [formGroup]="proyectoForm" (ngSubmit)="guardarProyecto()">
          <div class="edit-form-grid">
            <label class="form-field">
              <span class="label">Nombre</span>
              <input class="form-control" type="text" formControlName="proyectoNombre" placeholder="Nombre del proyecto">
            </label>
            <label class="form-field">
              <span class="label">Estado</span>
              <select class="form-select" formControlName="estadoId">
                <option [ngValue]="null" disabled>Selecciona estado</option>
                <option *ngFor="let est of estados" [ngValue]="est.estadoId" [disabled]="deshabilitarPlanificadoOption(est.estadoId)">
                  {{ est.estadoNombre }}
                </option>
              </select>
            </label>
            <label class="form-field">
              <span class="label">Responsable (ID)</span>
              <input class="form-control" type="number" formControlName="responsableId" placeholder="ID o deja vacío">
            </label>
            <label class="form-field">
              <span class="label">Inicio edición</span>
              <input class="form-control" type="date" formControlName="fechaInicioEdicion">
            </label>
            <label class="form-field">
              <span class="label">Fin edición</span>
              <input class="form-control" type="date" formControlName="fechaFinEdicion">
            </label>
            <label class="form-field">
              <span class="label">Enlace</span>
              <input class="form-control" type="url" formControlName="enlace" placeholder="https://">
            </label>
            <label class="form-field">
              <span class="label">Multimedia</span>
              <input class="form-control" type="number" formControlName="multimedia" placeholder="Ej. 3">
            </label>
            <label class="form-field">
              <span class="label">Edición</span>
              <input class="form-control" type="number" formControlName="edicion" placeholder="Ej. 2">
            </label>
          </div>
          <label class="form-field">
            <span class="label">Notas</span>
            <textarea class="form-control" rows="2" formControlName="notas" placeholder="Observaciones"></textarea>
          </label>
          <div class="acciones">
            <button mat-flat-button color="primary" type="submit" [disabled]="guardandoProyecto">
              Guardar cambios
            </button>
          </div>
        </form>
      </section>

      <section class="card" *ngIf="getEventosPedido().length">
        <header class="card-header">
          <div>
            <p class="eyebrow">Locaciones</p>
            <h3>Locaciones ({{ getEventosPedido().length }})</h3>
            <p class="muted small" *ngIf="getPedidoRangoFechas() as rango">
              Fechas: {{ formatFechaDisplay(rango.inicio) }} → {{ formatFechaDisplay(rango.fin) }}
            </p>
          </div>
        </header>
        <app-table-base
          [data]="getEventosPedido()"
          [columns]="eventosColumns"
          [showCreateButton]="false"
          [showSearch]="false"
          [showPagination]="false"
          [showFooterInfo]="false">
          <ng-template appCell="fecha" let-row>
            {{ formatFechaDisplay(row.fecha) }}
          </ng-template>
        </app-table-base>
      </section>

      <section class="card" *ngIf="getServiciosContratados().length">
        <header class="card-header">
          <div>
            <p class="eyebrow">Servicios contratados</p>
            <h3>Servicios ({{ getServiciosContratados().length }})</h3>
          </div>
        </header>
        <app-table-base
          [data]="getServiciosContratados()"
          [columns]="serviciosColumns"
          [showCreateButton]="false"
          [showSearch]="false"
          [showPagination]="false"
          [showFooterInfo]="false">
          <ng-template appCell="precio" let-row>
            {{ row.precio | currency:'PEN':'symbol-narrow':'1.2-2' }}
          </ng-template>
        </app-table-base>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Recursos y staff</p>
            <h3>Asignaciones ({{ proyecto.recursos?.length || 0 }})</h3>
          </div>
          <button *ngIf="esPlanificadoActual()" mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar()">
            Asignar recursos
          </button>
        </header>
        <p class="muted small" *ngIf="!esPlanificadoActual()">Las asignaciones solo se gestionan en estado Planificado.</p>

        <ng-container *ngIf="proyecto.recursos?.length; else sinRecursos">
          <app-table-base
            [data]="proyecto.recursos | orderByEmpleado"
            [columns]="recursosColumns"
            [pageSize]="10"
            [pageSizeOptions]="[5,10,20]"
            [showCreateButton]="false"
            [showFooterInfo]="true"
            [showSearch]="false"
            [showPagination]="false">
            <ng-template appCell="empleadoNombre" let-row>
              <ng-container *ngIf="row.empleadoNombre; else reservaTag">
                {{ row.empleadoNombre }}
              </ng-container>
              <ng-template #reservaTag>
                <span class="pill pill-muted">Reserva / Repuesto</span>
              </ng-template>
            </ng-template>
          </app-table-base>
        </ng-container>
      </section>

      <section class="card" *ngIf="proyecto.recursos?.length && !esPlanificadoActual()">
        <header class="card-header">
          <div>
            <p class="eyebrow">Seguimiento</p>
            <h3>Devolución de equipos</h3>
            <p class="muted small">Marca el estado al cierre del proyecto y agrega notas si falta o está dañado.</p>
          </div>
        </header>
        <div class="alert alert-info" *ngIf="devolucionesRegistradas">
          Las devoluciones ya fueron registradas y no se pueden volver a enviar.
        </div>
        <p class="muted small" *ngIf="!devolucionesRegistradas && !esEjecucionActual()">Solo lectura: la devolución se gestiona en estado Ejecución.</p>
        <form class="devolucion-form" [formGroup]="devolucionForm" (ngSubmit)="guardarDevoluciones()">
          <div class="devolucion-grid" formArrayName="devoluciones">
            <div
              class="devolucion-card"
              *ngFor="let devolucion of devoluciones.controls; let i = index"
              [formGroupName]="i"
              [class.dev-disabled]="!puedeRegistrarDevolucion()">
              <div class="dev-card-header">
                <div>
                  <div class="dev-title">{{ getEquipoLabel(devolucion.get('equipoId')?.value) }}</div>
                  <div class="muted small">{{ getEquipoAsignadoA(devolucion.get('equipoId')?.value) }}</div>
                </div>
                <span [ngClass]="getEstadoClass(devolucion.get('estadoDevolucion')?.value)">
                  {{ getEstadoLabel(devolucion.get('estadoDevolucion')?.value) || 'Sin estado' }}
                </span>
              </div>
              <div class="dev-card-body">
                <div class="estado-pills" role="group">
                  <button
                    type="button"
                    class="estado-pill"
                    *ngFor="let estado of estadosDevolucion"
                    [class.active]="devolucion.get('estadoDevolucion')?.value === estado.value"
                    [disabled]="!puedeRegistrarDevolucion()"
                    (click)="setEstadoDevolucion(i, estado.value)">
                    {{ estado.label }}
                  </button>
                </div>
                <div class="form-field">
                  <label class="label">Notas <span class="muted">(obligatorio si está dañado o faltante)</span></label>
                  <textarea
                    class="form-control"
                    rows="2"
                    placeholder="Observaciones (ej. golpe en lente)"
                    formControlName="notas"
                    [readonly]="!puedeRegistrarDevolucion()"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="acciones">
            <button mat-flat-button color="primary" type="submit" [disabled]="guardandoDevoluciones || !puedeRegistrarDevolucion()">
              Registrar devoluciones
            </button>
          </div>
        </form>
      </section>
    </ng-container>
  </ng-template>
</div>

<app-modal-base
  [open]="modalAsignarAbierto"
  title="Asignar personal y equipos"
  [useDefaultFooter]="false"
  size="xl"
  (closed)="cerrarModalAsignar()">

  <div class="stepper">
    <button type="button" class="step" [class.active]="stepIndex === 0" (click)="irAlPaso(0)">1. Personal</button>
    <button type="button" class="step" [class.active]="stepIndex === 1" (click)="irAlPaso(1)">2. Equipos</button>
    <button type="button" class="step" [class.active]="stepIndex === 2" (click)="irAlPaso(2)">3. Asignación</button>
  </div>

  <div class="modal-content-grid">
    <div *ngIf="stepIndex === 0">
      <p class="eyebrow">Personal operativo</p>
      <div class="req-resumen" *ngIf="requerimientos?.totales?.personal?.length">
        <div class="req-pill" *ngFor="let req of requerimientos.totales.personal"
             [class.req-completo]="getSeleccionadosPorRol(req.rol) >= req.cantidad">
          <div class="fw-semibold">{{ req.rol }}</div>
          <div class="muted small">{{ getSeleccionadosPorRol(req.rol) }}/{{ req.cantidad }} requeridos</div>
        </div>
      </div>
      <div class="dual-panel">
        <div class="panel">
            <div class="panel-header">
              <div>
                <span class="label d-block">Disponibles</span>
              </div>
              <select class="form-select form-select-sm" [(ngModel)]="filtroRol">
                <option [ngValue]="null">Todos los roles</option>
                <option *ngFor="let rol of rolesOperativos" [ngValue]="rol">
                  {{ rol }}
                </option>
              </select>
            </div>
          <div class="lista">
            <label *ngFor="let p of getPersonalFiltrado()" class="item-selectable">
              <input type="checkbox" [checked]="seleccionados.includes(p.empleadoId)" (change)="toggleSeleccionEmpleado(p.empleadoId)" [disabled]="isEmpleadoDisabled(p)">
              <div>
                <div class="fw-semibold">{{ p.nombre }} {{ p.apellido }}</div>
                <div class="text-muted small">{{ p.cargo }}</div>
              </div>
            </label>
          </div>
        </div>
        <div class="panel">
            <div class="panel-header">
              <div>
                <span class="label d-block">Seleccionados</span>
                <span class="muted small">Total: {{ seleccionados.length }}</span>
              </div>
          </div>
          <div class="lista">
            <div class="item-selectable selected-item" *ngFor="let id of seleccionados">
              <div>
                <div class="fw-semibold">{{ getNombreEmpleado(id) }}</div>
                <div class="text-muted small">
                  {{ getCargoEmpleado(id) }}
                </div>
              </div>
              <button type="button" class="remove-btn" (click)="quitarSeleccion(id)">Quitar</button>
            </div>
            <p class="muted" *ngIf="!seleccionados.length">Aún no seleccionas personal.</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="stepIndex === 1">
      <p class="eyebrow">Equipos requeridos</p>
      <div class="req-resumen" *ngIf="requerimientos?.totales?.equipos?.length">
        <div class="req-pill" *ngFor="let req of requerimientos.totales.equipos"
             [class.req-completo]="getSeleccionadosEquipoPorTipo(req.tipoEquipoId) >= req.cantidad">
          <div class="fw-semibold">{{ req.tipoEquipo }}</div>
          <div class="muted small">{{ getSeleccionadosEquipoPorTipo(req.tipoEquipoId) }}/{{ req.cantidad }} requeridos</div>
        </div>
      </div>

      <div class="dual-panel">
        <div class="panel">
          <div class="panel-header">
            <div>
              <span class="label d-block">Disponibles</span>
            </div>
            <select class="form-select form-select-sm" [(ngModel)]="filtroTipoEquipoId">
              <option [ngValue]="null">Todos los tipos</option>
              <option *ngFor="let tipo of tiposEquipo" [ngValue]="tipo.idTipoEquipo">
                {{ tipo.nombre }}
              </option>
            </select>
          </div>
          <div class="lista">
            <label *ngFor="let e of getEquiposFiltrados()" class="item-selectable">
              <input type="checkbox" [checked]="selectedEquipos.includes(e.idEquipo)" (change)="toggleSeleccionEquipo(e.idEquipo)" [disabled]="isEquipoDisabled(e)">
              <div>
                <div class="fw-semibold">{{ e.nombreModelo }} ({{ e.nombreTipoEquipo }})</div>
                <div class="text-muted small">Serie: {{ e.serie }}</div>
              </div>
            </label>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div>
              <span class="label d-block">Seleccionados</span>
              <span class="muted small">Total: {{ selectedEquipos.length }}</span>
            </div>
          </div>
          <div class="lista">
            <div class="item-selectable selected-item" *ngFor="let id of selectedEquipos">
              <div>
                <div class="fw-semibold">{{ getEquipoLabel(id) }}</div>
                <div class="text-muted small">
                  {{ getTipoEquipoNombre(id) }}
                </div>
              </div>
              <button type="button" class="remove-btn" (click)="toggleSeleccionEquipo(id)">Quitar</button>
            </div>
            <p class="muted" *ngIf="!selectedEquipos.length">Aún no seleccionas equipos.</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="stepIndex === 2">
      <p class="eyebrow">Asignar equipos (Drag & Drop)</p>
      <div class="kanban-layout">
        <div class="kanban-column kanban-reserva">
          <div class="kanban-header">
            <div class="fw-semibold">Sin asignar / Reserva</div>
            <div class="muted small">{{ getListaReserva().length }} equipo(s)</div>
          </div>
          <div
            cdkDropList
            id="reserva"
            [cdkDropListConnectedTo]="getDropConnections('reserva')"
            [cdkDropListData]="getListaReserva()"
            class="kanban-dropzone"
            (cdkDropListDropped)="dropEquipo($event, 'reserva')">
            <div class="kanban-card" *ngFor="let eqId of getListaReserva()" cdkDrag>
              <div class="fw-semibold">{{ getEquipoLabel(eqId) }}</div>
              <div class="muted small">{{ getTipoEquipoNombre(eqId) }}</div>
            </div>
            <p class="muted" *ngIf="!getListaReserva().length">Arrastra equipos aquí para dejarlos en reserva.</p>
          </div>
        </div>

        <div class="kanban-empleados-grid">
          <div class="kanban-column" *ngFor="let id of seleccionados">
            <div class="kanban-header">
              <div class="fw-semibold">{{ getNombreEmpleado(id) }}</div>
              <div class="muted small">{{ getCargoEmpleado(id) }}</div>
              <div class="muted small">{{ getListaEmpleado(id).length }} equipo(s)</div>
            </div>
            <div
              cdkDropList
              [id]="'emp-' + id"
              [cdkDropListConnectedTo]="getDropConnections('emp-' + id)"
              [cdkDropListData]="getListaEmpleado(id)"
              class="kanban-dropzone"
              (cdkDropListDropped)="dropEquipo($event, id)">
              <div class="kanban-card" *ngFor="let eqId of getListaEmpleado(id)" cdkDrag>
                <div class="fw-semibold">{{ getEquipoLabel(eqId) }}</div>
                <div class="muted small">{{ getTipoEquipoNombre(eqId) }}</div>
              </div>
              <p class="muted" *ngIf="!getListaEmpleado(id).length">Arrastra equipos aquí para asignarlos.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="alert alert-warning mt-2" *ngIf="faltanAsignaciones()">
        Asigna al menos un equipo a cada empleado; los demás pueden quedar en reserva.
      </div>
    </div>

  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalAsignar()">Cancelar</button>
    <button mat-button type="button" (click)="retrocederPaso()" *ngIf="stepIndex > 0">Atrás</button>
    <button mat-flat-button color="primary" type="button" *ngIf="stepIndex < 2" (click)="avanzarPaso()" [disabled]="(stepIndex === 0 && !seleccionados.length) || (stepIndex === 1 && !selectedEquipos.length)">
      Siguiente
    </button>
    <button mat-flat-button color="primary" type="button" *ngIf="stepIndex === 2" (click)="guardarAsignacionesEnModal()" [disabled]="faltanAsignaciones()">
      Guardar
    </button>
  </div>
</app-modal-base>

<ng-template #loadingState>
  <mat-spinner diameter="40"></mat-spinner>
  <p>Cargando proyecto…</p>
</ng-template>

<ng-template #sinRecursos>
  <p class="muted">Sin recursos asignados.</p>
</ng-template>

<ng-template #errorState>
  <p class="estado-centro" *ngIf="error">{{ error }}</p>
</ng-template>

<ng-template #devolucionBloqueada>
  <div>
    <p class="muted">La devolución solo está disponible cuando el proyecto está en Ejecución.</p>
  </div>
</ng-template>
