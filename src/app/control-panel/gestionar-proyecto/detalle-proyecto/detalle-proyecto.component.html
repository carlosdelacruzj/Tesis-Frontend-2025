<div class="dashboard-content">
  <app-list-toolbar
    [title]="proyecto?.proyectoNombre || 'Proyecto'"
    [showSearch]="false"
    [showCreateButton]="false">
  </app-list-toolbar>

  @if (loading) {
    <div class="estado-centro">
      <ng-container *ngTemplateOutlet="loadingState"></ng-container>
    </div>
  } @else {
    @if (proyecto) {
      <section class="card hero">
        <header class="card-header">
          <div>
            <p class="eyebrow">Proyecto #{{ proyecto.proyectoId }}</p>
            <h2 class="title">{{ proyecto.proyectoNombre }}</h2>
            <p class="muted small">Pedido #{{ proyecto.pedidoCodigo || proyecto.pedidoId }}</p>
          </div>
          <div class="estado">
            <span class="label">Estado</span>
            <app-estado-badge
              [estado]="proyecto.estadoNombre || '—'"
              [mapaColores]="{
                'planificado': 'info',
                'en ejecucion': 'warning',
                'en ejecución': 'warning',
                'entregado': 'success-light',
                'cerrado': 'success'
              }"
            ></app-estado-badge>
          </div>
        </header>

        <div class="stat-grid">
          <div class="stat-card">
            <p class="stat-label">Responsable</p>
            <p class="stat-value">{{ proyecto.responsableId || '—' }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Inicio edición</p>
            <p class="stat-value">{{ formatFechaDisplay(proyecto.fechaInicioEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Fin edición</p>
            <p class="stat-value">{{ formatFechaDisplay(proyecto.fechaFinEdicion) }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Enlace</p>
            <p class="stat-value">
              @if (proyecto.enlace) {
                <a class="link" [href]="proyecto.enlace" target="_blank" rel="noopener">Abrir enlace</a>
              } @else {
                —
              }
            </p>
          </div>
        </div>

        <div class="ops-bar">
          <div class="ops-chip">
            <span>Días</span>
            <strong>{{ totalDias }}</strong>
          </div>
          <div class="ops-chip">
            <span>Servicios</span>
            <strong>{{ totalServiciosDia }}</strong>
          </div>
          <div class="ops-chip">
            <span>Personal</span>
            <strong>{{ totalEmpleadosDia }}</strong>
          </div>
          <div class="ops-chip">
            <span>Equipos</span>
            <strong>{{ totalEquiposDia }}</strong>
          </div>
          <div class="ops-chip ops-alert">
            <span>Pendientes</span>
            <strong>{{ pendientesTotales.personal + pendientesTotales.equipos }}</strong>
          </div>
        </div>

        @if (proyecto.notas) {
          <div class="note-box">
            <div class="note-title">Notas</div>
            <p class="note-text">{{ proyecto.notas }}</p>
          </div>
        }
      </section>

      <section class="card section sticky-actions">
        <header class="card-header">
          <div>
            <p class="eyebrow">Edición rápida</p>
            <h3>Actualizar proyecto</h3>
            <p class="muted small">Actualiza responsable, enlace o notas.</p>
          </div>
          <button mat-flat-button color="primary" type="button" (click)="guardarProyecto()" [disabled]="guardandoProyecto">
            Guardar cambios
          </button>
        </header>
        <form class="edit-form" [formGroup]="proyectoForm" (ngSubmit)="guardarProyecto()">
          <div class="edit-form-grid">
            <label class="form-field">
              <span class="label">Responsable (ID)</span>
              <input class="form-control" type="number" formControlName="responsableId" placeholder="ID o deja vacío">
            </label>
            <label class="form-field">
              <span class="label">Enlace</span>
              <input class="form-control" type="url" formControlName="enlace" placeholder="https://">
            </label>
          </div>
          <label class="form-field">
            <span class="label">Notas</span>
            <textarea class="form-control" rows="2" formControlName="notas" placeholder="Observaciones"></textarea>
          </label>
          <div class="acciones">
            <button mat-flat-button color="primary" type="submit" [disabled]="guardandoProyecto">
              Guardar cambios
            </button>
          </div>
        </form>
      </section>

      @if (detalle && detalle.dias?.length) {
      <section class="card section">
        <header class="card-header">
          <div>
            <p class="eyebrow">Agenda</p>
            <h3>Días de proyecto ({{ detalle.dias.length }})</h3>
            <p class="muted small">Ordenado por fecha</p>
          </div>
          <button class="toggle-btn" type="button" (click)="toggleSoloPendientes()">
            @if (soloPendientes) { Ver todos } @else { Solo con pendientes }
          </button>
        </header>
        <div class="timeline">
          @for (dia of diasTimeline; track dia.diaId) {
            <details
              class="timeline-item"
              [open]="openDiaId === dia.diaId"
              (toggle)="onToggleDia(dia.diaId, $event)">
              <summary class="timeline-summary">
                <div class="timeline-date">
                  <div class="timeline-date__title">{{ formatFechaLarga(dia.fecha) }}</div>
                  <div class="timeline-date__meta">
                    Bloques: {{ getBloquesCount(dia.diaId) }}
                    · Servicios: {{ getServiciosCountDia(dia.diaId) }}
                    · Personal: {{ getAsignadosPersonalDia(dia.diaId) }}/{{ getReqPersonalCountDia(dia.diaId) }}
                    · Equipos: {{ getAsignadosEquiposDia(dia.diaId) }}/{{ getReqEquiposCountDia(dia.diaId) }}
                  </div>
                  @if (getRangoHorasDia(dia.diaId); as rango) {
                    <div class="timeline-date__range">{{ rango.inicio }} – {{ rango.fin }}</div>
                  }
                  <div class="timeline-badges">
                    <app-estado-badge
                      [estado]="dia.estadoDiaNombre || '—'"
                      [mapaColores]="{
                        'planificado': 'info',
                        'en ejecucion': 'warning',
                        'en ejecución': 'warning',
                        'pendiente': 'warning',
                        'entregado': 'success-light',
                        'cerrado': 'success'
                      }"
                    ></app-estado-badge>
                    @if (getEstadoAsignacionDia(dia.diaId) !== '—') {
                      <span
                        class="badge"
                        [ngClass]="{
                          'badge-warning': getEstadoAsignacionDia(dia.diaId) === 'Pendiente',
                          'badge-success': getEstadoAsignacionDia(dia.diaId) === 'Completo',
                          'badge-muted': getEstadoAsignacionDia(dia.diaId) === 'Sin asignar'
                        }">
                        {{ getEstadoAsignacionDia(dia.diaId) }}
                      </span>
                    }
                  </div>
                  <div class="timeline-summary__hint">Ver detalle</div>
                </div>
                <div class="timeline-dot"></div>
              </summary>
              <div class="timeline-content">
                <div class="locacion-list">
                  @for (bloque of getBloquesDia(dia.diaId); track bloque.bloqueId) {
                    <div class="locacion-card">
                      <div class="locacion-card__time">{{ formatHora12(bloque.hora) }}</div>
                      <div class="locacion-card__body">
                        <div class="locacion-card__title">{{ bloque.ubicacion || '—' }}</div>
                        <div class="locacion-card__meta">{{ bloque.direccion || '—' }}</div>
                        @if (bloque.notas) {
                          <div class="locacion-card__notes">{{ bloque.notas }}</div>
                        }
                      </div>
                    </div>
                  }
                </div>
                <div class="servicios-dia">
                  <div class="servicios-dia__header">
                    <span class="label">Servicios contratados</span>
                    <span class="muted small">{{ getServiciosDia(dia.diaId).length }} ítem(s)</span>
                  </div>
                  @if (getServiciosDia(dia.diaId).length) {
                    <div class="servicios-dia__list">
                      @for (serv of getServiciosDia(dia.diaId); track serv.id) {
                        <div class="servicio-chip" [ngClass]="getServiceColorClass(serv.nombre)">
                          <div class="servicio-chip__title">{{ serv.nombre || '—' }}</div>
                        </div>
                      }
                    </div>
                  } @else {
                    <p class="muted">Sin servicios asignados a este día.</p>
                  }
                  <div class="pendientes-dia">
                    <span class="muted small">Pendientes</span>
                    <span class="pill pill-muted">Personal: {{ getPendientesDia(dia.diaId).personal }}</span>
                    <span class="pill pill-muted">Equipos: {{ getPendientesDia(dia.diaId).equipos }}</span>
                  </div>
                  <div class="pendientes-detalle">
                    <div class="pendientes-col">
                      <div class="pendientes-title">Personal por rol</div>
                      @if (!isRolDataDisponible(dia.diaId)) {
                        <div class="muted small">Sin roles en asignaciones aún.</div>
                      }
                      @for (row of getPendientesPersonalPorRol(dia.diaId); track row.rol) {
                        <div class="pendiente-row">
                          <span>{{ row.rol }}</span>
                          <strong>{{ row.pendiente }}</strong>
                        </div>
                      }
                    </div>
                    <div class="pendientes-col">
                      <div class="pendientes-title">Equipos por tipo</div>
                      @for (row of getPendientesEquiposPorTipo(dia.diaId); track row.tipo) {
                        <div class="pendiente-row">
                          <span>{{ row.tipo }}</span>
                          <strong>{{ row.pendiente }}</strong>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </details>
          }
        </div>
      </section>
      }

      @if ((detalle?.empleadosDia?.length || detalle?.equiposDia?.length) || (detalle?.requerimientosPersonalDia?.length || detalle?.requerimientosEquipoDia?.length)) {
      <section class="card section">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div>
              <p class="eyebrow">Asignaciones</p>
              <h3>Personal y equipos</h3>
              <p class="muted small">Vista actual desde el servicio /proyecto/:id.</p>
            </div>
            <div class="collapsible__actions">
              <button mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar()">
                Ver/gestionar asignaciones
              </button>
              <span class="collapsible__caret">▾</span>
            </div>
          </summary>

          <div class="asignaciones-grid">
            <div class="asignaciones-panel">
              <h4>Personal por día</h4>
              @if (detalle.empleadosDia?.length) {
                <div class="asignaciones-list">
                  @for (item of detalle.empleadosDia; track item.asignacionId) {
                    <div class="asignacion-card">
                      <div class="asignacion-meta">
                        <div class="asignacion-title">{{ item.empleadoNombre || '—' }}</div>
                        <div class="muted small">{{ formatFechaLarga(item.fecha) }}</div>
                      </div>
                      <div class="asignacion-body">
                        <div class="muted small">Estado: {{ item.estado || '—' }}</div>
                        @if (item.notas) {
                          <div class="asignacion-notas">{{ item.notas }}</div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="muted">Sin personal asignado.</p>
                <button mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar()">
                  Asignar ahora
                </button>
              }
            </div>

            <div class="asignaciones-panel">
              <h4>Equipos por día</h4>
              @if (detalle.equiposDia?.length) {
                <div class="asignaciones-list">
                  @for (eq of detalle.equiposDia; track eq.asignacionId) {
                    <div class="asignacion-card">
                      <div class="asignacion-meta">
                        <div class="asignacion-title">{{ eq.modelo || '—' }} ({{ eq.equipoSerie || '—' }})</div>
                        <div class="muted small">{{ formatFechaLarga(eq.fecha) }}</div>
                      </div>
                      <div class="asignacion-body">
                        <div class="muted small">Tipo: {{ eq.tipoEquipo || '—' }}</div>
                        <div class="muted small">Estado: {{ eq.estado || '—' }}</div>
                        @if (eq.notas) {
                          <div class="asignacion-notas">{{ eq.notas }}</div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="muted">Sin equipos asignados.</p>
                <button mat-stroked-button color="primary" type="button" (click)="abrirModalAsignar()">
                  Asignar ahora
                </button>
              }
            </div>
          </div>
        </details>
      </section>
      }

      @if (detalle?.equiposDia?.length) {
      <section class="card section">
        <details class="collapsible" open>
          <summary class="collapsible__summary">
            <div>
              <p class="eyebrow">Devoluciones</p>
              <h3>Estado de equipos</h3>
            </div>
            <span class="collapsible__caret">▾</span>
          </summary>
          <div class="devoluciones-grid">
            @for (eq of detalle.equiposDia; track eq.asignacionId) {
              <div class="devolucion-card">
                <div class="devolucion-header">
                  <div>
                    <div class="fw-semibold">{{ eq.modelo || '—' }}</div>
                    <div class="muted small">Serie: {{ eq.equipoSerie || '—' }}</div>
                  </div>
                  <span class="pill pill-muted">{{ eq.estadoDevolucion || 'Sin devolución' }}</span>
                </div>
                <div class="muted small">Fecha devolución: {{ eq.fechaDevolucion || '—' }}</div>
                @if (eq.notasDevolucion) {
                  <div class="devolucion-notas">{{ eq.notasDevolucion }}</div>
                }
              </div>
            }
          </div>
        </details>
      </section>
      }

    } @else {
      <p class="estado-centro">{{ error }}</p>
    }
  }
</div>

<app-modal-base
  [open]="modalAsignarAbierto"
  title="Asignaciones (vista previa)"
  [useDefaultFooter]="false"
  size="xl"
  (closed)="cerrarModalAsignar()">

  <div class="modal-section">
    <h4>Requerimientos por día (personal)</h4>
    @if (detalle?.requerimientosPersonalDia?.length) {
      <div class="req-grid">
        @for (req of detalle.requerimientosPersonalDia; track req.diaId + '-' + req.rol) {
          <div class="req-card">
            <div class="fw-semibold">{{ req.rol || '—' }}</div>
            <div class="muted small">{{ formatFechaDisplay(req.fecha) }}</div>
            <div class="muted small">Cantidad: {{ req.cantidad }}</div>
          </div>
        }
      </div>
    } @else {
      <p class="muted">Sin requerimientos de personal.</p>
    }
  </div>

  <div class="modal-section">
    <h4>Requerimientos por día (equipos)</h4>
    @if (detalle?.requerimientosEquipoDia?.length) {
      <div class="req-grid">
        @for (req of detalle.requerimientosEquipoDia; track req.diaId + '-' + req.tipoEquipoId) {
          <div class="req-card">
            <div class="fw-semibold">{{ req.tipoEquipoNombre || '—' }}</div>
            <div class="muted small">{{ formatFechaDisplay(req.fecha) }}</div>
            <div class="muted small">Cantidad: {{ req.cantidad }}</div>
          </div>
        }
      </div>
    } @else {
      <p class="muted">Sin requerimientos de equipos.</p>
    }
  </div>

  <div class="modal-footer-actions">
    <button mat-button type="button" (click)="cerrarModalAsignar()">Cerrar</button>
    <button mat-flat-button color="primary" type="button" disabled>
      Guardar (pendiente de API)
    </button>
  </div>
</app-modal-base>

<ng-template #loadingState>
  <mat-spinner diameter="40"></mat-spinner>
  <p>Cargando proyecto…</p>
</ng-template>
