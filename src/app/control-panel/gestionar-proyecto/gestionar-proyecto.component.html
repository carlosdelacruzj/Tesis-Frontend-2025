<div class="dashboard-content">
  <app-list-toolbar
    [title]="'Proyectos'"
    [showSearch]="true"
    [searchPlaceholder]="'Buscar: nombre, pedido, responsable...'"
    [searchValue]="searchTerm"
    (searchChange)="onSearchChange($event)"
    [showCreateButton]="false">
  </app-list-toolbar>

  @if (error) {
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  }

  @if (!loading) {
    <app-table-base
      [columns]="columns"
      [data]="proyectos"
      [showCreateButton]="false"
      [showSearch]="false"
      [externalSearchTerm]="searchTerm"
      emptyText="Sin proyectos registrados">

      <ng-template appCell="proyectoNombre" let-row>
        <div class="fw-semibold">{{ row.proyectoNombre || '-' }}</div>
        @if (row.enlace) {
          <div class="text-muted small">{{ row.enlace }}</div>
        }
      </ng-template>

      <ng-template appCell="pedidoId" let-row>
        <div class="text-center">{{ row.pedidoCodigo || row.pedidoId || '-' }}</div>
      </ng-template>

      <ng-template appCell="estadoNombre" let-row>
        <app-estado-badge
          [estado]="row.estadoNombre || getEstadoNombre(row.estadoId)"
          [mapaColores]="{
            'planificado': 'info',
            'en ejecucion': 'warning',
            'entregado': 'success-light',
            'cerrado': 'success'
          }"
        ></app-estado-badge>
      </ng-template>

      <ng-template appCell="responsableId" let-row>
        <div class="text-center">{{ row.responsableId ?? '-' }}</div>
      </ng-template>

      <ng-template appCell="fechas" let-row>
        @if (row.createdAt) {
          <div class="d-block">Creado: {{ row.createdAt | date:'yyyy-MM-dd' }}</div>
        }
        @if (row.updatedAt) {
          <div class="d-block">Actualizado: {{ row.updatedAt | date:'yyyy-MM-dd' }}</div>
        }
        @if (!row.createdAt && !row.updatedAt) {
          <div class="text-muted">-</div>
        }
      </ng-template>

      <ng-template appCell="acciones" let-row>
        <div class="d-flex justify-content-center gap-1">
          <button mat-icon-button color="primary" type="button" (click)="irADetalle(row)" matTooltip="Ver detalle">
            <mat-icon>open_in_new</mat-icon>
          </button>
          <button mat-icon-button color="primary" type="button" (click)="abrirEditar(row)" matTooltip="Editar proyecto">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
      </ng-template>
    </app-table-base>
  } @else {
    <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-3 mb-0">Cargando proyectos...</p>
    </div>
  }

</div>

<app-modal-base
  [open]="modal.open"
  [title]="modal.titulo"
  [disableClose]="modal.guardando"
  [useDefaultFooter]="false"
  [loading]="modal.guardando"
  (closed)="cerrarModal()">

  <form [formGroup]="form" class="row g-3" (ngSubmit)="guardar()">
    <div class="col-12 col-md-6">
      <label class="col-form-label" for="pedidoId">Pedido asociado</label>
      <input id="pedidoId" type="number" class="form-control" formControlName="pedidoId" min="1" required>
    </div>

    <div class="col-12 col-md-6">
      <label class="col-form-label" for="responsableId">Responsable</label>
      <input id="responsableId" type="number" class="form-control" formControlName="responsableId">
    </div>

    <div class="col-12 col-md-6">
      <label class="col-form-label" for="enlace">Enlace</label>
      <input id="enlace" type="url" class="form-control" formControlName="enlace" placeholder="https://...">
    </div>

    <div class="col-12">
      <label class="col-form-label" for="notas">Notas</label>
      <textarea id="notas" class="form-control" rows="2" formControlName="notas"></textarea>
    </div>

    <div class="text-end">
      <button type="button" class="btn btn-outline-secondary me-2" (click)="cerrarModal()" [disabled]="modal.guardando">Cancelar</button>
      <button type="submit" class="btn btn-primary" [disabled]="modal.guardando || form.invalid">
        @if (!modal.guardando) {
          <span>Guardar</span>
        }
        @if (modal.guardando) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
      </button>
    </div>
  </form>
</app-modal-base>

