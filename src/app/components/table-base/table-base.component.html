<!-- TOP BAR -->
<div
  class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3"
>
  <!-- Buscador (izquierda) -->
  @if (showSearch) {
    <div class="input-group search-group">
      <span class="input-group-text gap-1">
        <mat-icon fontIcon="search" aria-hidden="true"></mat-icon>
        <span class="visually-hidden">Buscar</span>
      </span>
      <input
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event); currentPage.set(1)"
        type="text"
        class="form-control"
        [placeholder]="searchPlaceholder"
      />
      @if (searchTerm()) {
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="clearSearch()"
        >
          Limpiar
        </button>
      }
    </div>
  }

  <!-- Botón Crear/Registrar (derecha) -->
  @if (showCreateButton) {
    <div class="create-btn-wrapper">
      <button
        class="btn btn-primary btn-sm"
        type="button"
        [disabled]="createButtonDisabled"
        (click)="createClick.emit()"
      >
        {{ createButtonLabel }}
      </button>
    </div>
  }
</div>

<!-- TABLA -->
<div class="table-responsive">
  <table class="table table-hover align-middle table-sm">
    <!-- Colgroup opcional para estabilidad extra -->
    <colgroup>
      @for (col of columns; track col.key) {
        <col
          [style.width]="col.width || null"
          [style.minWidth]="col.minWidth || '8rem'"
          [style.maxWidth]="col.maxWidth || null"
        />
      }
    </colgroup>

    <thead class="table-light">
      <tr>
        @for (col of columns; track col.key) {
          <th
            scope="col"
            class="text-center"
            [style.width]="col.width || null"
            [style.minWidth]="col.minWidth || '8rem'"
            [style.maxWidth]="col.maxWidth || null"
            [ngClass]="col.class"
            (click)="toggleSort(col)"
            [class.cursor-pointer]="col.sortable"
            [attr.aria-sort]="
              sortKey() === col.key ? sortDirection() || 'none' : 'none'
            "
          >
            <div class="d-flex justify-content-center align-items-center gap-2">
              <span>{{ col.header }}</span>
              @if (col.sortable) {
                <span class="text-muted small">
                  @if (sortKey() !== col.key || !sortDirection()) {
                    <i class="bi bi-arrow-down-up"></i>
                  }
                  @if (sortKey() === col.key && sortDirection() === "asc") {
                    <i class="bi bi-arrow-down"></i>
                  }
                  @if (sortKey() === col.key && sortDirection() === "desc") {
                    <i class="bi bi-arrow-up"></i>
                  }
                </span>
              }
            </div>
          </th>
        }
      </tr>
    </thead>

    <tbody>
      @for (row of paged(); track $index) {
        <tr (click)="onRowClick(row)" class="table-row-clickable">
          @for (col of columns; track col.key) {
            <td
              [ngClass]="col.class"
              [style.width]="col.width || null"
              [style.minWidth]="col.minWidth || '8rem'"
              [style.maxWidth]="col.maxWidth || null"
            >
              @if (hasTemplateFor(col.key)) {
                <ng-container
                  [ngTemplateOutlet]="getTemplate(col.key)"
                  [ngTemplateOutletContext]="{
                    $implicit: row,
                    row: row,
                    key: col.key,
                  }"
                >
                </ng-container>
              } @else {
                <span [title]="getValue(row, col)">{{
                  getValue(row, col)
                }}</span>
              }
            </td>
          }
        </tr>
      }

      @if (paged().length === 0) {
        <tr>
          <td
            [attr.colspan]="columns.length"
            class="text-center text-muted py-4"
          >
            {{ emptyText }}
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

<!-- FOOTER centrado: info + filas por página + paginación -->
<div class="table-footer d-flex flex-column gap-2 mt-2">
  <!-- Fila principal -->
  <div class="d-flex flex-column flex-md-row align-items-center w-100 gap-2">
    <!-- Izquierda: Mostrando -->
    @if (showFooterInfo) {
      <div
        class="flex-grow-1 order-1 order-md-1 w-100 w-md-auto text-center text-md-start text-muted small"
      >
        Mostrando
        <strong>{{ pageStart | number }}</strong> –
        <strong>{{ pageEnd | number }}</strong>
        de <strong>{{ totalItems() | number }}</strong>
      </div>
    }

    <!-- Centro: Paginación (números) -->
    @if (showPagination) {
      <nav class="order-2 mx-auto" aria-label="Paginación">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage() === 1">
            <button
              class="page-link"
              (click)="changePage(1)"
              aria-label="Primera"
            >
              &laquo;
            </button>
          </li>
          <li class="page-item" [class.disabled]="currentPage() === 1">
            <button
              class="page-link"
              (click)="changePage(currentPage() - 1)"
              aria-label="Anterior"
            >
              &lsaquo;
            </button>
          </li>

          @for (
            p of [].constructor(totalPages());
            track $index;
            let i = $index
          ) {
            <li class="page-item" [class.active]="i + 1 === currentPage()">
              <button class="page-link" (click)="changePage(i + 1)">
                {{ i + 1 }}
              </button>
            </li>
          }

          <li
            class="page-item"
            [class.disabled]="currentPage() === totalPages()"
          >
            <button
              class="page-link"
              (click)="changePage(currentPage() + 1)"
              aria-label="Siguiente"
            >
              &rsaquo;
            </button>
          </li>
          <li
            class="page-item"
            [class.disabled]="currentPage() === totalPages()"
          >
            <button
              class="page-link"
              (click)="changePage(totalPages())"
              aria-label="Última"
            >
              &raquo;
            </button>
          </li>
        </ul>
      </nav>
    }

    <!-- Derecha: Filas por página -->
    @if (showPageSizeSelector) {
      <div
        class="flex-grow-1 order-3 w-100 w-md-auto d-flex justify-content-md-end justify-content-center"
      >
        <div class="d-flex align-items-center gap-2">
          <label class="form-label m-0 small" for="pageSizeSelect"
            >Filas por página</label
          >
          <select
            id="pageSizeSelect"
            class="form-select form-select-sm"
            style="width: auto"
            [ngModel]="currentPageSize()"
            (ngModelChange)="changePageSize($event)"
          >
            @for (s of pageSizeOptions; track s) {
              <option [ngValue]="s">{{ s }}</option>
            }
          </select>
        </div>
      </div>
    }
  </div>
</div>
